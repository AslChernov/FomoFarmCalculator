<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=700, initial-scale=1.0, maximum-scale=1.0">
    <title>FomoFarm Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png"> <style>
        /* --- General Styles --- */
        * { box-sizing: border-box; }
        body {
            font-family: 'Manrope', sans-serif; margin: 20px; background-color: #000000;
            color: #ffffff; display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; padding-bottom: 50px;
        }
        .container {
            max-width: 700px; width: 100%; margin: auto;
            background: linear-gradient(to top, #000000, #05001d); padding: 20px;
            border: 1px solid #4ade80; border-radius: 8px; box-shadow: 0 2px 10px rgba(7, 14, 10, 0.5);
        }

        /* --- Header Styles --- */
        .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h1 { font-size: 30px; font-weight: 900; margin: 0; letter-spacing: -1px; display: flex; align-items: center; justify-content: center; gap: 10px; flex-grow: 1; justify-content: flex-start; }
        h1 svg { /* Placeholder */ }
        h1 span#appTitle { background-image: linear-gradient(to right, #0ea5e9, #7dd3fc ); background-clip: text; -webkit-background-clip: text; color: transparent; }
        h2 { margin-block-start: 0em; margin-block-end: 0em; font-size: 30px; text-align: center; text-transform: uppercase; font-weight: 800; letter-spacing: -0.5px; color: #4ade80; margin-top: 0px; margin-bottom: 15px; border-bottom: 1px solid #374151; padding-bottom: 8px; }
        h3 { font-size: 30px; margin-top: 25px; margin-block-start: 0em; margin-block-end: 0em; text-align: center; text-transform: uppercase; font-weight: 700; letter-spacing: -0.5px; color: #e5e7eb; margin-bottom: 15px; }
        h4 { font-size: 16px; color: #dfdfdf; text-transform: uppercase; font-weight: 600; margin-top: 15px; margin-bottom: 8px; border-bottom: 1px dashed #374151; padding-bottom: 4px; }

        /* --- Input Group Styles (Grid Layout) --- */
        .input-group { display: grid; grid-template-columns: 1fr 1.5fr 2fr; gap: 10px; margin-bottom: 20px; }
        .input-group > div { padding: 10px; border: 1px solid #1f2937; border-radius: 8px; background-color: #111827; box-shadow: rgba(7, 14, 10, 0.5) 4px 4px 4px 0px inset; }
        .input-group > div.periodic-input {
        
        }
     
        .input-select-pair {
            display: flex;
            gap: 10px; /* Space between input and select */
            margin-top: 5px; /* Space below the label */
            align-items: center;
        }
        .input-select-pair input[type="number"] {
            flex-grow: 2; /* Input takes less space */
            min-width: 0; /* Allow shrinking */
        }
        .input-select-pair select {
            flex-grow: 3; /* Select takes more space */
            min-width: 0; /* Allow shrinking */
        }
       


        /* --- Label Styles --- */
        label { display: block; font-size: 14px; font-weight: 500; letter-spacing: inherit; color: #cbd5e1; margin-bottom: 5px; line-height: 1.3; }
        .input-group > div > label { height: auto; min-height: 0; }

        /* Styles for labels containing icons */
        #label-user-staked-sol,
        #label-user-staked-usdc,
        #label-user-profit-percent-sol,
        #label-user-profit-percent-usdc,
        #label-modal-stake-sol,
        #label-modal-profit-sol,
        #label-modal-stake-usdc,
        #label-modal-profit-usdc,
        #label-periodic-sol,
        #label-periodic-usdc { 
            display: inline-flex;
            align-items: center;
            gap: 0;
        }

        /* Style for icons within labels and results */
        label img, .result-item img, .stakes-summary img {
            width: 16px;
            height: 16px;
            vertical-align: middle;
        }
         label img, .result-item .value img {
             margin-left: 5px;
         }
         .referrals td.stakes-summary img {
             margin-left: 4px;
         }


        /* --- Input & Select Styles --- */
        input[type="number"], select { width: 100%; padding: 8px 10px; margin-top: 0; border: 1px solid #374151; border-radius: 6px; font-size: 14px; font-family: 'Manrope', sans-serif; color: #ffffff; background-color: #000000; transition: border-color 0.3s ease; }
        input[type="number"]:focus, select:focus { outline: none; border-color: #4ade80; }
        select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%239ca3af' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='m19.5 8.25-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E%0A"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; padding-right: 30px; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* --- Checkbox Styles --- */
        .checkbox-container { display: flex; justify-content: center; gap: 40px; margin-top: 0; margin-bottom: 25px; padding: 10px 0; flex-wrap: wrap; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; justify-content: center; }
        .checkbox-item input[type="checkbox"] { width: 18px; height: 18px; margin: 0; cursor: pointer; accent-color: #4ade80; border: 1px solid #374151; border-radius: 3px; vertical-align: middle; flex-shrink: 0; }
        .checkbox-item input[type="checkbox"]:focus { outline: 1px solid #4ade80; outline-offset: 1px; }
        .checkbox-item label { font-size: 18px; font-weight: 700; color: #cbd5e1; cursor: pointer; margin-bottom: 0; line-height: 1; min-height: auto; display: inline; align-items: initial; padding-bottom: 0; }

        /* --- General Button Styles --- */
        button { width: auto; padding: 10px 20px; border: none; border-radius: 6px; font-size: 15px; text-transform: uppercase; font-family: 'Manrope', sans-serif; background-color: #7c3aed; letter-spacing: inherit; color: #fff; cursor: pointer; font-weight: 700; transition: background-color 0.3s ease, transform 0.1s ease, opacity 0.3s ease; }
        button:hover { background-color: #6d28d9; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #585063; cursor: not-allowed; opacity: 0.6; }
        button:disabled:hover { background-color: #585063; }

        /* --- Specific Button Styles --- */
        #languageToggleButton { padding: 6px 12px; font-size: 12px; background-color: #374151; text-transform: none; font-weight: 500; margin-top: 0; order: 2; }
        #languageToggleButton:hover { background-color: #4b5563; }
        #languageToggleButton:disabled { background-color: #374151; cursor: pointer; opacity: 1; }
        #languageToggleButton:disabled:hover { background-color: #4b5563;}

        /* --- Referrals Section Styles --- */
        .referrals { margin-top: 15px; text-align: center; }
        .referrals table { width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 15px; letter-spacing: inherit; table-layout: fixed; }
        .referrals th, .referrals td { padding: 8px 10px; text-align: center; font-size: 15px; font-weight: 500; background-color: #111827; border: 1px solid #1f2937; letter-spacing: inherit; word-wrap: break-word; vertical-align: middle; }
         .referrals th { font-weight: 900; color: #9ca3af; }
         .referrals th:nth-child(1) { width: 10%; } /* № */
         .referrals th:nth-child(2) { width: 55%; } /* Stakes Summary */
         .referrals th:nth-child(3) { width: 35%; } /* Actions */
         .referrals td.stakes-summary { font-size: 14px; color: #d1d5db; text-align: center; font-weight: 500; white-space: pre-wrap; }
         .referrals td.stakes-summary span { display: inline-flex; align-items: center; margin: 0 5px; white-space: nowrap; }
         .referrals td.stakes-summary span img { margin-right: 4px; margin-left: 0; }
         .referrals td.actions-cell { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 8px 5px; }
         .referrals td .action-button { margin: 0; padding: 6px 8px; font-size: 12px; border-radius: 4px; font-weight: 500; text-transform: none; min-width: 65px; text-align: center; }
         .referrals td .edit-button { background-color: #f59e0b; }
         .referrals td .edit-button:hover { background-color: #d97706; }
         .referrals td .remove-button { background-color: #ef4444; }
         .referrals td .remove-button:hover { background-color: #dc2626; }
         .collapsible-header { cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; user-select: none; margin-bottom: 5px; }
         .toggle-icon { transition: transform 0.3s ease; font-size: 0.8em; color: #9ca3af; }
         .collapsible-content {}
         .referrals.collapsed .collapsible-content { display: none; }
         .referrals.collapsed .toggle-icon { transform: rotate(-90deg); }
         #addReferralButton { background-color: #3b82f6; margin-top: 10px; }
         #addReferralButton:hover { background-color: #2563eb; }

        /* --- Results Section Styles --- */
        .results { margin-top: 25px; padding: 20px; background-color: #111827; border: 1px solid #1f2937; box-shadow: rgba(7, 14, 10, 0.5) 4px 4px 4px 0px inset; border-radius: 8px; }
        .results-grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin-top: 15px; }
        .result-group h4 { margin-top: 0; }
        .result-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #283141; font-size: 14px; }
        .result-item:last-child { border-bottom: none; }
        .result-item .label { color: #9ca3af; }
        .result-item .value { color: #ffffff; font-weight: 900; text-align: right; display: inline-flex; align-items: center; }
        .result-item .value.profit-sol, .result-item .value.profit-usdc, .result-item .value.profit-percent { color: #4ade80; font-weight: 900; }
        .result-item .value.roi, .result-item .value.doubling { color: #fbbf24; font-weight: 900; }
        .result-item .value.balance-usd { color: #60a5fa; font-weight: 900; }

        /* Calculate Button Style */
        #calculateButton { background-color: #22c55e; margin-top: 25px; margin-right: 0; display: block; width: auto; max-width: 200px; margin-left: auto; margin-right: auto; }
        #calculateButton:hover { background-color: #16a34a; }

        /* --- Footer Styles --- */
        .textContent { text-align: center; margin-top: 20px; font-size: 15px; color: #6b7280; }
        .textContent p { display: block; margin-block-start: 0em; margin-block-end: 0em; margin-inline-start: 0px; margin-inline-end: 0px; unicode-bidi: isolate; }
        .textContent i { color: #6b7280; margin: 0 2px; }
        .textContent a { color: #3b82f6; text-decoration: none; }
        .textContent a:hover { text-decoration: underline; }

        /* --- Modal Styles (Edit Referral) --- */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background: linear-gradient(to bottom, #111827, #05001d); margin: auto; padding: 25px; border: 1px solid #4ade80; border-radius: 8px; width: 90%; max-width: 550px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .modal-header { padding-bottom: 15px; border-bottom: 1px solid #374151; margin-bottom: 20px; }
        .modal-header h4 { margin: 0; font-size: 20px; font-weight: 700; color: #e5e7eb; }
        .modal-body { max-height: 60vh; overflow-y: auto; padding-right: 10px; }
        .modal-body .input-pair { margin-bottom: 15px; }
        .modal-body .input-pair label { margin-bottom: 5px; font-size: 13px; color: #9ca3af; }
        .modal-body .input-pair input { width: 100%; font-size: 14px; padding: 6px 8px; }
        .modal-footer { padding-top: 20px; border-top: 1px solid #374151; margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-footer button { padding: 8px 18px; font-size: 14px; }
        #saveReferralButton { background-color: #22c55e; }
        #saveReferralButton:hover { background-color: #16a34a; }
        #cancelReferralButton { background-color: #6b7280; }
        #cancelReferralButton:hover { background-color: #4b5563; }

        /* --- Responsive Styles --- */
        @media (max-width: 600px) {
            .input-group { grid-template-columns: 1fr; }
            .results-grid-container { grid-template-columns: 1fr; gap: 20px; }
            h1 { font-size: 26px; }
            h2, h3 { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
             <h1>
                 <svg width="60" height="60" viewBox="0 0 119.01 73.79" preserveAspectRatio="xMidYMid meet">
                     <defs> <linearGradient id="linear-gradient" x1="15" y1="75.16" x2="117" y2="14.9" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2573dc"/> <stop offset=".16" stop-color="#3794e5"/> <stop offset=".36" stop-color="#4cbaef"/> <stop offset=".46" stop-color="#55c9f3"/> <stop offset=".65" stop-color="#60def9"/> <stop offset=".84" stop-color="#68edfd"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient1" x1="23.33" y1="67.19" x2="115.05" y2="17.36" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".15" stop-color="#2a7ada"/> <stop offset=".34" stop-color="#338bdf"/> <stop offset=".56" stop-color="#42a6e8"/> <stop offset=".8" stop-color="#56ccf3"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient2" x1="5.49" y1="59.23" x2="107.52" y2=".56" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".17" stop-color="#2979da"/> <stop offset=".35" stop-color="#3085de"/> <stop offset=".54" stop-color="#3b9be4"/> <stop offset=".73" stop-color="#4bb8ed"/> <stop offset=".91" stop-color="#60def8"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient3" x1="22.29" y1="69.52" x2="115.96" y2="15.28" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".14" stop-color="#2b7cdb"/> <stop offset=".36" stop-color="#3691e1"/> <stop offset=".62" stop-color="#48b3eb"/> <stop offset=".91" stop-color="#62e2fa"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient4" x1="5.15" y1="58.96" x2="97.33" y2="7.21" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".26" stop-color="#2877d9"/> <stop offset=".43" stop-color="#2d80dc"/> <stop offset=".58" stop-color="#358fe1"/> <stop offset=".71" stop-color="#41a4e7"/> <stop offset=".84" stop-color="#50c0ef"/> <stop offset=".95" stop-color="#62e1fa"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient5" x1="24.22" y1="66.48" x2="116.12" y2="15.04" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".14" stop-color="#2a7bdb"/> <stop offset=".35" stop-color="#358fe0"/> <stop offset=".6" stop-color="#46aeea"/> <stop offset=".87" stop-color="#5edaf7"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient6" x1="1.45" y1="41.31" x2="91.67" y2="-11.99" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2573dc"/> <stop offset=".24" stop-color="#43a9ea"/> <stop offset=".4" stop-color="#55c9f3"/> <stop offset=".61" stop-color="#60def9"/> <stop offset=".82" stop-color="#68edfd"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> </defs> <polygon points="78.92 14.22 66.17 14.22 19.83 41.17 9.25 67.33 29.87 67.33 33.62 58.9 48.26 50.55 40.94 67.33 55.45 67.33 68.14 39.22 82.43 31.07 66.61 67.33 80.94 67.33 101.06 20.45 105.5 17.92 107 23.75 114.08 8.92 97.75 8 102.07 12.39 18.67 60.34 22.07 52.31 25.22 45.11 78.92 14.22" fill="url(#linear-gradient)"/> <polygon points="44.42 59.36 63.85 48.71 68.14 39.22 48.26 50.55 44.42 59.36" fill="url(#linear-gradient1)"/> <polygon points="59.04 25.55 55.7 33.14 75.53 21.83 78.92 14.22 59.04 25.55" fill="url(#linear-gradient2)"/> <polygon points="82.43 31.07 78.2 40.76 97.32 29.17 101.06 20.45 82.43 31.07" fill="url(#linear-gradient3)"/> <polygon points="25.22 45.11 22.07 52.31 41.69 41.13 44.97 33.75 25.22 45.11" fill="url(#linear-gradient4)"/> <polygon points="29.87 67.33 33.62 58.9 15.53 67.33 29.87 67.33" fill="url(#linear-gradient5)"/> <polygon points="38.44 14.22 32.5 27.83 52.55 16.36 53.5 14.22 38.44 14.22" fill="url(#linear-gradient6)"/>
                 </svg>
                 <span id="appTitle">FomoFarm Calculator</span>
             </h1>
             <button id="languageToggleButton"></button>
        </div>

        <div class="input-group">
            <div>
                <label for="userStakedSolAmount" id="label-user-staked-sol">Staked</label>
                <input type="number" id="userStakedSolAmount" value="0" step="0.001" min="0">
            </div>
            <div>
                <label for="userProfitPercentSol" id="label-user-profit-percent-sol">Profit % / day</label>
                <input type="number" id="userProfitPercentSol" value="0" step="0.01" min="0">
            </div>
             <div class="periodic-input">
                 <label for="periodicSolAmount" id="label-periodic-sol">Add. Investment SOL</label>
                 <div class="input-select-pair">
                     <input type="number" id="periodicSolAmount" value="0" step="0.01" min="0">
                     <select id="periodicSolPeriod">
                         <option value="0" id="option-sol-none">No</option>
                         <option value="7" id="option-sol-weekly">Weekly</option>
                         <option value="30" id="option-sol-monthly">Monthly</option>
                         <option value="91" id="option-sol-quarterly">Quarterly</option>
                     </select>
                 </div>
             </div>
             <div>
                 <label for="userStakedUsdcAmount" id="label-user-staked-usdc">Staked</label>
                <input type="number" id="userStakedUsdcAmount" value="0" step="0.01" min="0">
            </div>
             <div>
                <label for="userProfitPercentUsdc" id="label-user-profit-percent-usdc">Profit % / day</label>
                <input type="number" id="userProfitPercentUsdc" value="0" step="0.01" min="0">
            </div>
            <div class="periodic-input">
                 <label for="periodicUsdcAmount" id="label-periodic-usdc">Add. Investment USDC</label>
                 <div class="input-select-pair">
                     <input type="number" id="periodicUsdcAmount" value="0" step="0.01" min="0">
                     <select id="periodicUsdcPeriod">
                         <option value="0" id="option-usdc-none">No</option>
                         <option value="7" id="option-usdc-weekly">Weekly</option>
                         <option value="30" id="option-usdc-monthly">Monthly</option>
                         <option value="91" id="option-usdc-quarterly">Quarterly</option>
                     </select>
                 </div>
             </div>
             <div>
                <label for="days" id="label-days">Days</label>
                <input type="number" id="days" value="0" step="1" min="0">
            </div>
            <div>
                <label for="solToUsd" id="label-sol-usd">SOL / USD</label>
                <input type="number" id="solToUsd" value="0" step="0.01" min="0">
            </div>
             <div id="platformFeeContainer">
                 <label for="platformFee" id="label-platform-fee">FomoFarm Fee (%)</label>
                <input type="number" id="platformFee" value="10" step="0.1" min="0">
            </div>
        </div>

        <div class="checkbox-container">
             <div class="checkbox-item">
                 <input type="checkbox" id="reinvestCheckbox"> <label for="reinvestCheckbox" id="label-reinvest">Reinvestment</label>
             </div>
             <div class="checkbox-item">
                 <input type="checkbox" id="includeReferralsCheckbox"> <label for="includeReferralsCheckbox" id="label-enable-referrals">Enable Referrals</label>
             </div>
        </div>

        <div class="referrals" id="referralsContainer"> <h3 id="h3-referrals" class="collapsible-header">
                 <span id="h3-referrals-text">Referrals</span> <i class="fas fa-chevron-down toggle-icon"></i> </h3>
             <div class="collapsible-content">
                 <button id="addReferralButton">Add Referral</button>
                 <table id="referralsTable">
                     <thead>
                         <tr>
                             <th id="th-referral-num">№</th>
                             <th id="th-ref-stakes">Stakes Summary</th>
                             <th id="th-actions">Actions</th>
                         </tr>
                     </thead>
                     <tbody id="referralsList"></tbody>
                 </table>
            </div>
        </div>

        <button id="calculateButton">Calculate</button>

        <div class="results">
            <h2 id="h2-results">Results</h2>
            <div class="results-grid-container">
                <div class="result-group"> <h4 id="h4-your-profit">Your profit</h4> <div class="result-item"> <span class="label" id="label-profit-user-sol">From SOL Stake:</span> <span class="value profit-sol" id="result-profit-user-sol">0 SOL</span> </div> <div class="result-item"> <span class="label" id="label-profit-user-usdc">From USDC Stake:</span> <span class="value profit-usdc" id="result-profit-user-usdc">0 USDC</span> </div> </div>
                <div class="result-group"> <h4 id="h4-referral-profit">Profit from referrals</h4> <div class="result-item"> <span class="label" id="label-profit-ref-sol">From SOL Stakes:</span> <span class="value profit-sol" id="result-profit-ref-sol">0 SOL</span> </div> <div class="result-item"> <span class="label" id="label-profit-ref-usdc">From USDC Stakes:</span> <span class="value profit-usdc" id="result-profit-ref-usdc">0 USDC</span> </div> </div>
                <div class="result-group"> <h4 id="h4-total-profit">Total profit</h4> <div class="result-item"> <span class="label" id="label-profit-total-sol">Total SOL:</span> <span class="value profit-sol" id="result-profit-total-sol">0 SOL</span> </div> <div class="result-item"> <span class="label" id="label-profit-total-usdc">Total USDC:</span> <span class="value profit-usdc" id="result-profit-total-usdc">0 USDC</span> </div> <div class="result-item"> <span class="label" id="label-profit-percent-sol">Profit SOL (% of initial SOL):</span> <span class="value profit-percent" id="result-profit-percent-sol">0 %</span> </div> <div class="result-item"> <span class="label" id="label-profit-percent-usdc">Profit USDC (% of initial USDC):</span> <span class="value profit-percent" id="result-profit-percent-usdc">0 %</span> </div> </div>
                <div class="result-group"> <h4 id="h4-doubling-time">Doubling Time (100% Profit)</h4> <div class="result-item"> <span class="label" id="label-double-sol-noreinvest">SOL Stake (No Reinvest):</span> <span class="value doubling" id="result-double-sol-noreinvest">N/A</span> </div> <div class="result-item"> <span class="label" id="label-double-sol-reinvest">SOL Stake (With Reinvest):</span> <span class="value doubling" id="result-double-sol-reinvest">N/A</span> </div> <div class="result-item"> <span class="label" id="label-double-usdc-noreinvest">USDC Stake (No Reinvest):</span> <span class="value doubling" id="result-double-usdc-noreinvest">N/A</span> </div> <div class="result-item"> <span class="label" id="label-double-usdc-reinvest">USDC Stake (With Reinvest):</span> <span class="value doubling" id="result-double-usdc-reinvest">N/A</span> </div> </div>
                <div class="result-group"> <h4 id="h4-final-balance">Final Balance</h4> <div class="result-item"> <span class="label" id="label-final-balance-sol">Balance SOL:</span> <span class="value" id="result-final-balance-sol">0 SOL</span> </div> <div class="result-item"> <span class="label" id="label-final-balance-usdc">Balance USDC:</span> <span class="value" id="result-final-balance-usdc">0 USDC</span> </div> <div class="result-item"> <span class="label" id="label-final-balance-usd">Total Balance (USD):</span> <span class="value balance-usd" id="result-final-balance-usd-total">0 $</span> </div> </div>
                <div class="result-group"> <h4 id="h4-total-profit-usd">Total Profit (USD)</h4> <div class="result-item"> <span class="label" id="label-profit-total-usd">Total Profit (USD):</span> <span class="value balance-usd" id="result-profit-total-usd">0 $</span> </div> </div>
            </div>
        </div>

        <div class="textContent">
             <p id="p-footer">Made by <i class="fab fa-telegram-plane"></i> AslChernov</p>
        </div>
    </div>

    <div id="editReferralModal" class="modal-overlay">
         <div class="modal-content">
             <div class="modal-header"> <h4 id="modalTitle">Edit Referral Data</h4> </div>
             <div class="modal-body">
                 <input type="hidden" id="editingReferralId">
                 <div class="input-pair"> <label for="modal-stake-sol" id="label-modal-stake-sol">Staked</label> <input type="number" id="modal-stake-sol" step="0.001" min="0"> </div>
                 <div class="input-pair"> <label for="modal-profit-sol" id="label-modal-profit-sol">Profit % / day</label> <input type="number" id="modal-profit-sol" step="0.01" min="0"> </div>
                 <div class="input-pair"> <label for="modal-stake-usdc" id="label-modal-stake-usdc">Staked</label> <input type="number" id="modal-stake-usdc" step="0.01" min="0"> </div>
                 <div class="input-pair"> <label for="modal-profit-usdc" id="label-modal-profit-usdc">Profit % / day</label> <input type="number" id="modal-profit-usdc" step="0.01" min="0"> </div>
             </div>
             <div class="modal-footer"> <button id="cancelReferralButton">Cancel</button> <button id="saveReferralButton">Save</button> </div>
         </div>
    </div>

    <script>
        // --- Global Variables & Constants ---
        let referralsData = [];
        let nextReferralId = 1;
        let currentLanguage = 'en';
        const REINVEST_THRESHOLD_SOL = 0.1;
        const REINVEST_THRESHOLD_USDC = 20;

        // --- Translations Object ---
        const translations = {
            'en': {
                labelUserStakedSol: 'Staked', labelUserProfitPercentSol: 'Profit % / day', labelUserStakedUsdc: 'Staked', labelUserProfitPercentUsdc: 'Profit % / day',
                labelPlatformFee: 'FomoFarm Fee %', labelSolUsd: 'SOL / USD', labelDays: 'Days',
                labelPeriodicSol: 'Additon investment', labelPeriodicUsdc: 'Additon investment',
                optionNo: 'No', optionWeekly: 'Weekly', optionMonthly: 'Monthly', optionQuarterly: 'Quarterly',
                labelReinvest: 'Reinvestment', labelEnableReferrals: 'Enable Referrals', calculate: 'Calculate',
                pFooter: 'Made by', langButtonText: 'Language EN', h3Referrals: 'Referrals', addReferral: 'Add Referral',
                thReferralNum: '№', thRefStakes: 'Stakes Summary', thActions: 'Actions', editButtonShort: 'Edit',
                removeButtonShort: 'Remove', noReferrals: 'No referrals added yet.', refSummaryNone: '-',
                modalTitlePrefix: 'Edit Data for Referral #',
                labelModalStakeSol: 'Staked', labelModalProfitSol: 'Profit % / day', labelModalStakeUsdc: 'Staked', labelModalProfitUsdc: 'Profit % / day',
                saveButton: 'Save', cancelButton: 'Cancel', h2Results: 'Results', h4YourProfit: 'Your profit',
                labelProfitUserSol: 'From SOL Stake:', labelProfitUserUsdc: 'From USDC Stake:',
                h4ReferralProfit: 'Profit from referrals', labelProfitRefSol: 'From SOL Stakes:', labelProfitRefUsdc: 'From USDC Stakes:',
                h4TotalProfit: 'Total profit', labelProfitTotalSol: 'Total SOL:', labelProfitTotalUsdc: 'Total USDC:',
                labelProfitPercentSol: 'Profit SOL in %:', labelProfitPercentUsdc: 'Profit USDC in %:',
                h4DoublingTime: 'Doubling Time | 100% Profit',
                labelDoubleSolNoreinvest: 'SOL Stake | No Reinvest:', labelDoubleUsdcNoreinvest: 'USDC Stake | No Reinvest:',
                labelDoubleSolReinvest: 'SOL Stake | With Reinvest:', labelDoubleUsdcReinvest: 'USDC Stake | With Reinvest:',
                h4FinalBalance: 'Final Balance',
                labelFinalBalanceSol: 'Balance SOL:', labelFinalBalanceUsdc: 'Balance USDC:', labelFinalBalanceUsd: 'Total Balance USD:',
                h4TotalProfitUsd: 'Total Profit USD', labelProfitTotalUsd: 'Total Profit:',
                roiNever: 'Never', roiOverDays: 'Over {days} days', daysSuffix: ' days',
                invalidInputError: 'Please enter valid values for Stakes, Rates, Days, and SOL/USD Rate.',
                solUsdRateError: 'SOL/USD rate must be greater than 0 to calculate profit from USDC stakes.'
            },
            'ru': {
                labelUserStakedSol: 'Вложено', labelUserProfitPercentSol: 'Профит % / день', labelUserStakedUsdc: 'Вложено', labelUserProfitPercentUsdc: 'Профит % / день',
                labelPlatformFee: 'Комиссия FomoFarm %', labelSolUsd: 'SOL / USD', labelDays: 'Дней',
                labelPeriodicSol: 'Довложения', labelPeriodicUsdc: 'Довложения',
                optionNo: 'Нет', optionWeekly: 'Раз в неделю', optionMonthly: 'Раз в месяц', optionQuarterly: 'Раз в 3 месяца',
                labelReinvest: 'Реинвест', labelEnableReferrals: 'Включить рефералов', calculate: 'Рассчитать',
                pFooter: 'Сделано', langButtonText: 'Язык RU', h3Referrals: 'Рефералы', addReferral: 'Добавить реферала',
                thReferralNum: '№', thRefStakes: 'Сводка стейков', thActions: 'Действия', editButtonShort: 'Изм.',
                removeButtonShort: 'Удал.', noReferrals: 'Рефералы еще не добавлены.', refSummaryNone: '-',
                modalTitlePrefix: 'Изменить данные для Реферала №',
                labelModalStakeSol: 'Вложено', labelModalProfitSol: 'Профит % / день', labelModalStakeUsdc: 'Вложено', labelModalProfitUsdc: 'Профит % / день',
                saveButton: 'Сохранить', cancelButton: 'Отмена', h2Results: 'Результаты', h4YourProfit: 'Ваш профит',
                labelProfitUserSol: 'От стейка SOL:', labelProfitUserUsdc: 'От стейка USDC:',
                h4ReferralProfit: 'Профит от рефералов', labelProfitRefSol: 'От стейков SOL:', labelProfitRefUsdc: 'От стейков USDC:',
                h4TotalProfit: 'Общий профит', labelProfitTotalSol: 'Всего SOL:', labelProfitTotalUsdc: 'Всего USDC:',
                labelProfitPercentSol: 'Профит SOL в %:', labelProfitPercentUsdc: 'Профит USDC в %:',
                h4DoublingTime: 'Время удвоения | 100% Профит',
                labelDoubleSolNoreinvest: 'Стейк SOL | Без реинвеста:', labelDoubleUsdcNoreinvest: 'Стейк USDC | Без реинвеста:',
                labelDoubleSolReinvest: 'Стейк SOL | С реинвестом:', labelDoubleUsdcReinvest: 'Стейк USDC | С реинвестом:',
                h4FinalBalance: 'Итоговый баланс',
                labelFinalBalanceSol: 'Баланс SOL:', labelFinalBalanceUsdc: 'Баланс USDC:', labelFinalBalanceUsd: 'Общий Баланс USD:',
                h4TotalProfitUsd: 'Общий Профит USD', labelProfitTotalUsd: 'Общий Профит:',
                roiNever: 'Никогда', roiOverDays: 'Более {days} дн.', daysSuffix: ' дн.',
                invalidInputError: 'Пожалуйста, введите корректные значения для Стейков, Процентов, Дней и Курса SOL/USD.',
                solUsdRateError: 'Курс SOL/USD должен быть больше 0 для расчета дохода со стейков в USDC.'
            }
        };

        // --- Data Persistence Functions (localStorage) ---
        function saveData() { /* ... */
             try {
                const data = {
                    userStakedSolAmount: document.getElementById('userStakedSolAmount').value, userProfitPercentSol: document.getElementById('userProfitPercentSol').value,
                    userStakedUsdcAmount: document.getElementById('userStakedUsdcAmount').value, userProfitPercentUsdc: document.getElementById('userProfitPercentUsdc').value,
                    platformFee: document.getElementById('platformFee').value, solToUsd: document.getElementById('solToUsd').value, days: document.getElementById('days').value,
                    periodicSolAmount: document.getElementById('periodicSolAmount').value, periodicSolPeriod: document.getElementById('periodicSolPeriod').value,
                    periodicUsdcAmount: document.getElementById('periodicUsdcAmount').value, periodicUsdcPeriod: document.getElementById('periodicUsdcPeriod').value,
                    reinvest: document.getElementById('reinvestCheckbox').checked.toString(), includeReferrals: document.getElementById('includeReferralsCheckbox').checked.toString(),
                    referralsData: JSON.stringify(referralsData || []), nextReferralId: nextReferralId,
                    referralsCollapsed: document.getElementById('referralsContainer')?.classList.contains('collapsed').toString() || 'false'
                };
                for (const [key, value] of Object.entries(data)) { localStorage.setItem(`fomoFarmCalc_${key}`, value); }
            } catch (error) { console.error("Error saving data to localStorage:", error); }
        }
        function loadData() { /* ... */
             try {
                document.getElementById('userStakedSolAmount').value = localStorage.getItem('fomoFarmCalc_userStakedSolAmount') || '0';
                document.getElementById('userProfitPercentSol').value = localStorage.getItem('fomoFarmCalc_userProfitPercentSol') || '0';
                document.getElementById('userStakedUsdcAmount').value = localStorage.getItem('fomoFarmCalc_userStakedUsdcAmount') || '0';
                document.getElementById('userProfitPercentUsdc').value = localStorage.getItem('fomoFarmCalc_userProfitPercentUsdc') || '0';
                document.getElementById('platformFee').value = localStorage.getItem('fomoFarmCalc_platformFee') || '10';
                document.getElementById('solToUsd').value = localStorage.getItem('fomoFarmCalc_solToUsd') || '0';
                document.getElementById('days').value = localStorage.getItem('fomoFarmCalc_days') || '0';
                document.getElementById('reinvestCheckbox').checked = (localStorage.getItem('fomoFarmCalc_reinvest') || 'true') === 'true';
                document.getElementById('includeReferralsCheckbox').checked = (localStorage.getItem('fomoFarmCalc_includeReferrals') || 'true') === 'true';
                document.getElementById('periodicSolAmount').value = localStorage.getItem('fomoFarmCalc_periodicSolAmount') || '0';
                document.getElementById('periodicSolPeriod').value = localStorage.getItem('fomoFarmCalc_periodicSolPeriod') || '0';
                document.getElementById('periodicUsdcAmount').value = localStorage.getItem('fomoFarmCalc_periodicUsdcAmount') || '0';
                document.getElementById('periodicUsdcPeriod').value = localStorage.getItem('fomoFarmCalc_periodicUsdcPeriod') || '0';
                const savedReferrals = localStorage.getItem('fomoFarmCalc_referralsData');
                referralsData = savedReferrals ? JSON.parse(savedReferrals) : [];
                if (!Array.isArray(referralsData)) { referralsData = []; }
                referralsData = referralsData.filter(ref => typeof ref === 'object' && ref !== null && ref.hasOwnProperty('id'));
                referralsData.forEach(ref => { ref.stakedSol = ref.stakedSol || 0; ref.profitPercentSol = ref.profitPercentSol || 0; ref.stakedUsdc = ref.stakedUsdc || 0; ref.profitPercentUsdc = ref.profitPercentUsdc || 0; });
                const savedNextId = parseInt(localStorage.getItem('fomoFarmCalc_nextReferralId'));
                if (referralsData.length > 0) { const maxId = referralsData.reduce((max, ref) => Math.max(max, ref.id || 0), 0); nextReferralId = Math.max(maxId + 1, savedNextId || 1); }
                else { nextReferralId = savedNextId || 1; }
                const referralsContainer = document.getElementById('referralsContainer');
                const savedCollapseState = localStorage.getItem('fomoFarmCalc_referralsCollapsed');
                if (referralsContainer && savedCollapseState === 'true') { referralsContainer.classList.add('collapsed'); }
            } catch (error) { console.error("Error loading data from localStorage:", error); /* Reset fields */ referralsData = []; nextReferralId = 1; }
         }

        // --- UI Update Functions ---
        function updateUI(lang) {
            currentLanguage = lang;
            const trans = translations[lang];
            document.documentElement.lang = lang === 'ru' ? 'ru' : 'en';

            const h3ReferralsTextElement = document.getElementById('h3-referrals-text');
            if (h3ReferralsTextElement && trans.h3Referrals) { h3ReferralsTextElement.textContent = trans.h3Referrals; }

            const solanaIconImg = `<img src="solana_icon.svg" alt="SOL" width="16" height="16">`;
            const usdcIconImg = `<img src="usdc_icon.svg" alt="USDC" width="16" height="16">`;

            // --- Updated idToKeyMap ---
            const idToKeyMap = {
                'label-user-staked-sol': 'labelUserStakedSol', 'label-user-profit-percent-sol': 'labelUserProfitPercentSol',
                'label-user-staked-usdc': 'labelUserStakedUsdc', 'label-user-profit-percent-usdc': 'labelUserProfitPercentUsdc',
                'label-platform-fee': 'labelPlatformFee', 'label-sol-usd': 'labelSolUsd', 'label-days': 'labelDays',
                'label-periodic-sol': 'labelPeriodicSol', 'label-periodic-usdc': 'labelPeriodicUsdc', // New labels
                'label-reinvest': 'labelReinvest', 'label-enable-referrals': 'labelEnableReferrals',
                'addReferralButton': 'addReferral', 'th-referral-num': 'thReferralNum',
                'th-ref-stakes': 'thRefStakes', 'th-actions': 'thActions', 'calculateButton': 'calculate', 'h2-results': 'h2Results',
                'h4-your-profit': 'h4YourProfit', 'label-profit-user-sol': 'labelProfitUserSol', 'label-profit-user-usdc': 'labelProfitUserUsdc',
                'h4-referral-profit': 'h4ReferralProfit', 'label-profit-ref-sol': 'labelProfitRefSol', 'label-profit-ref-usdc': 'labelProfitRefUsdc',
                'h4-total-profit': 'h4TotalProfit', 'label-profit-total-sol': 'labelProfitTotalSol', 'label-profit-total-usdc': 'labelProfitTotalUsdc',
                'label-profit-percent-sol': 'labelProfitPercentSol', 'label-profit-percent-usdc': 'labelProfitPercentUsdc',
                'h4-doubling-time': 'h4DoublingTime',
                'label-double-sol-noreinvest': 'labelDoubleSolNoreinvest', 'label-double-usdc-noreinvest': 'labelDoubleUsdcNoreinvest',
                'label-double-sol-reinvest': 'labelDoubleSolReinvest', 'label-double-usdc-reinvest': 'labelDoubleUsdcReinvest',
                'h4-final-balance': 'h4FinalBalance', 'label-final-balance-sol': 'labelFinalBalanceSol',
                'label-final-balance-usdc': 'labelFinalBalanceUsdc', 'label-final-balance-usd': 'labelFinalBalanceUsd',
                'h4-total-profit-usd': 'h4TotalProfitUsd', 'label-profit-total-usd': 'labelProfitTotalUsd',
                'label-modal-stake-sol': 'labelModalStakeSol', 'label-modal-profit-sol': 'labelModalProfitSol',
                'label-modal-stake-usdc': 'labelModalStakeUsdc', 'label-modal-profit-usdc': 'labelModalProfitUsdc',
                'saveReferralButton': 'saveButton', 'cancelReferralButton': 'cancelButton',
                'languageToggleButton': 'langButtonText',
                // --- NEW: Option keys ---
                'option-sol-none': 'optionNo', 'option-sol-weekly': 'optionWeekly', 'option-sol-monthly': 'optionMonthly', 'option-sol-quarterly': 'optionQuarterly',
                'option-usdc-none': 'optionNo', 'option-usdc-weekly': 'optionWeekly', 'option-usdc-monthly': 'optionMonthly', 'option-usdc-quarterly': 'optionQuarterly'
                // --- END NEW ---
            };

            // Loop for standard elements - sets base text
            for (const id in idToKeyMap) {
                const element = document.getElementById(id);
                const key = idToKeyMap[id];
                if (element && trans[key] !== undefined) {
                     // Handle OPTION elements separately
                     if (element.tagName === 'OPTION') {
                         element.textContent = trans[key];
                     } else if (element.tagName === 'BUTTON' || element.tagName === 'H2' || element.tagName === 'H4' || element.tagName === 'LABEL' || element.tagName === 'P' || element.tagName === 'SPAN' || element.tagName === 'TH') {
                         if (id === 'p-footer') { element.childNodes[0].nodeValue = trans[key] + ' '; }
                         else { element.textContent = trans[key]; }
                     }
                } else if (element && id === 'p-footer') {
                     if (element.childNodes.length === 0 || element.childNodes[0].nodeType !== Node.TEXT_NODE) { element.prepend(document.createTextNode(' ')); }
                     element.childNodes[0].nodeValue = (trans.pFooter || 'Made by') + ' ';
                }
            }

            // --- Append icons to specific labels ---
            const labelSolStake = document.getElementById('label-user-staked-sol');
            const labelUsdcStake = document.getElementById('label-user-staked-usdc');
            const labelSolProfit = document.getElementById('label-user-profit-percent-sol');
            const labelUsdcProfit = document.getElementById('label-user-profit-percent-usdc');
            const labelPeriodicSol = document.getElementById('label-periodic-sol'); // New
            const labelPeriodicUsdc = document.getElementById('label-periodic-usdc'); // New

            if (labelSolStake) { labelSolStake.innerHTML += solanaIconImg; }
            if (labelUsdcStake) { labelUsdcStake.innerHTML += usdcIconImg; }
            if (labelSolProfit) { labelSolProfit.innerHTML += solanaIconImg; }
            if (labelUsdcProfit) { labelUsdcProfit.innerHTML += usdcIconImg; }
            if (labelPeriodicSol) { labelPeriodicSol.innerHTML += solanaIconImg; } // New
            if (labelPeriodicUsdc) { labelPeriodicUsdc.innerHTML += usdcIconImg; } // New
            // --- End Icon Appending ---

            renderReferralsTable();
        }
        function toggleLanguage() { /* ... */
            const newLang = currentLanguage === 'en' ? 'ru' : 'en';
            localStorage.setItem('fomoFarmCalc_language', newLang);
            updateUI(newLang);
         }

        // --- Referral Management Functions ---
        function addReferral() { /* ... */
            const newId = nextReferralId++; const newReferral = { id: newId, stakedSol: 0, profitPercentSol: 0, stakedUsdc: 0, profitPercentUsdc: 0 };
            referralsData.push(newReferral); renderReferralsTable(); saveData();
        }
        function removeReferral(referralIdToRemove) { /* ... */
            referralsData = referralsData.filter(ref => ref.id !== referralIdToRemove);
            referralsData.forEach((ref, index) => { ref.id = index + 1; }); nextReferralId = referralsData.length + 1;
            renderReferralsTable(); saveData();
        }
        function renderReferralsTable() { /* ... (No changes needed here from previous step) ... */
            const referralsListBody = document.getElementById('referralsList');
            if (!referralsListBody) return;
            referralsListBody.innerHTML = '';
            const trans = translations[currentLanguage];
            const solanaIconImg = `<img src="solana_icon.svg" alt="SOL" width="16" height="16">`;
            const usdcIconImg = `<img src="usdc_icon.svg" alt="USDC" width="16" height="16">`;

            if (referralsData.length === 0) {
                 const row = document.createElement('tr');
                 row.innerHTML = `<td colspan="3" style="text-align:center; color:#6b7280;">${trans.noReferrals}</td>`;
                 referralsListBody.appendChild(row);
            } else {
                referralsData.forEach(referral => {
                     const row = document.createElement('tr');
                     const numCell = document.createElement('td'); numCell.textContent = referral.id;
                     const summaryCell = document.createElement('td'); summaryCell.className = 'stakes-summary';
                     let summaryContent = [];
                     const formatOptionsNoSuffix = { maximumFractionDigits: 5, minimumFractionDigits: 2 };
                     const usdcFormatOptionsNoSuffix = { maximumFractionDigits: 2, minimumFractionDigits: 2 };
                     if (referral.stakedSol > 0) { summaryContent.push(`<span>${solanaIconImg}${formatNumber(referral.stakedSol, 'SOL', false)}</span>`); }
                     if (referral.stakedUsdc > 0) { summaryContent.push(`<span>${usdcIconImg}${formatNumber(referral.stakedUsdc, 'USDC', false)}</span>`); }
                     summaryCell.innerHTML = summaryContent.length > 0 ? summaryContent.join(' ') : trans.refSummaryNone;
                     const actionCell = document.createElement('td'); actionCell.className = 'actions-cell';
                     const editButton = document.createElement('button'); editButton.textContent = trans.editButtonShort; editButton.className = 'action-button edit-button'; editButton.onclick = () => openEditModal(referral.id);
                     const removeButton = document.createElement('button'); removeButton.textContent = trans.removeButtonShort; removeButton.className = 'action-button remove-button'; removeButton.onclick = () => removeReferral(referral.id);
                     actionCell.appendChild(editButton); actionCell.appendChild(removeButton);
                     row.appendChild(numCell); row.appendChild(summaryCell); row.appendChild(actionCell);
                     referralsListBody.appendChild(row);
                });
            }
        }


        // --- Modal Management Functions ---
        function openEditModal(referralId) { /* ... (No changes needed here from previous step) ... */
            const modal = document.getElementById('editReferralModal');
            const modalTitle = document.getElementById('modalTitle');
            const editingIdInput = document.getElementById('editingReferralId');
            const trans = translations[currentLanguage];
            const referral = referralsData.find(ref => ref.id === referralId);
            if (!referral || !modal || !modalTitle || !editingIdInput) return;
            modalTitle.textContent = `${trans.modalTitlePrefix}${referral.id}`;
            editingIdInput.value = referral.id;
            document.getElementById('modal-stake-sol').value = referral.stakedSol || 0;
            document.getElementById('modal-profit-sol').value = referral.profitPercentSol || 0;
            document.getElementById('modal-stake-usdc').value = referral.stakedUsdc || 0;
            document.getElementById('modal-profit-usdc').value = referral.profitPercentUsdc || 0;
            const solanaIconImg = `<img src="solana_icon.svg" alt="SOL" width="16" height="16">`;
            const usdcIconImg = `<img src="usdc_icon.svg" alt="USDC" width="16" height="16">`;
            const labelModalStakeSol = document.getElementById('label-modal-stake-sol');
            const labelModalProfitSol = document.getElementById('label-modal-profit-sol');
            const labelModalStakeUsdc = document.getElementById('label-modal-stake-usdc');
            const labelModalProfitUsdc = document.getElementById('label-modal-profit-usdc');
            if(labelModalStakeSol) { labelModalStakeSol.textContent = trans.labelModalStakeSol; labelModalStakeSol.innerHTML += solanaIconImg; }
            if(labelModalProfitSol) { labelModalProfitSol.textContent = trans.labelModalProfitSol; labelModalProfitSol.innerHTML += solanaIconImg; }
            if(labelModalStakeUsdc) { labelModalStakeUsdc.textContent = trans.labelModalStakeUsdc; labelModalStakeUsdc.innerHTML += usdcIconImg; }
            if(labelModalProfitUsdc) { labelModalProfitUsdc.textContent = trans.labelModalProfitUsdc; labelModalProfitUsdc.innerHTML += usdcIconImg; }
            modal.style.display = 'flex';
         }
        function closeEditModal() { /* ... */
            const modal = document.getElementById('editReferralModal'); if (modal) { modal.style.display = 'none'; }
            const editingIdInput = document.getElementById('editingReferralId'); if(editingIdInput) { editingIdInput.value = ''; }
        }
        function saveReferralData() { /* ... */
            const editingId = parseInt(document.getElementById('editingReferralId').value); if (isNaN(editingId)) return;
            const referralIndex = referralsData.findIndex(ref => ref.id === editingId); if (referralIndex === -1) return;
            const newStakeSol = parseFloat(document.getElementById('modal-stake-sol').value) || 0; const newProfitSol = parseFloat(document.getElementById('modal-profit-sol').value) || 0;
            const newStakeUsdc = parseFloat(document.getElementById('modal-stake-usdc').value) || 0; const newProfitUsdc = parseFloat(document.getElementById('modal-profit-usdc').value) || 0;
            referralsData[referralIndex].stakedSol = newStakeSol >= 0 ? newStakeSol : 0; referralsData[referralIndex].profitPercentSol = newProfitSol >= 0 ? newProfitSol : 0;
            referralsData[referralIndex].stakedUsdc = newStakeUsdc >= 0 ? newStakeUsdc : 0; referralsData[referralIndex].profitPercentUsdc = newProfitUsdc >= 0 ? newProfitUsdc : 0;
            saveData(); renderReferralsTable(); closeEditModal();
        }

        // --- Formatting Function ---
        function formatNumber(number, currency = 'default', includeSuffix = true) {
            if (isNaN(number) || number === null) { return currency === 'USD' ? '0.00 $' : (currency === 'RUB' ? '0.00 ₽' : '0.00000'); }
            const daysSuffix = translations[currentLanguage].daysSuffix;
            const config = {
                'USD': { locale: 'en-US', options: { maximumFractionDigits: 2, minimumFractionDigits: 2 }, suffix: ' $' },
                'SOL': { locale: 'en-US', options: { maximumFractionDigits: 5, minimumFractionDigits: 2 }, suffix: ' SOL' },
                'USDC': { locale: 'en-US', options: { maximumFractionDigits: 2, minimumFractionDigits: 2 }, suffix: ' USDC' },
                'PERCENT': { locale: currentLanguage === 'ru' ? 'ru-RU' : 'en-US', options: { maximumFractionDigits: 2, minimumFractionDigits: 2 }, suffix: ' %' },
                'DAYS': { locale: currentLanguage === 'ru' ? 'ru-RU' : 'en-US', options: { maximumFractionDigits: 0, minimumFractionDigits: 0 }, suffix: daysSuffix },
                'default': { locale: 'en-US', options: { maximumFractionDigits: 5, minimumFractionDigits: 2 }, suffix: '' }
            };
            const { locale, options, suffix } = config[currency] || config.default;
            return number.toLocaleString(locale, options) + (includeSuffix ? suffix : '');
         }


        // --- Calculation Logic ---
        function calculate() {
            // Get input values
            const platformFeeRate = (parseFloat(document.getElementById('platformFee').value) || 0) / 100;
            const solToUsd = parseFloat(document.getElementById('solToUsd').value) || 0;
            const days = parseInt(document.getElementById('days').value) || 0;
            const reinvestEnabled = document.getElementById('reinvestCheckbox').checked;
            const referralsEnabled = document.getElementById('includeReferralsCheckbox').checked;
            const trans = translations[currentLanguage];
            const initialUserStakedSol = parseFloat(document.getElementById('userStakedSolAmount').value) || 0;
            const userProfitRateSol = (parseFloat(document.getElementById('userProfitPercentSol').value) || 0) / 100;
            const initialUserStakedUsdc = parseFloat(document.getElementById('userStakedUsdcAmount').value) || 0;
            const userProfitRateUsdc = (parseFloat(document.getElementById('userProfitPercentUsdc').value) || 0) / 100;
            const periodicSolAmount = parseFloat(document.getElementById('periodicSolAmount').value) || 0;
            const periodicSolPeriod = parseInt(document.getElementById('periodicSolPeriod').value) || 0;
            const periodicUsdcAmount = parseFloat(document.getElementById('periodicUsdcAmount').value) || 0;
            const periodicUsdcPeriod = parseInt(document.getElementById('periodicUsdcPeriod').value) || 0;

            // Input Validation
            if (days <= 0 || solToUsd < 0 || initialUserStakedSol < 0 || userProfitRateSol < 0 || initialUserStakedUsdc < 0 || userProfitRateUsdc < 0 || periodicSolAmount < 0 || periodicUsdcAmount < 0) {
                clearResults(trans.invalidInputError); return;
            }
            let needsSolUsdRate = (initialUserStakedUsdc > 0 || periodicUsdcAmount > 0);
            const hasUsdcReferralStake = referralsData.some(ref => (ref.stakedUsdc || 0) > 0);
            if (referralsEnabled && hasUsdcReferralStake) { needsSolUsdRate = true; }
            if (needsSolUsdRate && solToUsd <= 0) { clearResults(trans.solUsdRateError); return; }

            // Calculate Daily Referral Profit
            let dailyNetProfit_RefSol = 0; let dailyNetProfit_RefUsdc = 0;
            if (referralsEnabled) { referralsData.forEach(referral => { if (referral.stakedSol > 0 && referral.profitPercentSol > 0) { const refProfitRateSol = referral.profitPercentSol / 100; const grossProfit = referral.stakedSol * refProfitRateSol; const fee = grossProfit * platformFeeRate; dailyNetProfit_RefSol += ((grossProfit - fee) * 0.08); } if (referral.stakedUsdc > 0 && referral.profitPercentUsdc > 0) { const refProfitRateUsdc = referral.profitPercentUsdc / 100; const grossProfit = referral.stakedUsdc * refProfitRateUsdc; const fee = grossProfit * platformFeeRate; dailyNetProfit_RefUsdc += ((grossProfit - fee) * 0.08); } }); }

            // Calculate Doubling Time (No Reinvestment, based on initial)
            let doubleSolNoReinvestDays = "N/A"; let doubleUsdcNoReinvestDays = "N/A";
            const dailyNetProfit_UserSol_Initial = initialUserStakedSol * userProfitRateSol * (1 - platformFeeRate);
            const dailyNetProfit_UserUsdc_Initial = initialUserStakedUsdc * userProfitRateUsdc * (1 - platformFeeRate);
            const totalDailySolProfit_Initial = dailyNetProfit_UserSol_Initial + dailyNetProfit_RefSol;
            const totalDailyUsdcProfit_Initial = dailyNetProfit_UserUsdc_Initial + dailyNetProfit_RefUsdc;
            if (totalDailySolProfit_Initial > 0 && initialUserStakedSol > 0) { doubleSolNoReinvestDays = Math.ceil(initialUserStakedSol / totalDailySolProfit_Initial); } else if (initialUserStakedSol > 0) { doubleSolNoReinvestDays = trans.roiNever; }
            if (totalDailyUsdcProfit_Initial > 0 && initialUserStakedUsdc > 0) { doubleUsdcNoReinvestDays = Math.ceil(initialUserStakedUsdc / totalDailyUsdcProfit_Initial); } else if (initialUserStakedUsdc > 0) { doubleUsdcNoReinvestDays = trans.roiNever; }

            // Simulate Day-by-Day Profit
            let currentSolStake = initialUserStakedSol; let currentUsdcStake = initialUserStakedUsdc;
            let accumulatedSolProfit = 0; let accumulatedUsdcProfit = 0;
            let totalSolProfitAccumulated = 0; let totalUsdcProfitAccumulated = 0;
            let doubleSolReinvestDays = "N/A"; let doubleUsdcReinvestDays = "N/A";
            let solDoubled = false; let usdcDoubled = false;

            for (let day = 1; day <= days; day++) {
                // Add periodic investments BEFORE calculating daily profit
                if (periodicSolAmount > 0 && periodicSolPeriod > 0 && day % periodicSolPeriod === 0) { currentSolStake += periodicSolAmount; }
                if (periodicUsdcAmount > 0 && periodicUsdcPeriod > 0 && day % periodicUsdcPeriod === 0) { currentUsdcStake += periodicUsdcAmount; }

                const profitTodaySol_User = currentSolStake * userProfitRateSol * (1 - platformFeeRate);
                const profitTodayUsdc_User = currentUsdcStake * userProfitRateUsdc * (1 - platformFeeRate);
                const profitTodaySol_Total = profitTodaySol_User + dailyNetProfit_RefSol;
                const profitTodayUsdc_Total = profitTodayUsdc_User + dailyNetProfit_RefUsdc;
                totalSolProfitAccumulated += profitTodaySol_Total; totalUsdcProfitAccumulated += profitTodayUsdc_Total;
                accumulatedSolProfit += profitTodaySol_Total; accumulatedUsdcProfit += profitTodayUsdc_Total;
                if (reinvestEnabled) { if (accumulatedSolProfit >= REINVEST_THRESHOLD_SOL) { currentSolStake += accumulatedSolProfit; accumulatedSolProfit = 0; } if (accumulatedUsdcProfit >= REINVEST_THRESHOLD_USDC) { currentUsdcStake += accumulatedUsdcProfit; accumulatedUsdcProfit = 0; } }
                if (!solDoubled && initialUserStakedSol > 0 && currentSolStake >= initialUserStakedSol * 2) { doubleSolReinvestDays = day; solDoubled = true; }
                if (!usdcDoubled && initialUserStakedUsdc > 0 && currentUsdcStake >= initialUserStakedUsdc * 2) { doubleUsdcReinvestDays = day; usdcDoubled = true; }
            }

            // Final Calculations & Display
             if (!solDoubled) { if (totalDailySolProfit_Initial > 0 && initialUserStakedSol > 0) doubleSolReinvestDays = trans.roiOverDays.replace('{days}', days); else if (initialUserStakedSol > 0) doubleSolReinvestDays = trans.roiNever; else doubleSolReinvestDays = "N/A"; }
             if (!usdcDoubled) { if (totalDailyUsdcProfit_Initial > 0 && initialUserStakedUsdc > 0) doubleUsdcReinvestDays = trans.roiOverDays.replace('{days}', days); else if (initialUserStakedUsdc > 0) doubleUsdcReinvestDays = trans.roiNever; else doubleUsdcReinvestDays = "N/A"; }
            const finalSolBalance = currentSolStake + accumulatedSolProfit; const finalUsdcBalance = currentUsdcStake + accumulatedUsdcProfit; const finalUsdBalanceTotal = (solToUsd > 0 ? finalSolBalance * solToUsd : 0) + finalUsdcBalance; const profitPercentSol = initialUserStakedSol > 0 ? (totalSolProfitAccumulated / initialUserStakedSol) * 100 : 0; const profitPercentUsdc = initialUserStakedUsdc > 0 ? (totalUsdcProfitAccumulated / initialUserStakedUsdc) * 100 : 0; const totalReferralProfitOverPeriodSol = dailyNetProfit_RefSol * days; const totalReferralProfitOverPeriodUsdc = dailyNetProfit_RefUsdc * days; const totalProfitUsd = (solToUsd > 0 ? totalSolProfitAccumulated * solToUsd : 0) + totalUsdcProfitAccumulated;

            let userProfitSol = totalSolProfitAccumulated - totalReferralProfitOverPeriodSol; if (Math.abs(userProfitSol) < 1e-9) userProfitSol = 0;
            let userProfitUsdc = totalUsdcProfitAccumulated - totalReferralProfitOverPeriodUsdc; if (Math.abs(userProfitUsdc) < 1e-9) userProfitUsdc = 0;

            const solanaIconImg = `<img src="solana_icon.svg" alt="SOL" width="16" height="16">`;
            const usdcIconImg = `<img src="usdc_icon.svg" alt="USDC" width="16" height="16">`;

            document.getElementById('result-profit-user-sol').innerHTML = formatNumber(userProfitSol, 'SOL', false) + solanaIconImg;
            document.getElementById('result-profit-user-usdc').innerHTML = formatNumber(userProfitUsdc, 'USDC', false) + usdcIconImg;
            document.getElementById('result-profit-ref-sol').innerHTML = formatNumber(totalReferralProfitOverPeriodSol, 'SOL', false) + solanaIconImg;
            document.getElementById('result-profit-ref-usdc').innerHTML = formatNumber(totalReferralProfitOverPeriodUsdc, 'USDC', false) + usdcIconImg;
            document.getElementById('result-profit-total-sol').innerHTML = formatNumber(totalSolProfitAccumulated, 'SOL', false) + solanaIconImg;
            document.getElementById('result-profit-total-usdc').innerHTML = formatNumber(totalUsdcProfitAccumulated, 'USDC', false) + usdcIconImg;
            document.getElementById('result-profit-percent-sol').textContent = formatNumber(profitPercentSol, 'PERCENT');
            document.getElementById('result-profit-percent-usdc').textContent = formatNumber(profitPercentUsdc, 'PERCENT');
            document.getElementById('result-double-sol-noreinvest').textContent = typeof doubleSolNoReinvestDays === 'number' ? formatNumber(doubleSolNoReinvestDays, 'DAYS') : doubleSolNoReinvestDays;
            document.getElementById('result-double-usdc-noreinvest').textContent = typeof doubleUsdcNoReinvestDays === 'number' ? formatNumber(doubleUsdcNoReinvestDays, 'DAYS') : doubleUsdcNoReinvestDays;
            document.getElementById('result-double-sol-reinvest').textContent = typeof doubleSolReinvestDays === 'number' ? formatNumber(doubleSolReinvestDays, 'DAYS') : doubleSolReinvestDays;
            document.getElementById('result-double-usdc-reinvest').textContent = typeof doubleUsdcReinvestDays === 'number' ? formatNumber(doubleUsdcReinvestDays, 'DAYS') : doubleUsdcReinvestDays;
            document.getElementById('result-final-balance-sol').innerHTML = formatNumber(finalSolBalance, 'SOL', false) + solanaIconImg;
            document.getElementById('result-final-balance-usdc').innerHTML = formatNumber(finalUsdcBalance, 'USDC', false) + usdcIconImg;
            document.getElementById('result-final-balance-usd-total').textContent = formatNumber(finalUsdBalanceTotal, 'USD');
            document.getElementById('result-profit-total-usd').textContent = formatNumber(totalProfitUsd, 'USD');
        }
        function clearResults(message = "") {
             const solanaIconImg = `<img src="solana_icon.svg" alt="SOL" width="16" height="16">`;
             const usdcIconImg = `<img src="usdc_icon.svg" alt="USDC" width="16" height="16">`;
             document.getElementById('result-profit-user-sol').innerHTML = '0' + solanaIconImg;
             document.getElementById('result-profit-user-usdc').innerHTML = '0.00' + usdcIconImg;
             document.getElementById('result-profit-ref-sol').innerHTML = '0' + solanaIconImg;
             document.getElementById('result-profit-ref-usdc').innerHTML = '0.00' + usdcIconImg;
             document.getElementById('result-profit-total-sol').innerHTML = '0' + solanaIconImg;
             document.getElementById('result-profit-total-usdc').innerHTML = '0.00' + usdcIconImg;
             document.getElementById('result-profit-percent-sol').textContent = '0 %';
             document.getElementById('result-profit-percent-usdc').textContent = '0 %';
             document.getElementById('result-double-sol-noreinvest').textContent = 'N/A';
             document.getElementById('result-double-usdc-noreinvest').textContent = 'N/A';
             document.getElementById('result-double-sol-reinvest').textContent = 'N/A';
             document.getElementById('result-double-usdc-reinvest').textContent = 'N/A';
             document.getElementById('result-final-balance-sol').innerHTML = '0' + solanaIconImg;
             document.getElementById('result-final-balance-usdc').innerHTML = '0.00' + usdcIconImg;
             document.getElementById('result-final-balance-usd-total').textContent = '0 $';
             document.getElementById('result-profit-total-usd').textContent = '0 $';
             if (message) { console.warn(message); }
        }

        // --- Collapsible Section Function ---
        function toggleReferralsSection() { /* ... */
            const referralsContainer = document.getElementById('referralsContainer'); if (referralsContainer) { referralsContainer.classList.toggle('collapsed'); saveData(); }
        }

        // --- Event Listener Setup ---
        function setupEventListeners() {
             // --- UPDATED selector to include new inputs/selects ---
             document.querySelectorAll('.input-group input, .input-group select, .checkbox-container input').forEach(element => {
                 element.addEventListener('change', saveData);
             });
             // --- END UPDATE ---
             document.getElementById('languageToggleButton').addEventListener('click', toggleLanguage);
             document.getElementById('addReferralButton').addEventListener('click', addReferral);
             document.getElementById('saveReferralButton').addEventListener('click', saveReferralData);
             document.getElementById('cancelReferralButton').addEventListener('click', closeEditModal);
             document.getElementById('editReferralModal').addEventListener('click', (event) => { if (event.target === event.currentTarget) { closeEditModal(); } });
             document.getElementById('calculateButton').addEventListener('click', calculate);
             document.getElementById('h3-referrals').addEventListener('click', toggleReferralsSection);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            currentLanguage = localStorage.getItem('fomoFarmCalc_language') || 'en';
            loadData();
            setupEventListeners();
            updateUI(currentLanguage);
            clearResults(); // Ensure initial state has icons
            renderReferralsTable();
        });

    </script>
</body>
</html>
