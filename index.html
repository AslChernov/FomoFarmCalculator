<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=750">
    <title>FomoFarm Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
    /* --- Общие стили --- */
    * { box-sizing: border-box; }
        body {
            font-family: 'Manrope', sans-serif; margin: 20px; background-color: #000000;
            color: #ffffff; display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; padding-bottom: 50px;
        }
        .container {
            width: 750px;
            margin: auto;
            background-color:#000000;  padding: 20px;
            border: 2px solid #0ea5e9; border-radius: 20px; 
        }

        /* --- Стили заголовков --- */
        .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h1 { font-size: 30px; font-weight: 900; margin: 0; letter-spacing: -1px; display: flex; align-items: center; justify-content: center; gap: 10px; flex-grow: 1; justify-content: flex-start; }
        h1 span#appTitle { background-image: linear-gradient(to right, #0ea5e9, #7dd3fc ); background-clip: text; -webkit-background-clip: text; color: transparent; }
        h2 { margin-block-start: 0em; margin-block-end: 0em; font-size: 30px; text-align: center; text-transform: uppercase; font-weight: 800; letter-spacing: -0.5px; color: #4ade80; margin-top: 0px; margin-bottom: 15px; border-bottom: 1px solid #374151; padding-bottom: 8px; }
        h3 { font-size: 24px; margin-top: 25px; margin-block-start: 0em; margin-block-end: 0em; text-align: center; text-transform: uppercase; font-weight: 700; letter-spacing: -0.5px; color: #e5e7eb; margin-bottom: 15px; } /* Общий стиль для h3 */
        h4 { font-size: 16px; color: #dfdfdf; text-transform: uppercase; font-weight: 600; margin-top: 15px; margin-bottom: 10px; }

        h1 span.app-version-badge { /* Или #appVersionDisplay, если используешь ID для стилизации */
            display: inline-block; /* Обязательно для padding и background */
            font-size: 16px;       /* Уменьшенный размер шрифта */
            font-weight: 900;      /* Можно сделать жирным или нормальным */
            line-height: 1;        /* Компактность по высоте */
            color: #075985;       /* Темно-синий текст (подбери под фон) */
            background-color: #7dd3fc; /* Светло-голубой фон плашки */
            padding: 4px 8px;       /* Внутренние отступы плашки */
            border-radius: 6px;     /* Скругление углов */
            margin-left: 6px;       /* Отступ от основного заголовка */
            
            /* Выравнивание относительно текста заголовка, если h1 - flex-контейнер */
            /* align-self: center; */ /* Попробуй это */
            /* Если нужно точнее, можно использовать position: relative */
             align-self: center;
             top: 0px; /* Небольшой сдвиг вверх, чтобы лучше смотрелось с большим заголовком */
        }

        .input-group { 
            display: flex;
            flex-direction: column;
            gap: 15px; 
            margin-bottom: 20px;
        }

        .currency-input-row { /* Стиль для каждой строки с 3-мя полями ввода */
            display: grid;
            grid-template-columns: 1fr 1.3fr 2fr; /* Три колонки равной ширины */
            gap: 15px; 
            align-items: start; 
        }

        .input-block { /* Стиль для каждого из 3-х блоков в строке */
            padding: 10px; 
            border: 1px solid #1f2937; 
            border-radius: 8px; 
            background-color: #111827;
            display: flex;
            flex-direction: column; /* Лейбл над инпутом */
        }

        /* --- Стили для пар инпут+селект и инпут+кнопка --- */
        .input-select-pair { display: flex; gap: 10px; margin-top: 0px; align-items: center;  }
        .input-select-pair input[type="number"] { flex-grow: 2; min-width: 0;} /* Настройка распределения места */
        .input-select-pair select { flex-grow: 3; min-width: 0;}  /* Настройка распределения места */

        .input-button-pair-row { display: flex; align-items: center; gap: 8px; margin-top: 0px;  }
        .input-button-pair-row input[type="number"] { flex-grow: 1; min-width: 0; margin-top: 0;  }
        #fetchSolPriceButton { padding: 6px 10px; font-size: 12px; text-transform: none; flex-shrink: 0; background-color: #8b5cf6; margin-top: 0; }
        #fetchSolPriceButton:hover { background-color: #2563eb; }
        
        .label-status-wrapper { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        #solPriceStatus { font-size: 11px; color: #6b7280; min-height: 14px; }
        #solPriceStatus.loading, #converterStatus.loading { color: #fbbf24; }
        #solPriceStatus.success, #converterStatus.success { color: #4ade80; }
        #solPriceStatus.error, #converterStatus.error { color: #ef4444; }

        /* --- Стили Лейблов --- */
        label { display: block; font-size: 14px; font-weight: 500; letter-spacing: inherit; color: #cbd5e1; margin-bottom: 5px; line-height: 1.3; }

        .input-block > label { height: auto; min-height: 0; }

        #label-user-staked-sol, #label-user-staked-usdc, #label-user-profit-percent-sol, #label-user-profit-percent-usdc,
        #label-modal-stake-sol, #label-modal-profit-sol, #label-modal-stake-usdc, #label-modal-profit-usdc,
        #label-periodic-sol, #label-periodic-usdc,
        #label-sol-usd, #label-modal-level, #label-platform-fee,
        #label-profit-user-sol, #label-profit-user-usdc, #label-profit-ref-sol, #label-profit-ref-usdc,
        #label-profit-total-sol, #label-profit-total-usdc, #label-profit-percent-sol, #label-profit-percent-usdc,
        #label-double-sol-noreinvest, #label-double-usdc-noreinvest, #label-double-sol-reinvest, #label-double-usdc-reinvest,
        #label-periodic-total-sol, #label-periodic-total-usdc, #label-final-balance-sol, #label-final-balance-usdc,
        #label-final-balance-usd, #label-profit-total-usd {
            display: inline-flex; align-items: center; gap: 0;
        }

        /* Стили для иконок внутри лейблов и результатов */
        label img, .result-item img, .stakes-summary img, .tooltip-icon {
            width: 16px; height: 16px; vertical-align: middle;
        }
        label img, .result-item .value img { margin-left: 5px; }
        .referrals td.stakes-summary img { margin-left: 4px; }

        /* --- Стили Тултипов (подсказок) --- */
        .tooltip-container { position: relative; display: inline-flex; align-items: center; margin-left: 5px; }
        .tooltip-icon { color: #6b7280; cursor: help; font-size: 0.9em; }
        .tooltip-text {
            display: none; 
            position: absolute; 
            bottom: 100%; 
            left: 50%; 
            transform: translateX(-50%);
            background-color: #1f2937; 
            color: #e5e7eb; 
            border: 1px solid #374151;
            padding: 5px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            z-index: 10; 
            margin-bottom: 5px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            pointer-events: none; 
            width: 180px;     /* Максимальная ширина, можешь изменить это значение */
            white-space: normal;  /* Разрешает нормальный перенос строк по пробелам */
            text-align: left;
        }
        .tooltip-container:hover .tooltip-text {
            display: block;
        }
        .tooltip-container:hover .tooltip-text { display: block; }

        /* --- Стили Валидации --- */
        input.input-error, select.input-error { border-color: #ef4444 !important; }
        .error-message { display: none; /* Сообщения об ошибках по умолчанию скрыты */ }

        /* --- Общие стили для Инпутов и Селектов --- */
        input[type="number"], input[type="text"], select { 
            width: 100%; /* Это будет 100% от родительского .input-block или .input-select-pair child */
            padding: 8px 10px; margin-top: 0;  border: 1px solid #1f2937;  
            border-radius: 6px; font-size: 14px; font-family: 'Manrope', sans-serif; 
            color: #ffffff; background-color: #090c14; transition: border-color 0.3s ease; 
        }
        input[type="number"]:focus, input[type="text"]:focus, select:focus { outline: none; border-color: #8b5cf6; }
        select { 
            appearance: none; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%239ca3af' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='m19.5 8.25-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E%0A"); 
            background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; padding-right: 30px; 
        }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { 
            -moz-appearance: textfield; 
            appearance: textfield; 
        }

        /* --- Стили Чекбоксов и Поля для процента реинвеста --- */
        .checkbox-container { 
            display: flex; 
            justify-content: center; /* или space-around */
            gap: 20px; /* Уменьшил gap, если нужно больше места */
            margin-top: 25px; 
            margin-bottom: 25px; 
            padding: 10px 0; 
            flex-wrap: wrap; 
            align-items: center; 
        }

        .checkbox-item.reinvest-control-group {
            /* Стили для группы реинвеста, если нужно выделить или ограничить ширину */
            /* Например, можно добавить немного padding или border для визуального разделения */
            padding: 10px;
            /* border: 1px solid #2a2f3b; */ /* Пример рамки */
            border-radius: 6px;
        }
        .checkbox-item { display: flex; align-items: center; gap: 8px; justify-content: center; }
        .checkbox-item input[type="checkbox"] { width: 18px; height: 18px; margin: 0; cursor: pointer; accent-color: #4ade80; border: 1px solid #374151; border-radius: 3px; vertical-align: middle; flex-shrink: 0; }
        .checkbox-item input[type="checkbox"]:focus { outline: 1px solid #4ade80; outline-offset: 1px; }
        .checkbox-item label { 
            font-size: 15px; /* У тебя 16px для специфичного */
            font-weight: 700; 
            color: #cbd5e1; 
            cursor: pointer; 
            margin-bottom: 0; 
            line-height: 1; 
            min-height: auto; 
            display: inline; 
            align-items: initial; 
            padding-bottom: 0; 
        }
        /* Стили для .reinvest-percent-item остаются, если они используются для чего-то еще, но в текущей HTML структуре поле % реинвеста встроено в .checkbox-item */
        .checkbox-item input.reinvest-percent-input { /* Увеличиваем специфичность */
            width: 50px;      /* Желаемая ширина */
            min-width: 50px;  /* Можно добавить для надежности */
            padding: 4px 6px; /* Паддинг поменьше, если нужно */
            font-size: 13px; 
            text-align: right; 
            margin-left: 5px; 
            flex-grow: 0;     /* Убедимся, что flex-grow не растягивает его, если родитель flex */
            flex-shrink: 0;   /* И не сжимает */
        }
        .reinvest-percent-symbol { /* Общий класс для символа % */
            color: #9ca3af; 
            font-size: 14px;
            margin-left: 2px; /* Ближе к числу */
        }

        /* --- Общие Стили Кнопок --- */
        button { width: auto; padding: 10px 20px; border: none; border-radius: 6px; font-size: 15px; text-transform: uppercase; font-family: 'Manrope', sans-serif; background-color: #7c3aed; letter-spacing: inherit; color: #fff; cursor: pointer; font-weight: 700; transition: background-color 0.3s ease, transform 0.1s ease, opacity 0.3s ease; }
        button:hover { background-color: #6d28d9; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #585063; cursor: not-allowed; opacity: 0.6; }
        button:disabled:hover { background-color: #585063; }

        /* --- Специфичные Стили Кнопок --- */
        #languageToggleButton { padding: 6px 12px; font-size: 12px; background-color: #374151; text-transform: none; font-weight: 500; margin-top: 0; order: 2; }
        #languageToggleButton:hover { background-color: #4b5563; }
        #languageToggleButton:disabled { background-color: #374151; cursor: pointer; opacity: 1; }
        #languageToggleButton:disabled:hover { background-color: #4b5563;}

        /* --- Стили Сворачиваемых Секций --- */
        .collapsible-section { margin-top: 25px; }
        .collapsible-header {
            cursor: pointer; display: flex; align-items: center; justify-content: space-between;
            gap: 8px; user-select: none; margin-bottom: 0;
            padding: 8px 10px; background-color: #1f2937; border-radius: 6px; border: 1px solid #374151;
        }
        .collapsible-section:not(.collapsed) .collapsible-header {
             border-bottom-left-radius: 0; border-bottom-right-radius: 0;
        }
        .collapsible-header h3 {
            font-size: 18px; margin: 0; text-align: left; color: #e5e7eb; font-weight: 600; text-transform: none;
        }
        .toggle-icon { font-size: 0.8em; color: #9ca3af; }
        .collapsible-content {
            padding: 15px; background-color: #111827;
            border: 1px solid #1f2937; border-top: none;
            border-top-left-radius: 0; border-top-right-radius: 0;
            border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
            overflow: hidden;
        }
        .collapsible-section.collapsed .collapsible-content {
             max-height: 0; padding-top: 0; padding-bottom: 0;
             border-width: 0 1px 0 1px; opacity: 0; display: none;
        }
        .collapsible-section:not(.collapsed) .collapsible-content {
            display: block;
        }
        .collapsible-section.collapsed .toggle-icon { transform: rotate(-90deg); }

        /* --- Стили Секции Рефералов --- */
        .referrals table { width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 15px; letter-spacing: inherit; table-layout: fixed; }
        .referrals th, .referrals td { padding: 8px 10px; text-align: center; font-size: 15px; font-weight: 500; background-color: #111827; border: 1px solid #1f2937; letter-spacing: inherit; word-wrap: break-word; vertical-align: middle; }
        .referrals th { font-weight: 900; color: #9ca3af; }
        .referrals th.sortable { cursor: pointer; }
        .referrals th.sortable:hover { background-color: #374151; }
        .referrals th .sort-icon { margin-left: 5px; font-size: 0.8em; color: #6b7280; }
        .referrals th:nth-child(1) { width: 8%; }
        .referrals th:nth-child(2) { width: 15%; }
        .referrals th:nth-child(3) { width: 45%; }
        .referrals th:nth-child(4) { width: 30%; }
        .referrals td.stakes-summary { font-size: 14px; color: #d1d5db; text-align: center; font-weight: 500; white-space: pre-wrap; }
        .referrals td.stakes-summary span { display: inline-flex; align-items: center; margin: 0 5px; white-space: nowrap; }
        .referrals td.stakes-summary span img { margin-right: 4px; margin-left: 0; }
        .referrals td.actions-cell { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 8px 5px; }
        .referrals td .action-button { margin: 0; padding: 6px 8px; font-size: 12px; border-radius: 4px; font-weight: 500; text-transform: none; min-width: 65px; text-align: center; }
        .referrals td .edit-button { background-color: #f59e0b; }
        .referrals td .edit-button:hover { background-color: #d97706; }
        .referrals td .remove-button { background-color: #ef4444; }
        .referrals td .remove-button:hover { background-color: #dc2626; }
        #addReferralButton { background-color: #3b82f6; margin-top: 10px; }
        #addReferralButton:hover { background-color: #2563eb; }

        /* --- Стили Секции Результатов --- */
        .results { margin-top: 25px; padding: 20px; background-color: #111827; border: 1px solid #1f2937; border-radius: 8px; }
        .results-grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-top: 15px;
        }
        .result-group h4 { margin-top: 0; }
        .result-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #283141; font-size: 14px; }
        .result-item:last-child { border-bottom: none; }
        .result-item .label { color: #9ca3af; }
        .result-item .value { color: #ffffff; font-weight: 900; text-align: right; display: inline-flex; align-items: center; }
        .result-item .value.value-sol { color: #4ade80; }
        .result-item .value.value-usdc { color: #60a5fa; }
        .result-item .value.profit-percent { color: #4ade80; }
        .result-item .value.doubling { color: #fbbf24; }
        .result-item .value.balance-usd { color: #60a5fa; }

        /* --- Стили Графика --- */
        .chart-content {
             padding: 15px; background-color: #111827;
             border: 1px solid #1f2937;
        }
        #balanceChart { max-height: 300px; }

        /* --- Стили Конвертера --- */
        .converter-header h3 {
             font-size: 18px; margin: 0; text-align: left; color: #e5e7eb; font-weight: 600; text-transform: none;
        }
        #converterStatus {
            font-size: 11px; color: #6b7280; min-height: 14px; text-align: right;
        }
        .converter-wrapper {
            display: flex; align-items: center; gap: 10px;
            margin-top: 15px; 
        }
        .converter-block {
            display: flex; flex-grow: 1; border: 1px solid #374151;
            border-radius: 6px; overflow: hidden; background-color: #090c14; position: relative;
        }
        .converter-block input[type="number"],
        .converter-block input[type="text"] {
            flex-grow: 1; border: none; border-radius: 0; padding: 8px 10px;
            min-width: 80px; color: #ffffff; caret-color: #ffffff;
            text-align: left; background-color: transparent;
        }
        .converter-block select {
            border: none; border-left: 1px solid #374151; border-radius: 0;
            background-color: #111827; padding: 8px 10px; padding-right: 30px;
            max-width: 150px; flex-shrink: 0;
        }
        #convertResultAmount { cursor: default; background-color: #111827; }
        #swapCurrenciesButton {
            padding: 6px 10px; font-size: 14px; background-color: #374151;
            color: #cbd5e1; border: none; border-radius: 6px; cursor: pointer;
            line-height: 1; flex-shrink: 0; height: 36px; min-width: 40px;
        }
        #swapCurrenciesButton:hover { background-color: #4b5563; }

        /* --- Стили Управляющих Кнопок --- */
        .control-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 25px; flex-wrap: wrap; }
        #calculateButton { background-color: #22c55e; margin: 0; }
        #calculateButton:hover { background-color: #16a34a; }
        #resetButton { background-color: #ef4444; margin: 0; }
        #resetButton:hover { background-color: #dc2626; }
        #exportButton, #importButton { background-color: #3b82f6; margin: 0; }
        #exportButton:hover, #importButton:hover { background-color: #2563eb; }

        /* --- Стили Подвала --- */
        .textContent { text-align: center; margin-top: 30px; font-size: 15px; color: #6b7280; }
        .textContent p { display: block; margin-block-start: 0em; margin-block-end: 0em; margin-inline-start: 0px; margin-inline-end: 0px; unicode-bidi: isolate; }
        .textContent i { color: #6b7280; margin: 0 2px; }
        .textContent a { color: #3b82f6; text-decoration: none; }
        .textContent a:hover { text-decoration: underline; }

        /* --- Стили Модального Окна (Редактирование Реферала) --- */
        .modal-overlay { 
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; 
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); 
            justify-content: center; align-items: center; 
        }
        .modal-content { 
            background-color: #111827;
            margin: auto; padding: 25px; 
            border: 2px solid #0ea5e9;
            border-radius: 20px; width: 90%; max-width: 500px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; 
        }
        .modal-header { 
            padding-bottom: 15px; 
            margin-bottom: 20px; 
        }
        .modal-header h4 { 
            margin: 0; font-size: 20px; font-weight: 700; color: #e5e7eb; text-align: center; 
        }
        .modal-body { 
            max-height: 60vh; 
            overflow-y: auto; 
            padding-right: 10px; /* Оставляем для скроллбара, если содержимое будет высоким */
        }

        /* Общий стиль для input-pair в модальном окне остается */
        .modal-body .input-pair { 
            margin-bottom: 15px; 
        }

        .modal-body .input-pair.modal-level-field {
            max-width: 210px;
            margin-bottom: 30px;
        }
        .modal-body .input-pair label { 
            margin-bottom: 8px; 
            font-size: 15px; 
            color: #9ca3af; 
        }
        .modal-body .input-pair input, 
        .modal-body .input-pair select { 
            width: 100%; /* По умолчанию инпут/селект занимает всю ширину своего .input-pair */
            font-size: 14px; 
            padding: 6px 8px; 
        }

        /* --- НОВЫЕ СТИЛИ ДЛЯ РАСПОЛОЖЕНИЯ В РЯД --- */
        .modal-input-row {
            display: flex; /* Используем flexbox для расположения элементов в ряд */
            gap: 15px;     /* Пространство между полем стейка и полем процента */
            align-items: flex-start; /* Выравнивание по верхнему краю, если лейблы разной высоты */
            margin-bottom: 15px; /* Отступ снизу для всей строки */
        }

        .modal-input-row .input-pair {
            flex: 1; /* Позволяет элементам равномерно делить пространство */
        }

        .modal-footer { 
            padding-top: 20px; 
            margin-top: 0px; 
            display: flex; justify-content: center; gap: 10px; 
        }
        .modal-footer button { padding: 8px 18px; font-size: 14px; }
        #saveReferralButton { background-color: #22c55e; }
        #saveReferralButton:hover { background-color: #16a34a; }
        #cancelReferralButton { background-color: #6b7280; }
        #cancelReferralButton:hover { background-color: #4b5563; }

        /* --- Стили Пагинации --- */
        .pagination-controls {
            display: flex; justify-content: center; align-items: center;
            gap: 5px; margin-top: 15px; flex-wrap: wrap;
        }
        .pagination-controls button {
            padding: 6px 12px; font-size: 13px; font-weight: 600; text-transform: none;
            min-width: 35px; border: 1px solid #374151; background-color: #1f2937;
            color: #cbd5e1; border-radius: 4px; cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .pagination-controls button:hover:not(:disabled) { background-color: #374151; }
        .pagination-controls button:disabled {
            background-color: #111827; color: #4b5563;
            cursor: not-allowed; opacity: 0.7;
        }
        .pagination-controls button.active {
            background-color: #4ade80; color: #111827;
            border-color: #4ade80; font-weight: 700;
        }
    </style>

</head>
<body>
    <div class="container">
        <div class="header-container">
             <h1>
                 <svg width="60" height="60" viewBox="0 0 119.01 73.79" preserveAspectRatio="xMidYMid meet">
                     <defs> <linearGradient id="linear-gradient" x1="15" y1="75.16" x2="117" y2="14.9" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2573dc"/> <stop offset=".16" stop-color="#3794e5"/> <stop offset=".36" stop-color="#4cbaef"/> <stop offset=".46" stop-color="#55c9f3"/> <stop offset=".65" stop-color="#60def9"/> <stop offset=".84" stop-color="#68edfd"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient1" x1="23.33" y1="67.19" x2="115.05" y2="17.36" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".15" stop-color="#2a7ada"/> <stop offset=".34" stop-color="#338bdf"/> <stop offset=".56" stop-color="#42a6e8"/> <stop offset=".8" stop-color="#56ccf3"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient2" x1="5.49" y1="59.23" x2="107.52" y2=".56" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".17" stop-color="#2979da"/> <stop offset=".35" stop-color="#3085de"/> <stop offset=".54" stop-color="#3b9be4"/> <stop offset=".73" stop-color="#4bb8ed"/> <stop offset=".91" stop-color="#60def8"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient3" x1="22.29" y1="69.52" x2="115.96" y2="15.28" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".14" stop-color="#2b7cdb"/> <stop offset=".36" stop-color="#3691e1"/> <stop offset=".62" stop-color="#48b3eb"/> <stop offset=".91" stop-color="#62e2fa"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient4" x1="5.15" y1="58.96" x2="97.33" y2="7.21" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".26" stop-color="#2877d9"/> <stop offset=".43" stop-color="#2d80dc"/> <stop offset=".58" stop-color="#358fe1"/> <stop offset=".71" stop-color="#41a4e7"/> <stop offset=".84" stop-color="#50c0ef"/> <stop offset=".95" stop-color="#62e1fa"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient5" x1="24.22" y1="66.48" x2="116.12" y2="15.04" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".14" stop-color="#2a7bdb"/> <stop offset=".35" stop-color="#358fe0"/> <stop offset=".6" stop-color="#46aeea"/> <stop offset=".87" stop-color="#5edaf7"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient6" x1="1.45" y1="41.31" x2="91.67" y2="-11.99" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2573dc"/> <stop offset=".24" stop-color="#43a9ea"/> <stop offset=".4" stop-color="#55c9f3"/> <stop offset=".61" stop-color="#60def9"/> <stop offset=".82" stop-color="#68edfd"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> </defs> <polygon points="78.92 14.22 66.17 14.22 19.83 41.17 9.25 67.33 29.87 67.33 33.62 58.9 48.26 50.55 40.94 67.33 55.45 67.33 68.14 39.22 82.43 31.07 66.61 67.33 80.94 67.33 101.06 20.45 105.5 17.92 107 23.75 114.08 8.92 97.75 8 102.07 12.39 18.67 60.34 22.07 52.31 25.22 45.11 78.92 14.22" fill="url(#linear-gradient)"/> <polygon points="44.42 59.36 63.85 48.71 68.14 39.22 48.26 50.55 44.42 59.36" fill="url(#linear-gradient1)"/> <polygon points="59.04 25.55 55.7 33.14 75.53 21.83 78.92 14.22 59.04 25.55" fill="url(#linear-gradient2)"/> <polygon points="82.43 31.07 78.2 40.76 97.32 29.17 101.06 20.45 82.43 31.07" fill="url(#linear-gradient3)"/> <polygon points="25.22 45.11 22.07 52.31 41.69 41.13 44.97 33.75 25.22 45.11" fill="url(#linear-gradient4)"/> <polygon points="29.87 67.33 33.62 58.9 15.53 67.33 29.87 67.33" fill="url(#linear-gradient5)"/> <polygon points="38.44 14.22 32.5 27.83 52.55 16.36 53.5 14.22 38.44 14.22" fill="url(#linear-gradient6)"/>
                 </svg>
                 <span id="appTitle">FomoFarm Calculator</span>
                 <span id="appVersionDisplay" class="app-version-badge"></span> </h1>
             <button id="languageToggleButton"></button>
        </div>

        <div class="input-group"> 
            <div class="currency-input-row sol-inputs">
                <div class="input-block stake-input">
                    <label for="userStakedSolAmount" id="label-user-staked-sol">Staked</label>
                    <input type="number" id="userStakedSolAmount" value="0" step="0.001" min="0">
                    <span class="error-message" id="error-userStakedSolAmount"></span>
                </div>
                <div class="input-block profit-input">
                    <label for="userProfitPercentSol" id="label-user-profit-percent-sol">Profit % / day
                        <span class="tooltip-container">
                            <i class="fas fa-question-circle tooltip-icon"></i>
                            <span class="tooltip-text" id="tooltip-profit-sol">Daily profit percentage for SOL stake</span>
                        </span>
                    </label>
                    <input type="number" id="userProfitPercentSol" value="0" step="0.01" min="0">
                    <span class="error-message" id="error-userProfitPercentSol"></span>
                </div>
                <div class="input-block periodic-input-container">
                    <label for="periodicSolAmount" id="label-periodic-sol">Add. Investment</label>
                    <div class="input-select-pair">
                        <input type="number" id="periodicSolAmount" value="0" step="0.01" min="0">
                        <select id="periodicSolPeriod">
                            <option value="0" id="option-sol-none">No</option>
                            <option value="7" id="option-sol-weekly">Weekly</option>
                            <option value="30" id="option-sol-monthly">Monthly</option>
                            <option value="91" id="option-sol-quarterly">Quarterly</option>
                        </select>
                    </div>
                    <span class="error-message" id="error-periodicSolAmount"></span>
                </div>
            </div>

            <div class="currency-input-row usdc-inputs">
                <div class="input-block stake-input">
                    <label for="userStakedUsdcAmount" id="label-user-staked-usdc">Staked</label>
                    <input type="number" id="userStakedUsdcAmount" value="0" step="0.01" min="0">
                    <span class="error-message" id="error-userStakedUsdcAmount"></span>
                </div>
                <div class="input-block profit-input">
                    <label for="userProfitPercentUsdc" id="label-user-profit-percent-usdc">Profit % / day
                        <span class="tooltip-container">
                            <i class="fas fa-question-circle tooltip-icon"></i>
                            <span class="tooltip-text" id="tooltip-profit-usdc">Daily profit percentage for USDC stake</span>
                        </span>
                    </label>
                    <input type="number" id="userProfitPercentUsdc" value="0" step="0.01" min="0">
                    <span class="error-message" id="error-userProfitPercentUsdc"></span>
                </div>
                <div class="input-block periodic-input-container">
                    <label for="periodicUsdcAmount" id="label-periodic-usdc">Add. Investment</label>
                    <div class="input-select-pair">
                        <input type="number" id="periodicUsdcAmount" value="0" step="0.01" min="0">
                        <select id="periodicUsdcPeriod">
                            <option value="0" id="option-usdc-none">No</option>
                            <option value="7" id="option-usdc-weekly">Weekly</option>
                            <option value="30" id="option-usdc-monthly">Monthly</option>
                            <option value="91" id="option-usdc-quarterly">Quarterly</option>
                        </select>
                    </div>
                    <span class="error-message" id="error-periodicUsdcAmount"></span>
                </div>
            </div>

            <div class="currency-input-row other-params-row">
                <div class="input-block">
                    <label for="days" id="label-days">Days</label>
                    <input type="number" id="days" value="0" step="1" min="0">
                    <span class="error-message" id="error-days"></span>
                </div>
                <div class="input-block" id="solUsdContainer">
                    <div class="label-status-wrapper">
                        <label for="solToUsd" id="label-sol-usd">SOL / USD</label>
                        <span id="solPriceStatus"></span>
                    </div>
                    <div class="input-button-pair-row">
                        <input type="number" id="solToUsd" value="0" step="0.01" min="0">
                        <button id="fetchSolPriceButton" type="button">Update</button>
                    </div>
                    <span class="error-message" id="error-solToUsd"></span>
                </div>
                <div class="input-block" id="platformFeeContainer">
                    <label for="platformFee" id="label-platform-fee">FomoFarm Fee (%)
                        <span class="tooltip-container">
                            <i class="fas fa-question-circle tooltip-icon"></i>
                            <span class="tooltip-text" id="tooltip-platform-fee">Platform commission percentage</span>
                        </span>
                    </label>
                    <input type="number" id="platformFee" value="10" step="0.1" min="0">
                    <span class="error-message" id="error-platformFee"></span>
                </div>
            </div>

        </div>
        <div class="checkbox-container">
            <div class="checkbox-item reinvest-control-group">
                <input type="checkbox" id="reinvestSolCheckbox" data-currency="Sol">
                <label for="reinvestSolCheckbox" id="label-reinvest-sol"></label> <input type="number" id="reinvestSolPercent" value="100" min="0" max="100" step="1" class="reinvest-percent-input" style="display: none;">
                <span class="reinvest-percent-symbol" style="display: none;">%</span>
            </div>

            <div class="checkbox-item reinvest-control-group">
                <input type="checkbox" id="reinvestUsdcCheckbox" data-currency="Usdc">
                <label for="reinvestUsdcCheckbox" id="label-reinvest-usdc"></label> <input type="number" id="reinvestUsdcPercent" value="100" min="0" max="100" step="1" class="reinvest-percent-input" style="display: none;">
                <span class="reinvest-percent-symbol" style="display: none;">%</span>
            </div>
            
            <div class="checkbox-item">
                <input type="checkbox" id="includeReferralsCheckbox">
                <label for="includeReferralsCheckbox" id="label-enable-referrals">Enable Referrals</label>
            </div>
        </div>
        <div class="control-buttons">
            <button id="calculateButton">Calculate</button>
            <button id="resetButton" type="button">Reset</button>
            <button id="exportButton" type="button">Export Data</button>
            <button id="importButton" type="button">Import Data</button>
            <input type="file" id="importFile" accept=".json" style="display: none;">
        </div>

        <div class="results">
            <h2 id="h2-results">Results</h2>
            <div class="results-grid-container">
                <div class="result-group">
                    <h4 id="h4-sol-results">SOL Results</h4>
                    <div class="result-item">
                        <span class="label" id="label-profit-user-sol">
                            From Your Stake:
                             <span class="tooltip-container">
                                <i class="fas fa-question-circle tooltip-icon"></i>
                                <span class="tooltip-text" id="tooltip-profit-user-sol">Your net profit from SOL stake after fees</span>
                            </span>
                        </span>
                        <span class="value profit-sol" id="result-profit-user-sol">0 SOL</span>
                    </div>
                    <div class="result-item">
                        <span class="label" id="label-profit-ref-sol">
                            From Referrals:
                             <span class="tooltip-container">
                                <i class="fas fa-question-circle tooltip-icon"></i>
                                <span class="tooltip-text" id="tooltip-profit-ref-sol">Your profit from referral SOL stakes</span>
                            </span>
                        </span>
                        <span class="value profit-sol" id="result-profit-ref-sol">0 SOL</span>
                    </div>
                     <div class="result-item">
                        <span class="label" id="label-periodic-total-sol">
                            Added Investments:
                             <span class="tooltip-container">
                                <i class="fas fa-question-circle tooltip-icon"></i>
                                <span class="tooltip-text" id="tooltip-periodic-total-sol">Total additional SOL invested periodically</span>
                            </span>
                        </span>
                        <span class="value" id="result-periodic-total-sol">0</span>
                    </div>
                    <div class="result-item">
                        <span class="label" id="label-profit-total-sol">
                            Total Profit SOL:
                             <span class="tooltip-container">
                                <i class="fas fa-question-circle tooltip-icon"></i>
                                <span class="tooltip-text" id="tooltip-profit-total-sol">Total SOL profit (yours + referrals)</span>
                            </span>
                        </span>
                        <span class="value profit-sol" id="result-profit-total-sol">0 SOL</span>
                    </div>
                     <div class="result-item">
                        <span class="label" id="label-final-balance-sol">
                            Final Balance SOL:
                             <span class="tooltip-container">
                                <i class="fas fa-question-circle tooltip-icon"></i>
                                <span class="tooltip-text" id="tooltip-final-balance-sol">Initial stake + total profit + additional investments</span>
                            </span>
                         </span>
                         <span class="value" id="result-final-balance-sol">0 SOL</span>
                    </div>
                </div>

                <div class="result-group">
                    <h4 id="h4-usdc-results">USDC Results</h4>
                    <div class="result-item">
                        <span class="label" id="label-profit-user-usdc">
                            From Your Stake:
                             <span class="tooltip-container">
                                <i class="fas fa-question-circle tooltip-icon"></i>
                                <span class="tooltip-text" id="tooltip-profit-user-usdc">Your net profit from USDC stake after fees</span>
                            </span>
                        </span>
                        <span class="value profit-usdc" id="result-profit-user-usdc">0 USDC</span>
                    </div>
                    <div class="result-item">
                        <span class="label" id="label-profit-ref-usdc">
                            From Referrals:
                             <span class="tooltip-container">
                                <i class="fas fa-question-circle tooltip-icon"></i>
                                <span class="tooltip-text" id="tooltip-profit-ref-usdc">Your profit from referral USDC stakes</span>
                            </span>
                        </span>
                        <span class="value profit-usdc" id="result-profit-ref-usdc">0 USDC</span>
                    </div>
                     <div class="result-item">
                        <span class="label" id="label-periodic-total-usdc">
                            Added Investments:
                             <span class="tooltip-container">
                                <i class="fas fa-question-circle tooltip-icon"></i>
                                <span class="tooltip-text" id="tooltip-periodic-total-usdc">Total additional USDC invested periodically</span>
                            </span>
                        </span>
                        <span class="value" id="result-periodic-total-usdc">0</span>
                    </div>
                    <div class="result-item">
                        <span class="label" id="label-profit-total-usdc">
                            Total Profit USDC:
                             <span class="tooltip-container">
                                <i class="fas fa-question-circle tooltip-icon"></i>
                                <span class="tooltip-text" id="tooltip-profit-total-usdc">Total USDC profit (yours + referrals)</span>
                            </span>
                        </span>
                        <span class="value profit-usdc" id="result-profit-total-usdc">0 USDC</span>
                    </div>
                     <div class="result-item">
                        <span class="label" id="label-final-balance-usdc">
                            Final Balance USDC:
                             <span class="tooltip-container">
                                <i class="fas fa-question-circle tooltip-icon"></i>
                                <span class="tooltip-text" id="tooltip-final-balance-usdc">Initial stake + total profit + additional investments</span>
                            </span>
                        </span>
                        <span class="value" id="result-final-balance-usdc">0 USDC</span>
                    </div>
                </div>

                <div class="result-group" style="grid-column: 1 / -1;"> <h4 id="h4-general-results">General Results</h4>
                     <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;"> <div>
                             <div class="result-item">
                                 <span class="label" id="label-final-balance-usd">
                                     Total Final Balance (USD):
                                     <span class="tooltip-container">
                                        <i class="fas fa-question-circle tooltip-icon"></i>
                                        <span class="tooltip-text" id="tooltip-final-balance-usd">Total final balance of SOL and USDC converted to USD</span>
                                    </span>
                                 </span>
                                 <span class="value balance-usd" id="result-final-balance-usd-total">0 $</span>
                             </div>
                             <div class="result-item">
                                 <span class="label" id="label-profit-total-usd">
                                     Total Profit (USD):
                                      <span class="tooltip-container">
                                        <i class="fas fa-question-circle tooltip-icon"></i>
                                        <span class="tooltip-text" id="tooltip-profit-total-usd">Total profit of SOL and USDC converted to USD</span>
                                    </span>
                                 </span>
                                 <span class="value balance-usd" id="result-profit-total-usd">0 $</span>
                             </div>
                             <div class="result-item">
                                 <span class="label" id="label-profit-percent-sol">
                                     Profit SOL (% of initial):
                                      <span class="tooltip-container">
                                        <i class="fas fa-question-circle tooltip-icon"></i>
                                        <span class="tooltip-text" id="tooltip-profit-percent-sol">Total SOL profit as a percentage of initial SOL stake</span>
                                    </span>
                                 </span>
                                 <span class="value profit-percent" id="result-profit-percent-sol">0 %</span>
                             </div>
                             <div class="result-item">
                                 <span class="label" id="label-profit-percent-usdc">
                                     Profit USDC (% of initial):
                                      <span class="tooltip-container">
                                        <i class="fas fa-question-circle tooltip-icon"></i>
                                        <span class="tooltip-text" id="tooltip-profit-percent-usdc">Total USDC profit as a percentage of initial USDC stake</span>
                                    </span>
                                 </span>
                                 <span class="value profit-percent" id="result-profit-percent-usdc">0 %</span>
                             </div>
                         </div>
                         <div>
                             <div class="result-item">
                                 <span class="label" id="label-double-sol-noreinvest">
                                     SOL Doubling (No Reinvest):
                                      <span class="tooltip-container">
                                        <i class="fas fa-question-circle tooltip-icon"></i>
                                        <span class="tooltip-text" id="tooltip-double-sol-noreinvest">Approximate days to double initial SOL stake without reinvesting profits</span>
                                    </span>
                                 </span>
                                 <span class="value doubling" id="result-double-sol-noreinvest">N/A</span>
                             </div>
                             <div class="result-item">
                                 <span class="label" id="label-double-sol-reinvest">
                                     SOL Doubling (With Reinvest):
                                      <span class="tooltip-container">
                                        <i class="fas fa-question-circle tooltip-icon"></i>
                                        <span class="tooltip-text" id="tooltip-double-sol-reinvest">Approximate days to double initial SOL stake with reinvesting profits</span>
                                    </span>
                                 </span>
                                 <span class="value doubling" id="result-double-sol-reinvest">N/A</span>
                             </div>
                             <div class="result-item">
                                 <span class="label" id="label-double-usdc-noreinvest">
                                     USDC Doubling (No Reinvest):
                                      <span class="tooltip-container">
                                        <i class="fas fa-question-circle tooltip-icon"></i>
                                        <span class="tooltip-text" id="tooltip-double-usdc-noreinvest">Approximate days to double initial USDC stake without reinvesting profits</span>
                                    </span>
                                 </span>
                                 <span class="value doubling" id="result-double-usdc-noreinvest">N/A</span>
                             </div>
                             <div class="result-item">
                                 <span class="label" id="label-double-usdc-reinvest">
                                     USDC Doubling (With Reinvest):
                                      <span class="tooltip-container">
                                        <i class="fas fa-question-circle tooltip-icon"></i>
                                        <span class="tooltip-text" id="tooltip-double-usdc-reinvest">Approximate days to double initial USDC stake with reinvesting profits</span>
                                    </span>
                                 </span>
                                 <span class="value doubling" id="result-double-usdc-reinvest">N/A</span>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
        </div>
        <div class="collapsible-section" id="referralsSection">
            <div class="collapsible-header" id="referralsHeader">
                <h3 id="h3-referrals-text">Referrals</h3>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
            <div class="collapsible-content referrals">
                <button id="addReferralButton">Add Referral</button>
                <table id="referralsTable">
                    <thead>
                        <tr>
                            <th id="th-referral-num">№</th>
                            <th id="th-level" class="sortable" data-sort-key="level">Level <span class="sort-icon"></span></th>
                            <th id="th-ref-stakes" class="sortable" data-sort-key="stakes">Stakes Summary <span class="sort-icon"></span></th>
                            <th id="th-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="referralsList"></tbody>
                </table> <div id="paginationControls" class="pagination-controls"></div>
           </div>
       </div>
        <div class="collapsible-section" id="chartSection">
            <div class="collapsible-header" id="chartHeader">
                 <h3 id="h3-chart-title">Доходность (USD)</h3> <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
            <div class="collapsible-content chart-content"> <canvas id="balanceChart"></canvas>
            </div>
        </div>

        <div class="collapsible-section" id="converterSection">
             <div class="collapsible-header" id="converterHeader">
                 <h3 id="h3-converter-title">Currency Converter</h3>
                 <span id="converterStatus"></span> <i class="fas fa-chevron-down toggle-icon"></i>
             </div>
             <div class="collapsible-content converter-content"> <div class="converter-wrapper">
                    <div class="converter-block">
                        <input type="number" id="convertAmountFrom" value="1" step="any" min="0">
                        <select id="convertFrom"></select>
                    </div>
                    <button id="swapCurrenciesButton" title="Swap currencies">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    <div class="converter-block result-block">
                        <input type="text" id="convertResultAmount" value="" readonly>
                        <select id="convertTo"></select>
                    </div>
                </div>
             </div>
        </div>

<div class="textContent">
             <p id="p-footer">Made by <i class="fab fa-telegram-plane"></i> AslChernov</p>
             <div id="supportSection" style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 15px; flex-wrap: wrap;">
                 <span id="label-support-author">Support the author</span>:
                 <img src="solana_icon.svg" alt="SOL" width="16" height="16" style="vertical-align: middle;">
                 <span id="walletAddress" style="font-family: monospace; color: #e5e7eb; font-size: 13px;">C4NJWa3HmpXambV1YBdyb4ZaVuUq7HPfEEWW16G8BzS9</span>
                 <button id="copyWalletButton" title="Copy address" style="background: none; border: none; color: #9ca3af; cursor: pointer; padding: 0 5px; font-size: 1em; line-height: 1;">
                     <i class="fas fa-copy"></i>
                 </button>
                 <span id="copyStatus" style="font-size: 11px; color: #4ade80; margin-left: 5px; display: none;"></span>
             </div>
             </div>
    </div>
    <div id="editReferralModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"> <h4 id="modalTitle">Edit Referral Data</h4> </div>
            <div class="modal-body">
                <input type="hidden" id="editingReferralId">
                
                <div class="input-pair modal-level-field">
                    <label for="modal-level" id="label-modal-level">Level</label>
                    <select id="modal-level">
                        <option value="1">1</option> <option value="2">2</option> <option value="3">3</option>
                        <option value="4">4</option> <option value="5">5</option> <option value="6">6</option>
                        <option value="7">7</option>
                    </select>
                </div>

                <div class="modal-input-row">
                    <div class="input-pair modal-stake-field"> <label for="modal-stake-sol" id="label-modal-stake-sol">Staked</label> 
                        <input type="number" id="modal-stake-sol" step="0.001" min="0"> 
                    </div>
                    <div class="input-pair modal-profit-field"> <label for="modal-profit-sol" id="label-modal-profit-sol">Profit % / day</label> 
                        <input type="number" id="modal-profit-sol" step="0.01" min="0"> 
                    </div>
                </div>

                <div class="modal-input-row">
                    <div class="input-pair modal-stake-field">
                        <label for="modal-stake-usdc" id="label-modal-stake-usdc">Staked</label> 
                        <input type="number" id="modal-stake-usdc" step="0.01" min="0"> 
                    </div>
                    <div class="input-pair modal-profit-field">
                        <label for="modal-profit-usdc" id="label-modal-profit-usdc">Profit % / day</label> 
                        <input type="number" id="modal-profit-usdc" step="0.01" min="0"> 
                    </div>
                </div>

            </div>
            <div class="modal-footer"> <button id="cancelReferralButton">Cancel</button> <button id="saveReferralButton">Save</button> </div>
        </div>
    </div>

    <script>
        // --- DOM Element Cache ---
        const domElements = {}; // Object to cache DOM elements

        // --- Global Variables & Constants ---
        const APP_VERSION = "3.1"; // Замени на актуальную версию
        let currentPage = 1;
        const itemsPerPage = 10; // Количество рефералов на странице
        let referralsData = [];
        let nextReferralId = 1;
        let currentLanguage = 'en';
        let balanceChartInstance = null;
        let conversionTimeout = null; // Timeout for debouncing conversion requests
        const CONVERSION_DEBOUNCE_DELAY = 500; // Delay in ms for API calls
        let currentSortKey = null; // For referral table sorting
        let currentSortOrder = 'asc'; // For referral table sorting ('asc' or 'desc')


        const REINVEST_THRESHOLD_SOL = 0.1;
        const REINVEST_THRESHOLD_USDC = 20;
        const commissionRates = { 1: 0.08, 2: 0.05, 3: 0.03, 4: 0.01, 5: 0.03, 6: 0.05, 7: 0.08 };
        const solanaIconImg = `<img src="solana_icon.svg" alt="SOL" width="16" height="16">`;
        const usdcIconImg = `<img src="usdc_icon.svg" alt="USDC" width="16" height="16">`;

        // Currencies for the converter (CoinGecko IDs and display names)
        const converterCurrencies = [
            { id: 'solana', name: 'Solana', type: 'crypto', symbol: 'SOL' },
            { id: 'usd-coin', name: 'USD Coin', type: 'crypto', symbol: 'USDC' },
            { id: 'bitcoin', name: 'Bitcoin', type: 'crypto', symbol: 'BTC' },
            { id: 'ethereum', name: 'Ethereum', type: 'crypto', symbol: 'ETH' },
            { id: 'usd', name: 'US Dollar', type: 'fiat', symbol: 'USD' },
            { id: 'eur', name: 'Euro', type: 'fiat', symbol: 'EUR' },
            { id: 'rub', name: 'Russian Ruble', type: 'fiat', symbol: 'RUB' }
        ];
        // Helper to check currency type by ID
        const getCurrencyType = (id) => converterCurrencies.find(c => c.id === id)?.type || 'crypto'; // Default to crypto if not found
        const getCurrencySymbol = (id) => converterCurrencies.find(c => c.id === id)?.symbol || '';


        // --- Translations Object ---
        const translations = {
            'en': {
                labelUserStakedSol: 'Staked', labelUserProfitPercentSol: 'Profit % / day', labelUserStakedUsdc: 'Staked', labelUserProfitPercentUsdc: 'Profit % / day',
                labelPlatformFee: 'FomoFarm Fee %', labelSolUsd: 'SOL / USD', labelDays: 'Days',
                labelPeriodicSol: 'Add. Investment', labelPeriodicUsdc: 'Add. Investment',
                optionNo: 'No', optionWeekly: 'Weekly', optionMonthly: 'Monthly', optionQuarterly: 'Quarterly',
                fetchSolPriceButton: 'Update', statusLoading: 'Loading...', statusSuccess: 'Success!', statusError: 'Error',
                labelEnableReferrals: 'Referrals', calculate: 'Calculate',
                labelSupportAuthor: 'Support the author',
                copyButtonTitle: 'Copy address',
                copiedMessage: 'Copied!',
                paginationPrevious: 'Previous',
                paginationNext: 'Next',
                reinvestWord: 'Reinvest',
                resetButton: 'Reset All', exportButton: 'Export Data', importButton: 'Import Data',
                pFooter: 'Made by', langButtonText: 'Language EN', h3Referrals: 'Referrals', addReferral: 'Add Referral',
                thReferralNum: '№', thLevel: 'Level', thRefStakes: 'Stakes Summary', thActions: 'Actions',
                editButtonShort: 'Edit', removeButtonShort: 'Remove', noReferrals: 'No referrals added yet.', refSummaryNone: '-',
                modalTitlePrefix: 'Edit Data for Referral #', labelModalLevel: 'Level',
                labelModalStakeSol: 'Staked', labelModalProfitSol: 'Profit % / day', labelModalStakeUsdc: 'Staked', labelModalProfitUsdc: 'Profit % / day',
                saveButton: 'Save', cancelButton: 'Cancel', h2Results: 'Results', h4YourProfit: 'Your profit',
                labelProfitUserSol: 'From Your Stake:', labelProfitUserUsdc: 'From Your Stake:',
                h4ReferralProfit: 'Profit from referrals', labelProfitRefSol: 'From Referrals:', labelProfitRefUsdc: 'From Referrals:',
                h4TotalProfit: 'Total profit', labelProfitTotalSol: 'Total Profit SOL:', labelProfitTotalUsdc: 'Total Profit USDC:',
                labelProfitPercentSol: 'Profit SOL (% of initial):', labelProfitPercentUsdc: 'Profit USDC (% of initial):',
                h4DoublingTime: 'Doubling Time (100% Profit)',
                labelDoubleSolNoreinvest: 'SOL Doubling (No Reinvest):', labelDoubleUsdcNoreinvest: 'USDC Doubling (No Reinvest):',
                labelDoubleSolReinvest: 'SOL Doubling (With Reinvest):', labelDoubleUsdcReinvest: 'USDC Doubling (With Reinvest):',
                h4PeriodicTotal: 'Total Add. Investments', labelPeriodicTotalSol: 'Added Investments:', labelPeriodicTotalUsdc: 'Added Investments:',
                h4FinalBalance: 'Final Balance', labelFinalBalanceSol: 'Final Balance SOL:', labelFinalBalanceUsdc: 'Final Balance USDC:',
                labelFinalBalanceUsd: 'Total Final Balance (USD):',
                labelProfitTotalUsd: 'Total Profit (USD):',
                tooltipProfitUserSol: 'Your net profit from SOL stake after fees', tooltipProfitUserUsdc: 'Your net profit from USDC stake after fees',
                tooltipProfitRefSol: 'Your profit from referral SOL stakes', tooltipProfitRefUsdc: 'Your profit from referral USDC stakes',
                tooltipPeriodicTotalSol: 'Total additional SOL invested periodically', tooltipPeriodicTotalUsdc: 'Total additional USDC invested periodically',
                tooltipProfitTotalSol: 'Total SOL profit (yours + referrals)', tooltipProfitTotalUsdc: 'Total USDC profit (yours + referrals)',
                tooltipFinalBalanceSol: 'Initial stake + total profit + additional investments', tooltipFinalBalanceUsdc: 'Initial stake + total profit + additional investments',
                tooltipFinalBalanceUsd: 'Total final balance of SOL and USDC converted to USD', tooltipProfitTotalUsd: 'Total profit of SOL and USDC converted to USD',
                tooltipProfitPercentSol: 'Total SOL profit as a percentage of initial SOL stake', tooltipProfitPercentUsdc: 'Total USDC profit as a percentage of initial USDC stake',
                tooltipDoubleSolNoreinvest: 'Approximate days to double initial SOL stake without reinvesting profits', tooltipDoubleUsdcNoreinvest: 'Approximate days to double initial USDC stake without reinvesting profits',
                tooltipDoubleSolReinvest: 'Approximate days to double initial SOL stake with reinvesting profits', tooltipDoubleUsdcReinvest: 'Approximate days to double initial USDC stake with reinvesting profits',
                tooltipPlatformFee: 'Platform commission percentage',
                roiNever: 'Never', roiOverDays: 'Over {days} days', daysSuffix: ' days',
                invalidInputError: 'Please enter valid values for Stakes, Rates, Days, and SOL/USD Rate.',
                solUsdRateError: 'SOL/USD rate must be greater than 0 to calculate profit from USDC stakes.',
                // Converter translations
                h3ConverterTitle: 'Currency Converter',
                h3ChartTitle: 'Profitability (USD)', // Chart title
                swapButtonTitle: 'Swap currencies',
                convertStatusLoading: 'Converting...',
                convertStatusSuccess: 'Success!',
                convertStatusError: 'Error',
                convertErrorInvalidAmount: 'Invalid amount.',
                convertErrorApi: 'API Error.',
                convertErrorPairNotFound: 'Currency pair not found.', // More specific error
                convertErrorSameCurrency: 'Cannot convert to the same currency.',
                convertErrorFiatToFiat: 'Direct fiat-to-fiat conversion not supported.',
                // Result group titles
                h4SolResults: 'SOL Results', h4UsdcResults: 'USDC Results', h4GeneralResults: 'General Results'
            },
            'ru': {
                labelUserStakedSol: 'Вложено', labelUserProfitPercentSol: 'Профит % / день', labelUserStakedUsdc: 'Вложено', labelUserProfitPercentUsdc: 'Профит % / день',
                labelPlatformFee: 'Комиссия FomoFarm %', labelSolUsd: 'SOL / USD', labelDays: 'Дней',
                labelPeriodicSol: 'Довложения', labelPeriodicUsdc: 'Довложения',
                optionNo: 'Нет', optionWeekly: 'Раз в неделю', optionMonthly: 'Раз в месяц', optionQuarterly: 'Раз в 3 месяца',
                fetchSolPriceButton: 'Обновить', statusLoading: 'Загрузка...', statusSuccess: 'Успешно!', statusError: 'Ошибка',
                labelEnableReferrals: 'Рефералы', calculate: 'Рассчитать',
                labelSupportAuthor: 'Поддержать автора',
                copyButtonTitle: 'Скопировать адрес',
                copiedMessage: 'Скопировано!',
                paginationPrevious: 'Назад',
                paginationNext: 'Вперед',
                reinvestWord: 'Реинвест',
                resetButton: 'Сбросить все', exportButton: 'Экспорт', importButton: 'Импорт',
                pFooter: 'Сделано', langButtonText: 'Язык RU', h3Referrals: 'Рефералы', addReferral: 'Добавить реферала',
                thReferralNum: '№', thLevel: 'Уровень', thRefStakes: 'Сводка стейков', thActions: 'Действия',
                editButtonShort: 'Изм.', removeButtonShort: 'Удал.', noReferrals: 'Рефералы еще не добавлены.', refSummaryNone: '-',
                modalTitlePrefix: 'Изменить данные для Реферала №', labelModalLevel: 'Уровень',
                labelModalStakeSol: 'Вложено', labelModalProfitSol: 'Профит % / день', labelModalStakeUsdc: 'Вложено', labelModalProfitUsdc: 'Профит % / день',
                saveButton: 'Сохранить', cancelButton: 'Отмена', h2Results: 'Результаты', h4YourProfit: 'Ваш профит',
                labelProfitUserSol: 'От Вашего стейка:', labelProfitUserUsdc: 'От Вашего стейка:',
                h4ReferralProfit: 'Профит от рефералов', labelProfitRefSol: 'От Рефералов:', labelProfitRefUsdc: 'От Рефералов:',
                h4TotalProfit: 'Общий профит', labelProfitTotalSol: 'Общий Профит SOL:', labelProfitTotalUsdc: 'Общий Профит USDC:',
                labelProfitPercentSol: 'Профит SOL (% от нач.):', labelProfitPercentUsdc: 'Профит USDC (% от нач.):',
                h4DoublingTime: 'Время удвоения (100% Профит)',
                labelDoubleSolNoreinvest: 'Удвоение SOL (Без реинв.):', labelDoubleUsdcNoreinvest: 'Удвоение USDC (Без реинв.):',
                labelDoubleSolReinvest: 'Удвоение SOL (С реинв.):', labelDoubleUsdcReinvest: 'Удвоение USDC (С реинв.):',
                h4PeriodicTotal: 'Всего довложений', labelPeriodicTotalSol: 'Довложено:', labelPeriodicTotalUsdc: 'Довложено:',
                h4FinalBalance: 'Итоговый баланс', labelFinalBalanceSol: 'Итоговый Баланс SOL:', labelFinalBalanceUsdc: 'Итоговый Баланс USDC:',
                labelFinalBalanceUsd: 'Общий Итоговый Баланс (USD):',
                labelProfitTotalUsd: 'Общий Профит (USD):',
                tooltipProfitUserSol: 'Ваш чистый профит от стейка SOL после комиссий', tooltipProfitUserUsdc: 'Ваш чистый профит от стейка USDC после комиссий',
                tooltipProfitRefSol: 'Ваш профит от стейков SOL рефералов', tooltipProfitRefUsdc: 'Ваш профит от стейков USDC рефералов',
                tooltipPeriodicTotalSol: 'Всего дополнительно вложено SOL периодически', tooltipPeriodicTotalUsdc: 'Всего дополнительно вложено USDC периодически',
                tooltipProfitTotalSol: 'Общий профит SOL (ваш + рефералов)', tooltipProfitTotalUsdc: 'Общий профит USDC (ваш + рефералов)',
                tooltipFinalBalanceSol: 'Начальный стейк + общий профит + довложения', tooltipFinalBalanceUsdc: 'Начальный стейк + общий профит + довложения',
                tooltipFinalBalanceUsd: 'Общий итоговый баланс SOL и USDC, конвертированный в USD', tooltipProfitTotalUsd: 'Общий профит SOL и USDC, конвертированный в USD',
                tooltipProfitPercentSol: 'Общий профит SOL в процентах от начального стейка SOL', tooltipProfitPercentUsdc: 'Общий профит USDC в процентах от начального стейка USDC',
                tooltipDoubleSolNoreinvest: 'Примерное кол-во дней для удвоения нач. стейка SOL без реинвестирования', tooltipDoubleUsdcNoreinvest: 'Примерное кол-во дней для удвоения нач. стейка USDC без реинвестирования',
                tooltipDoubleSolReinvest: 'Примерное кол-во дней для удвоения нач. стейка SOL с реинвестированием', tooltipDoubleUsdcReinvest: 'Примерное кол-во дней для удвоения нач. стейка USDC с реинвестированием',
                tooltipPlatformFee: 'Процент комиссии платформы',
                roiNever: 'Никогда', roiOverDays: 'Более {days} дн.', daysSuffix: ' дн.',
                invalidInputError: 'Пожалуйста, введите корректные значения для Стейков, Процентов, Дней и Курса SOL/USD.',
                solUsdRateError: 'Курс SOL/USD должен быть больше 0 для расчета дохода со стейков в USDC.',
                // Converter translations
                h3ConverterTitle: 'Конвертер Валют',
                h3ChartTitle: 'График Доходности (USD)', // Chart title
                swapButtonTitle: 'Поменять валюты',
                convertStatusLoading: 'Конвертация...',
                convertStatusSuccess: 'Успешно!',
                convertStatusError: 'Ошибка',
                convertErrorInvalidAmount: 'Неверная сумма.',
                convertErrorApi: 'Ошибка API.',
                convertErrorPairNotFound: 'Валютная пара не найдена.',
                convertErrorSameCurrency: 'Нельзя конвертировать в ту же валюту.',
                convertErrorFiatToFiat: 'Прямая конвертация фиат-фиат не поддерживается.',
                 // Result group titles
                h4SolResults: 'Результаты SOL', h4UsdcResults: 'Результаты USDC', h4GeneralResults: 'Общие Результаты'
            }
        };

        // --- Data Persistence Functions (localStorage) ---
        /**
         * Сохраняет текущие данные калькулятора в localStorage.
         */
        function saveData() {
             try {
                const data = {
                    userStakedSolAmount: domElements.userStakedSolAmount.value, userProfitPercentSol: domElements.userProfitPercentSol.value,
                    userStakedUsdcAmount: domElements.userStakedUsdcAmount.value, userProfitPercentUsdc: domElements.userProfitPercentUsdc.value,
                    platformFee: domElements.platformFee.value, solToUsd: domElements.solToUsd.value, days: domElements.days.value,
                    periodicSolAmount: domElements.periodicSolAmount.value, periodicSolPeriod: domElements.periodicSolPeriod.value,
                    periodicUsdcAmount: domElements.periodicUsdcAmount.value, periodicUsdcPeriod: domElements.periodicUsdcPeriod.value,
                    reinvestSol: domElements.reinvestSolCheckbox.checked.toString(),
                    reinvestSolPercent: domElements.reinvestSolPercent.value,
                    reinvestUsdc: domElements.reinvestUsdcCheckbox.checked.toString(),
                    reinvestUsdcPercent: domElements.reinvestUsdcPercent.value,
                    includeReferrals: domElements.includeReferralsCheckbox.checked.toString(),
                    referralsData: JSON.stringify(referralsData || []), nextReferralId: nextReferralId,
                    // Save collapsible states
                    referralsCollapsed: domElements.referralsSection?.classList.contains('collapsed').toString() || 'false',
                    chartCollapsed: domElements.chartSection?.classList.contains('collapsed').toString() || 'false',
                    converterCollapsed: domElements.converterSection?.classList.contains('collapsed').toString() || 'false'
                };
                for (const [key, value] of Object.entries(data)) { localStorage.setItem(`fomoFarmCalc_${key}`, value); }
            } catch (error) { console.error("Ошибка сохранения данных в localStorage:", error); }
        }

        /**
         * Загружает данные калькулятора из localStorage при инициализации.
         */
        function loadData() {
             try {
                domElements.userStakedSolAmount.value = localStorage.getItem('fomoFarmCalc_userStakedSolAmount') || '0';
                domElements.userProfitPercentSol.value = localStorage.getItem('fomoFarmCalc_userProfitPercentSol') || '0';
                domElements.userStakedUsdcAmount.value = localStorage.getItem('fomoFarmCalc_userStakedUsdcAmount') || '0';
                domElements.userProfitPercentUsdc.value = localStorage.getItem('fomoFarmCalc_userProfitPercentUsdc') || '0';
                domElements.platformFee.value = localStorage.getItem('fomoFarmCalc_platformFee') || '10';
                domElements.solToUsd.value = localStorage.getItem('fomoFarmCalc_solToUsd') || '0';
                domElements.days.value = localStorage.getItem('fomoFarmCalc_days') || '0';
                domElements.reinvestSolCheckbox.checked = (localStorage.getItem('fomoFarmCalc_reinvestSol') || 'true') === 'true';
                domElements.reinvestSolPercent.value = localStorage.getItem('fomoFarmCalc_reinvestSolPercent') || '100';
                domElements.reinvestUsdcCheckbox.checked = (localStorage.getItem('fomoFarmCalc_reinvestUsdc') || 'true') === 'true';
                domElements.reinvestUsdcPercent.value = localStorage.getItem('fomoFarmCalc_reinvestUsdcPercent') || '100';
                domElements.includeReferralsCheckbox.checked = (localStorage.getItem('fomoFarmCalc_includeReferrals') || 'true') === 'true';
                domElements.periodicSolAmount.value = localStorage.getItem('fomoFarmCalc_periodicSolAmount') || '0';
                domElements.periodicSolPeriod.value = localStorage.getItem('fomoFarmCalc_periodicSolPeriod') || '0';
                domElements.periodicUsdcAmount.value = localStorage.getItem('fomoFarmCalc_periodicUsdcAmount') || '0';
                domElements.periodicUsdcPeriod.value = localStorage.getItem('fomoFarmCalc_periodicUsdcPeriod') || '0';

                // Toggle reinvest percentage input visibility based on checkbox state
                toggleReinvestControls(domElements.reinvestSolCheckbox);
                toggleReinvestControls(domElements.reinvestUsdcCheckbox);

                const savedReferrals = localStorage.getItem('fomoFarmCalc_referralsData');
                referralsData = savedReferrals ? JSON.parse(savedReferrals) : [];
                if (!Array.isArray(referralsData)) { referralsData = []; }
                referralsData = referralsData.filter(ref => typeof ref === 'object' && ref !== null && ref.hasOwnProperty('id'));
                referralsData.forEach(ref => {
                     ref.stakedSol = ref.stakedSol || 0; ref.profitPercentSol = ref.profitPercentSol || 0;
                     ref.stakedUsdc = ref.stakedUsdc || 0; ref.profitPercentUsdc = ref.profitPercentUsdc || 0;
                     ref.level = ref.level || 1;
                });

                const savedNextId = parseInt(localStorage.getItem('fomoFarmCalc_nextReferralId'));
                if (referralsData.length > 0) {
                    const maxId = referralsData.reduce((max, ref) => Math.max(max, ref.id || 0), 0);
                    nextReferralId = Math.max(maxId + 1, savedNextId || 1);
                } else {
                    nextReferralId = savedNextId || 1;
                }

                // Restore collapsible states
                const referralsCollapsed = localStorage.getItem('fomoFarmCalc_referralsCollapsed') === 'true';
                const chartCollapsed = localStorage.getItem('fomoFarmCalc_chartCollapsed') === 'true';
                const converterCollapsed = localStorage.getItem('fomoFarmCalc_converterCollapsed') === 'true';

                if (domElements.referralsSection && referralsCollapsed) domElements.referralsSection.classList.add('collapsed');
                if (domElements.chartSection && chartCollapsed) domElements.chartSection.classList.add('collapsed');
                if (domElements.converterSection && converterCollapsed) domElements.converterSection.classList.add('collapsed');
                currentPage = 1;

            } catch (error) {
                console.error("Ошибка загрузки данных из localStorage:", error);
                referralsData = [];
                nextReferralId = 1;
            }
         }

// --- UI Update Functions ---
        /**
         * Обновляет тексты и иконки в интерфейсе в соответствии с выбранным языком.
         * @param {string} lang - Код языка ('en' или 'ru').
         */
// --- UI Update Functions ---
        /**
         * Обновляет тексты и иконки в интерфейсе в соответствии с выбранным языком.
         * @param {string} lang - Код языка ('en' или 'ru').
         */
         function updateUI(lang) {
            currentLanguage = lang;
            const trans = translations[lang];
            document.documentElement.lang = lang === 'ru' ? 'ru' : 'en';

            const idToKeyMap = {
                'label-user-staked-sol': 'labelUserStakedSol', 'label-user-profit-percent-sol': 'labelUserProfitPercentSol',
                'label-user-staked-usdc': 'labelUserStakedUsdc', 'label-user-profit-percent-usdc': 'labelUserProfitPercentUsdc',
                'label-platform-fee': 'labelPlatformFee', 'label-sol-usd': 'labelSolUsd', 'label-days': 'labelDays',
                'label-periodic-sol': 'labelPeriodicSol', 'label-periodic-usdc': 'labelPeriodicUsdc',
                'label-enable-referrals': 'labelEnableReferrals',
                'addReferralButton': 'addReferral', 'th-referral-num': 'thReferralNum',
                'th-level': 'thLevel', 'th-ref-stakes': 'thRefStakes', 'th-actions': 'thActions',
                'calculateButton': 'calculate', 'resetButton': 'resetButton', 'exportButton': 'exportButton', 'importButton': 'importButton',
                'h2-results': 'h2Results',
                'label-profit-user-sol': 'labelProfitUserSol', 'label-profit-user-usdc': 'labelProfitUserUsdc',
                'label-profit-ref-sol': 'labelProfitRefSol', 'label-profit-ref-usdc': 'labelProfitRefUsdc',
                'label-profit-total-sol': 'labelProfitTotalSol', 'label-profit-total-usdc': 'labelProfitTotalUsdc',
                'label-profit-percent-sol': 'labelProfitPercentSol', 'label-profit-percent-usdc': 'labelProfitPercentUsdc',
                'label-support-author': 'labelSupportAuthor',
                'copyWalletButton': 'copyButtonTitle',
                'label-double-sol-noreinvest': 'labelDoubleSolNoreinvest', 'label-double-usdc-noreinvest': 'labelDoubleUsdcNoreinvest',
                'label-double-sol-reinvest': 'labelDoubleSolReinvest', 'label-double-usdc-reinvest': 'labelDoubleUsdcReinvest',
                'label-periodic-total-sol': 'labelPeriodicTotalSol', 'label-periodic-total-usdc': 'labelPeriodicTotalUsdc',
                'label-final-balance-sol': 'labelFinalBalanceSol', 'label-final-balance-usdc': 'labelFinalBalanceUsdc',
                'label-final-balance-usd': 'labelFinalBalanceUsd', 'label-profit-total-usd': 'labelProfitTotalUsd',
                'label-modal-level': 'labelModalLevel', 'label-modal-stake-sol': 'labelModalStakeSol', 'label-modal-profit-sol': 'labelModalProfitSol',
                'label-modal-stake-usdc': 'labelModalStakeUsdc', 'label-modal-profit-usdc': 'labelModalProfitUsdc',
                'saveReferralButton': 'saveButton', 'cancelReferralButton': 'cancelButton',
                'languageToggleButton': 'langButtonText',
                'option-sol-none': 'optionNo', 'option-sol-weekly': 'optionWeekly', 'option-sol-monthly': 'optionMonthly', 'option-sol-quarterly': 'optionQuarterly',
                'option-usdc-none': 'optionNo', 'option-usdc-weekly': 'optionWeekly', 'option-usdc-monthly': 'optionMonthly', 'option-usdc-quarterly': 'optionQuarterly',
                'fetchSolPriceButton': 'fetchSolPriceButton',
                'tooltip-profit-sol': 'tooltipProfitSol', 'tooltip-profit-usdc': 'tooltipProfitUsdc', 'tooltip-platform-fee': 'tooltipPlatformFee',
                'h3-converter-title': 'h3ConverterTitle', 'h3-chart-title': 'h3ChartTitle', 'h3-referrals-text': 'h3Referrals',
                'swapCurrenciesButton': 'swapButtonTitle',
                'tooltip-profit-user-sol': 'tooltipProfitUserSol', 'tooltip-profit-user-usdc': 'tooltipProfitUserUsdc',
                'tooltip-profit-ref-sol': 'tooltipProfitRefSol', 'tooltip-profit-ref-usdc': 'tooltipProfitRefUsdc',
                'tooltip-periodic-total-sol': 'tooltipPeriodicTotalSol', 'tooltip-periodic-total-usdc': 'tooltipPeriodicTotalUsdc',
                'tooltip-profit-total-sol': 'tooltipProfitTotalSol', 'tooltip-profit-total-usdc': 'tooltipProfitTotalUsdc',
                'tooltip-final-balance-sol': 'tooltipFinalBalanceSol', 'tooltip-final-balance-usdc': 'tooltipFinalBalanceUsdc',
                'tooltip-final-balance-usd': 'tooltipFinalBalanceUsd', 'tooltip-profit-total-usd': 'tooltipProfitTotalUsd',
                'tooltip-profit-percent-sol': 'tooltipProfitPercentSol', 'tooltip-profit-percent-usdc': 'tooltipProfitPercentUsdc',
                'tooltip-double-sol-noreinvest': 'tooltipDoubleSolNoreinvest', 'tooltip-double-usdc-noreinvest': 'tooltipDoubleUsdcNoreinvest',
                'tooltip-double-sol-reinvest': 'tooltipDoubleSolReinvest', 'tooltip-double-usdc-reinvest': 'tooltipDoubleUsdcReinvest',
                'h4-sol-results': 'h4SolResults', 'h4-usdc-results': 'h4UsdcResults', 'h4-general-results': 'h4GeneralResults'
            };

            const currencyIconConfig = {
                'labelUserStakedSol': { html: solanaIconImg, class: 'currency-icon-sol' },
                'labelUserStakedUsdc': { html: usdcIconImg, class: 'currency-icon-usdc' },
                'labelUserProfitPercentSol': { html: solanaIconImg, class: 'currency-icon-sol' },
                'labelUserProfitPercentUsdc': { html: usdcIconImg, class: 'currency-icon-usdc' },
                'labelPeriodicSol': { html: solanaIconImg, class: 'currency-icon-sol' },
                'labelPeriodicUsdc': { html: usdcIconImg, class: 'currency-icon-usdc' },
                'labelModalStakeSol': { html: solanaIconImg, class: 'currency-icon-sol' },
                'labelModalProfitSol': { html: solanaIconImg, class: 'currency-icon-sol' },
                'labelModalStakeUsdc': { html: usdcIconImg, class: 'currency-icon-usdc' },
                'labelModalProfitUsdc': { html: usdcIconImg, class: 'currency-icon-usdc' }
            };

            for (const id in idToKeyMap) {
                const elementIdCamelCase = id.replace(/-([a-z])/g, g => g[1].toUpperCase());
                const element = domElements[elementIdCamelCase] || document.getElementById(id);
                const translationKey = idToKeyMap[id];

                if (element && trans[translationKey] !== undefined) {
                    const translatedText = trans[translationKey];
                    const isLabelTag = element.tagName === 'LABEL';
                    const isSpanLabel = element.tagName === 'SPAN' && element.classList.contains('label');

                    if (isLabelTag || isSpanLabel) {
                        const existingTooltipContainer = element.querySelector('.tooltip-container');
                        if (existingTooltipContainer) {
                            existingTooltipContainer.remove();
                        }
                        if (isLabelTag) {
                            const oldCurrencyIcon = element.querySelector('img.currency-icon-sol, img.currency-icon-usdc');
                            if (oldCurrencyIcon) {
                                oldCurrencyIcon.remove();
                            }
                        }
                        element.textContent = translatedText.trim() + ' ';
                        if (isLabelTag) {
                            const iconInfo = currencyIconConfig[elementIdCamelCase];
                            if (iconInfo) {
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = iconInfo.html.trim();
                                const newCurrencyIconElement = tempDiv.firstChild;
                                if (newCurrencyIconElement) {
                                    newCurrencyIconElement.classList.add(iconInfo.class);
                                    element.appendChild(newCurrencyIconElement);
                                    if (existingTooltipContainer) { // Добавляем пробел только если есть иконка И будет тултип
                                        element.appendChild(document.createTextNode(' '));
                                    }
                                }
                            }
                        }
                        if (existingTooltipContainer) {
                            element.appendChild(existingTooltipContainer);
                        }
                    } else if (element.classList.contains('tooltip-text')) {
                        element.textContent = translatedText;
                    } else if (element.tagName === 'OPTION') {
                        element.textContent = translatedText;
                    } else if (id === 'p-footer') {
                        const firstChild = element.childNodes[0];
                        if (firstChild && firstChild.nodeType === Node.TEXT_NODE) {
                            firstChild.nodeValue = translatedText + ' ';
                        } else {
                            element.prepend(document.createTextNode(translatedText + ' '));
                        }
                    } else if (id === 'swapCurrenciesButton' || id === 'copyWalletButton' || element.id === 'languageToggleButton') {
                        if (element.id === 'languageToggleButton') {
                            element.textContent = translatedText;
                        } else {
                            element.title = translatedText;
                        }
                    } else {
                        element.textContent = translatedText;
                    }
                } else if (element && id === 'p-footer' && trans.pFooter) {
                    const firstChild = element.childNodes[0];
                    if (!firstChild || firstChild.nodeType !== Node.TEXT_NODE) {
                        element.prepend(document.createTextNode(' '));
                    }
                    element.childNodes[0].nodeValue = (trans.pFooter || 'Made by') + ' ';
                }
            }

            // ОТДЕЛЬНАЯ ОБРАБОТКА ЛЕЙБЛОВ ДЛЯ РЕИНВЕСТА (SOL и USDC)
            const reinvestText = trans.reinvestWord || 'Reinvest';

            const labelReinvestSol = domElements.labelReinvestSol; // Убедись, что 'labelReinvestSol' есть в domElements
            if (labelReinvestSol) {
                labelReinvestSol.innerHTML = `${reinvestText} ${solanaIconImg}`;
                const imgInSolLabel = labelReinvestSol.querySelector('img');
                if (imgInSolLabel) { // Применяем стили для выравнивания и отступа иконки
                    imgInSolLabel.style.verticalAlign = 'middle';
                    imgInSolLabel.style.marginLeft = '4px';
                }
            }

            const labelReinvestUsdc = domElements.labelReinvestUsdc; // Убедись, что 'labelReinvestUsdc' есть в domElements
            if (labelReinvestUsdc) {
                labelReinvestUsdc.innerHTML = `${reinvestText} ${usdcIconImg}`;
                const imgInUsdcLabel = labelReinvestUsdc.querySelector('img');
                if (imgInUsdcLabel) { // Применяем стили для выравнивания и отступа иконки
                    imgInUsdcLabel.style.verticalAlign = 'middle';
                    imgInUsdcLabel.style.marginLeft = '4px';
                }
            }

            // Сброс статусов
            if (domElements.solPriceStatus) { domElements.solPriceStatus.textContent = ''; domElements.solPriceStatus.className = ''; }
            if (domElements.converterStatus) { domElements.converterStatus.textContent = ''; domElements.converterStatus.className = ''; }
            if (domElements.convertResultAmount) { domElements.convertResultAmount.value = ''; }

            renderReferralsTable();
            updateSortIcons();
        }

        /**
         * Переключает язык интерфейса между 'en' и 'ru'.
         */
        function toggleLanguage() {
            const newLang = currentLanguage === 'en' ? 'ru' : 'en';
            localStorage.setItem('fomoFarmCalc_language', newLang);
            updateUI(newLang);
            triggerConversion();
         }

        // --- Referral Management Functions ---
        /**
         * Добавляет нового реферала в список.
         */
        function addReferral() {
            const newId = nextReferralId++;
            const newReferral = { id: newId, level: 1, stakedSol: 0, profitPercentSol: 0, stakedUsdc: 0, profitPercentUsdc: 0 };
            referralsData.push(newReferral);
            changePage(Math.ceil(referralsData.length / itemsPerPage) || 1); // Перейти на последнюю страницу
            saveData();
        }

        /**
         * Удаляет реферала из списка по его ID.
         */
        function removeReferral(referralIdToRemove) {
            referralsData = referralsData.filter(ref => ref.id !== referralIdToRemove);
            const totalPages = Math.ceil(referralsData.length / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) {
                changePage(totalPages); // Переходим на последнюю существующую
            } else {
                renderReferralsTable(); // Просто перерисовываем текущую или первую, если данных нет
            }
            saveData();
        }

        /**
         * Sorts the referralsData array and re-renders the table.
         * @param {string} sortKey - The key to sort by ('level' or 'stakes').
         */
        function sortReferrals(sortKey) {
             const isAscending = currentSortKey === sortKey && currentSortOrder === 'asc';
             currentSortOrder = isAscending ? 'desc' : 'asc';
             currentSortKey = sortKey;

             referralsData.sort((a, b) => {
                 let valA, valB;
                 if (sortKey === 'level') {
                     valA = a.level || 0;
                     valB = b.level || 0;
                 } else if (sortKey === 'stakes') {
                     // Approximate total stake value in USD for sorting (assuming SOL price is available)
                     const solPrice = parseFloat(domElements.solToUsd.value) || 0;
                     valA = (a.stakedSol || 0) * solPrice + (a.stakedUsdc || 0);
                     valB = (b.stakedSol || 0) * solPrice + (b.stakedUsdc || 0);
                 } else {
                     return 0; // No sorting if key is unknown
                 }

                 if (valA < valB) return currentSortOrder === 'asc' ? -1 : 1;
                 if (valA > valB) return currentSortOrder === 'asc' ? 1 : -1;
                 return 0;
             });

            changePage(1); // Сбрасываем на первую страницу после сортировки
            updateSortIcons();
            // saveData() не нужно, т.к. сортировка не меняет данные для сохранения
        }

        /**
         * Updates the sort icons in the table headers.
         */
        function updateSortIcons() {
             document.querySelectorAll('#referralsTable th.sortable .sort-icon').forEach(icon => {
                 icon.className = 'sort-icon fas'; // Reset icon
             });
             const activeHeader = document.querySelector(`#referralsTable th[data-sort-key="${currentSortKey}"] .sort-icon`);
             if (activeHeader) {
                 activeHeader.classList.add(currentSortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
             }
        }


        /**
         * Обновляет отображение таблицы рефералов.
         */
        /**
         * Обновляет отображение таблицы рефералов с учетом пагинации.
         */
         function renderReferralsTable() {
            const referralsListBody = domElements.referralsList; // Use cache
            if (!referralsListBody) return;
            referralsListBody.innerHTML = '';
            const trans = translations[currentLanguage];

            // --- Логика пагинации ---
            const totalItems = referralsData.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            // Убедимся, что текущая страница не выходит за пределы после удаления/сортировки
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0) {
                currentPage = 1; // Если нет данных, страница 1
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedReferrals = referralsData.slice(startIndex, endIndex);
            // --- Конец логики пагинации ---

            if (totalItems === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align:center; color:#6b7280;">${trans.noReferrals}</td>`;
                referralsListBody.appendChild(row);
            } else {
                // Используем paginatedReferrals для отображения
                paginatedReferrals.forEach((referral, index) => { // index здесь от 0 до itemsPerPage-1
                    const row = document.createElement('tr');
                    const numCell = document.createElement('td');
                    // Рассчитываем правильный номер для текущей страницы
                    numCell.textContent = startIndex + index + 1;

                    const levelCell = document.createElement('td');
                    levelCell.textContent = referral.level || 1;

                    const summaryCell = document.createElement('td');
                    summaryCell.className = 'stakes-summary';
                    let summaryContent = [];
                    if (referral.stakedSol > 0) { summaryContent.push(`<span>${solanaIconImg}${formatDisplayNumberCustom(referral.stakedSol, 5)}</span>`); }
                    if (referral.stakedUsdc > 0) { summaryContent.push(`<span>${usdcIconImg}${formatDisplayNumberCustom(referral.stakedUsdc, 2)}</span>`); }
                    summaryCell.innerHTML = summaryContent.length > 0 ? summaryContent.join(' ') : trans.refSummaryNone;

                    const actionCell = document.createElement('td');
                    actionCell.className = 'actions-cell';
                    const editButton = document.createElement('button');
                    editButton.textContent = trans.editButtonShort;
                    editButton.className = 'action-button edit-button';
                    editButton.onclick = () => openEditModal(referral.id);
                    const removeButton = document.createElement('button');
                    removeButton.textContent = trans.removeButtonShort;
                    removeButton.className = 'action-button remove-button';
                    removeButton.onclick = () => removeReferral(referral.id);
                    actionCell.appendChild(editButton);
                    actionCell.appendChild(removeButton);

                    row.appendChild(numCell);
                    row.appendChild(levelCell);
                    row.appendChild(summaryCell);
                    row.appendChild(actionCell);
                    referralsListBody.appendChild(row);
                });
            }

            // Рендерим кнопки пагинации
            renderPaginationControls(totalPages);
        }

        /**
         * Рендерит кнопки управления пагинацией.
         * @param {number} totalPages - Общее количество страниц.
         */
         function renderPaginationControls(totalPages) {
            const paginationContainer = document.getElementById('paginationControls');
            if (!paginationContainer) return;
            paginationContainer.innerHTML = ''; // Очищаем старые кнопки
            const trans = translations[currentLanguage];

            if (totalPages <= 1) return; // Не показываем пагинацию, если 1 или 0 страниц

            // Кнопка "Назад"
            const prevButton = document.createElement('button');
            prevButton.textContent = trans.paginationPrevious;
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => changePage(currentPage - 1);
            paginationContainer.appendChild(prevButton);

            // Кнопки с номерами страниц (можно добавить логику для сокращения, если страниц много)
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                pageButton.onclick = () => changePage(i);
                paginationContainer.appendChild(pageButton);
            }

            // Кнопка "Вперед"
            const nextButton = document.createElement('button');
            nextButton.textContent = trans.paginationNext;
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => changePage(currentPage + 1);
            paginationContainer.appendChild(nextButton);
        }

        /**
         * Изменяет текущую страницу и перерисовывает таблицу.
         * @param {number} newPage - Номер страницы, на которую нужно перейти.
         */
         function changePage(newPage) {
            const totalItems = referralsData.length;
            // Убедимся, что totalPages всегда хотя бы 1, даже если рефералов нет
            const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;

            // Проверка границ - убедимся, что newPage находится в допустимом диапазоне
            if (newPage < 1) {
                newPage = 1;
            } else if (newPage > totalPages) {
                newPage = totalPages;
            }

            // Устанавливаем текущую страницу
            currentPage = newPage;

            // Всегда перерисовываем таблицу и пагинацию после установки страницы
            renderReferralsTable();

            // Опционально: сохранение текущей страницы
            // saveData(); // Раскомментируйте, если хотите сохранять номер страницы
        }

        // --- Modal Management Functions ---
        /**
         * Открывает модальное окно для редактирования данных реферала.
         */
        function openEditModal(referralId) {
            const modal = domElements.editReferralModal; // Use cache
            const modalTitle = domElements.modalTitle; // Use cache
            const editingIdInput = domElements.editingReferralId; // Use cache
            const trans = translations[currentLanguage];
            const referral = referralsData.find(ref => ref.id === referralId);

            if (!referral || !modal || !modalTitle || !editingIdInput) return;

            // Find the current visual index for the title display
            const visualIndex = referralsData.findIndex(ref => ref.id === referralId) + 1;
            modalTitle.textContent = `${trans.modalTitlePrefix}${visualIndex}`; // Show visual index in title

            editingIdInput.value = referral.id; // Store the actual ID
            domElements.modalLevel.value = referral.level || 1;
            domElements.modalStakeSol.value = referral.stakedSol || 0;
            domElements.modalProfitSol.value = referral.profitPercentSol || 0;
            domElements.modalStakeUsdc.value = referral.stakedUsdc || 0;
            domElements.modalProfitUsdc.value = referral.profitPercentUsdc || 0;

            // Update labels (using cached elements)
            const modalLabels = [
                domElements.labelModalLevel, domElements.labelModalStakeSol, domElements.labelModalProfitSol,
                domElements.labelModalStakeUsdc, domElements.labelModalProfitUsdc
            ];
            const modalIcons = [null, solanaIconImg, solanaIconImg, usdcIconImg, usdcIconImg]; // null for level

            modalLabels.forEach((label, index) => {
                if (label) {
                    const icon = label.querySelector('img');
                    if (icon) label.removeChild(icon);
                    const key = label.id.replace('label-', '').replace(/-/g, '_');
                    if (trans[key]) label.textContent = trans[key];
                    if (modalIcons[index]) label.innerHTML += modalIcons[index];
                }
            });

            modal.style.display = 'flex';
         }

        /**
         * Закрывает модальное окно редактирования реферала.
         */
        function closeEditModal() {
            if (domElements.editReferralModal) { domElements.editReferralModal.style.display = 'none'; }
            if (domElements.editingReferralId) { domElements.editingReferralId.value = ''; }
        }

        /**
         * Сохраняет измененные данные реферала из модального окна.
         */
        function saveReferralData() {
            const editingId = parseInt(domElements.editingReferralId.value); // Use cache
            if (isNaN(editingId)) return;
            const referralIndex = referralsData.findIndex(ref => ref.id === editingId);
            if (referralIndex === -1) return;

            const newLevel = parseInt(domElements.modalLevel.value) || 1; // Use cache
            const newStakeSol = parseFloat(domElements.modalStakeSol.value) || 0; // Use cache
            const newProfitSol = parseFloat(domElements.modalProfitSol.value) || 0; // Use cache
            const newStakeUsdc = parseFloat(domElements.modalStakeUsdc.value) || 0; // Use cache
            const newProfitUsdc = parseFloat(domElements.modalProfitUsdc.value) || 0; // Use cache

            referralsData[referralIndex].level = (newLevel >= 1 && newLevel <= 7) ? newLevel : 1;
            referralsData[referralIndex].stakedSol = newStakeSol >= 0 ? newStakeSol : 0;
            referralsData[referralIndex].profitPercentSol = newProfitSol >= 0 ? newProfitSol : 0;
            referralsData[referralIndex].stakedUsdc = newStakeUsdc >= 0 ? newStakeUsdc : 0;
            referralsData[referralIndex].profitPercentUsdc = newProfitUsdc >= 0 ? newProfitUsdc : 0;

            saveData();
            renderReferralsTable();
            closeEditModal();
        }

        // --- Formatting Function ---
        /**
         * Formats a number for display with custom separators (space for thousands, comma for decimal).
         * @param {number} number - The number to format.
         * @param {number} maximumFractionDigits - Maximum decimal places.
         * @returns {string} Formatted number string.
         */
        function formatDisplayNumberCustom(number, maximumFractionDigits) {
            if (isNaN(number) || number === null) return '';

            // Determine the minimum fraction digits based on maximum
            const minimumFractionDigits = maximumFractionDigits < 2 ? maximumFractionDigits : 2;

            // 1. Get the number with fixed decimal places (using dot as separator)
            let numStr = number.toFixed(maximumFractionDigits);

            // Ensure minimum fractional digits are present after toFixed
            let parts = numStr.split('.');
            let integerPart = parts[0];
            let fractionalPart = parts.length > 1 ? parts[1] : '';

            // Pad with zeros if needed (e.g., for fiat 1 -> 1.00)
            if (fractionalPart.length < minimumFractionDigits) {
                fractionalPart = fractionalPart.padEnd(minimumFractionDigits, '0');
            }
             // No need to trim here as toFixed already handles max digits

            // 3. Add space as thousands separator to the integer part
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');

            // 4. Combine parts with a comma as decimal separator
            return fractionalPart ? `${integerPart},${fractionalPart}` : integerPart;
        }


        // --- Fetch SOL Price Function ---
        /**
         * Загружает текущую цену SOL/USD с CoinGecko API.
         */
        async function fetchSolPrice() {
            const apiUrl = 'https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd';
            const solInput = domElements.solToUsd; // Use cache
            const statusElement = domElements.solPriceStatus; // Use cache
            const trans = translations[currentLanguage];

            if (!solInput || !statusElement) return;

            statusElement.textContent = trans.statusLoading;
            statusElement.className = 'loading';

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const data = await response.json();
                if (data && data.solana && data.solana.usd) {
                    const price = data.solana.usd;
                    solInput.value = price.toFixed(2);
                    statusElement.textContent = trans.statusSuccess;
                    statusElement.className = 'success';
                    saveData();
                } else {
                    throw new Error('Invalid API response structure');
                }
            } catch (error) {
                console.error('Ошибка загрузки цены SOL:', error);
                statusElement.textContent = trans.statusError;
                statusElement.className = 'error';
            } finally {
                 setTimeout(() => {
                     if (statusElement.className !== 'loading') {
                         statusElement.textContent = '';
                         statusElement.className = '';
                     }
                 }, 3000);
            }
        }

        // --- Calculation Logic ---
        /**
         * Выполняет основные расчеты калькулятора.
         */
        // --- Calculation Logic ---
        /**
         * Выполняет основные расчеты калькулятора.
         */
         function calculate() {
            console.log("Calculate function called!");
            // --- Validation ---
            let isValid = true;
            // ВАЖНО: Убедись, что domElements.reinvestSolPercent и domElements.reinvestUsdcPercent существуют
            // и правильно кэшируются в setupEventListeners, если будешь их валидировать здесь.
            // Пока что валидация для reinvestPercent оставлена общей, но она должна быть для reinvestSolPercent и reinvestUsdcPercent.
            // Для простоты, пока уберем ее из этого массива и будем получать значения ниже.
            const inputsToValidate = [
                { element: domElements.userStakedSolAmount, positive: false }, { element: domElements.userProfitPercentSol, positive: false },
                { element: domElements.userStakedUsdcAmount, positive: false }, { element: domElements.userProfitPercentUsdc, positive: false },
                { element: domElements.days, positive: true }, { element: domElements.solToUsd, positive: false }, // SOL/USD может быть 0, если нет USDC стейков/профита
                { element: domElements.platformFee, positive: false },
                { element: domElements.periodicSolAmount, positive: false }, { element: domElements.periodicUsdcAmount, positive: false },
                // Убрали { element: domElements.reinvestPercent, ... } так как теперь это reinvestSolPercent и reinvestUsdcPercent
                // Валидацию для них нужно будет добавить, если необходимо, или положиться на min/max в HTML.
            ];
            const trans = translations[currentLanguage];
            clearAllValidationErrors();

            inputsToValidate.forEach(item => {
                const inputElement = item.element;
                if (!inputElement) {
                    console.warn(`Validation: Element not found in domElements for ID (or equivalent key): ${item.id || 'unknown'}`);
                    return;
                }
                const value = parseFloat(inputElement.value);
                let fieldInvalid = isNaN(value) || (!item.positive && value < 0) || (item.positive && value <= 0);
                
                // Отдельная проверка для процентов реинвеста, если они будут добавлены в inputsToValidate
                // if (inputElement.id === 'reinvestSolPercent' || inputElement.id === 'reinvestUsdcPercent') {
                // if (value < 0 || value > 100) fieldInvalid = true;
                // }

                if (fieldInvalid) {
                    isValid = false;
                    inputElement.classList.add('input-error');
                }
            });
            
            // Валидация процентов реинвеста (если они видимы)
            [domElements.reinvestSolPercent, domElements.reinvestUsdcPercent].forEach(percentInput => {
                if (percentInput && percentInput.style.display !== 'none') { // Проверяем только если поле видимо
                    const value = parseFloat(percentInput.value);
                    if (isNaN(value) || value < 0 || value > 100) {
                        isValid = false;
                        percentInput.classList.add('input-error');
                    }
                }
            });


            const needsSolUsdRate = (parseFloat(domElements.userStakedUsdcAmount.value) > 0 || parseFloat(domElements.periodicUsdcAmount.value) > 0 || referralsData.some(ref => (ref.stakedUsdc || 0) > 0));
            const solToUsdInput = domElements.solToUsd;
            const solToUsdValue = parseFloat(solToUsdInput.value);

            if (needsSolUsdRate && (isNaN(solToUsdValue) || solToUsdValue <= 0)) {
                 isValid = false;
                 solToUsdInput.classList.add('input-error');
            }

            if (!isValid) {
                console.log("Calculation stopped due to invalid input.");
                clearResults(trans.invalidInputError); // Передаем сообщение об ошибке
                if (balanceChartInstance) { balanceChartInstance.destroy(); balanceChartInstance = null; }
                return;
            }
            // --- End Validation ---

            // Get values from DOM elements
            const platformFeeRate = (parseFloat(domElements.platformFee.value) || 0) / 100;
            const days = parseInt(domElements.days.value);
            
            const reinvestSolEnabled = domElements.reinvestSolCheckbox.checked;
            const reinvestSolPercentValue = reinvestSolEnabled ? (parseFloat(domElements.reinvestSolPercent.value) || 0) / 100 : 0;
            const reinvestUsdcEnabled = domElements.reinvestUsdcCheckbox.checked;
            const reinvestUsdcPercentValue = reinvestUsdcEnabled ? (parseFloat(domElements.reinvestUsdcPercent.value) || 0) / 100 : 0;
            
            const referralsEnabled = domElements.includeReferralsCheckbox.checked;
            const initialUserStakedSol = parseFloat(domElements.userStakedSolAmount.value) || 0;
            const userProfitRateSol = (parseFloat(domElements.userProfitPercentSol.value) || 0) / 100;
            const initialUserStakedUsdc = parseFloat(domElements.userStakedUsdcAmount.value) || 0;
            const userProfitRateUsdc = (parseFloat(domElements.userProfitPercentUsdc.value) || 0) / 100;
            const periodicSolAmountVal = parseFloat(domElements.periodicSolAmount.value) || 0; // Используем Val для консистентности
            const periodicSolPeriod = parseInt(domElements.periodicSolPeriod.value) || 0;
            const periodicUsdcAmountVal = parseFloat(domElements.periodicUsdcAmount.value) || 0; // Используем Val для консистентности
            const periodicUsdcPeriod = parseInt(domElements.periodicUsdcPeriod.value) || 0;

            let dailyNetProfit_RefSol = 0;
            let dailyNetProfit_RefUsdc = 0;
            if (referralsEnabled) {
                referralsData.forEach(referral => {
                    const level = referral.level || 1;
                    const commissionRate = commissionRates[level] || 0;
                    if (referral.stakedSol > 0 && referral.profitPercentSol > 0 && commissionRate > 0) {
                        const grossProfit = referral.stakedSol * (referral.profitPercentSol / 100);
                        const fee = grossProfit * platformFeeRate;
                        dailyNetProfit_RefSol += ((grossProfit - fee) * commissionRate);
                    }
                    if (referral.stakedUsdc > 0 && referral.profitPercentUsdc > 0 && commissionRate > 0) {
                        const grossProfit = referral.stakedUsdc * (referral.profitPercentUsdc / 100);
                        const fee = grossProfit * platformFeeRate;
                        dailyNetProfit_RefUsdc += ((grossProfit - fee) * commissionRate);
                    }
                });
            }

            let doubleSolNoReinvestDays = trans.roiNever;
            let doubleUsdcNoReinvestDays = trans.roiNever;
            const dailyNetProfit_UserSol_Initial = initialUserStakedSol * userProfitRateSol * (1 - platformFeeRate);
            const dailyNetProfit_UserUsdc_Initial = initialUserStakedUsdc * userProfitRateUsdc * (1 - platformFeeRate);
            const totalDailySolProfit_NoReinvest = dailyNetProfit_UserSol_Initial + dailyNetProfit_RefSol;
            const totalDailyUsdcProfit_NoReinvest = dailyNetProfit_UserUsdc_Initial + dailyNetProfit_RefUsdc;

            if (initialUserStakedSol > 0 && totalDailySolProfit_NoReinvest > 0) {
                doubleSolNoReinvestDays = Math.ceil(initialUserStakedSol / totalDailySolProfit_NoReinvest);
            }
            if (initialUserStakedUsdc > 0 && totalDailyUsdcProfit_NoReinvest > 0) {
                doubleUsdcNoReinvestDays = Math.ceil(initialUserStakedUsdc / totalDailyUsdcProfit_NoReinvest);
            }

            let currentSolStake = initialUserStakedSol;
            let currentUsdcStake = initialUserStakedUsdc;
            let accumulatedSolProfitForReinvest = 0; // Прибыль, накопленная для возможного реинвеста SOL
            let accumulatedUsdcProfitForReinvest = 0; // Прибыль, накопленная для возможного реинвеста USDC
            let totalSolProfitEarned = 0;      // Общая заработанная прибыль SOL (до вычета реинвеста)
            let totalUsdcProfitEarned = 0;     // Общая заработанная прибыль USDC (до вычета реинвеста)
            
            let doubleSolReinvestDays = trans.roiNever;
            let doubleUsdcReinvestDays = trans.roiNever;
            let solDoubledWithReinvest = false;
            let usdcDoubledWithReinvest = false;
            let totalPeriodicSolAdded = 0;
            let totalPeriodicUsdcAdded = 0;
            const chartLabels = [];
            const chartDataUsd = [];

            for (let day = 1; day <= days; day++) {
                if (periodicSolAmountVal > 0 && periodicSolPeriod > 0 && day % periodicSolPeriod === 0) {
                    currentSolStake += periodicSolAmountVal;
                    totalPeriodicSolAdded += periodicSolAmountVal;
                }
                if (periodicUsdcAmountVal > 0 && periodicUsdcPeriod > 0 && day % periodicUsdcPeriod === 0) {
                    currentUsdcStake += periodicUsdcAmountVal;
                    totalPeriodicUsdcAdded += periodicUsdcAmountVal;
                }

                const profitTodaySol_User = currentSolStake * userProfitRateSol * (1 - platformFeeRate);
                const profitTodayUsdc_User = currentUsdcStake * userProfitRateUsdc * (1 - platformFeeRate);
                const profitTodaySol_Total = profitTodaySol_User + dailyNetProfit_RefSol;
                const profitTodayUsdc_Total = profitTodayUsdc_User + dailyNetProfit_RefUsdc;

                totalSolProfitEarned += profitTodaySol_Total;
                totalUsdcProfitEarned += profitTodayUsdc_Total;

                accumulatedSolProfitForReinvest += profitTodaySol_Total;
                accumulatedUsdcProfitForReinvest += profitTodayUsdc_Total;

                // Раздельная логика реинвеста
                if (reinvestSolEnabled && reinvestSolPercentValue > 0 && accumulatedSolProfitForReinvest > 0) {
                    const solToPotentiallyReinvestRaw = accumulatedSolProfitForReinvest * reinvestSolPercentValue;
                    if (solToPotentiallyReinvestRaw >= REINVEST_THRESHOLD_SOL) {
                        currentSolStake += solToPotentiallyReinvestRaw;
                        accumulatedSolProfitForReinvest = 0; // Сбрасываем аккумулятор, т.к. реинвестировали % от всего накопленного
                    }
                }

                if (reinvestUsdcEnabled && reinvestUsdcPercentValue > 0 && accumulatedUsdcProfitForReinvest > 0) {
                    const usdcToPotentiallyReinvestRaw = accumulatedUsdcProfitForReinvest * reinvestUsdcPercentValue;
                    if (usdcToPotentiallyReinvestRaw >= REINVEST_THRESHOLD_USDC) {
                        currentUsdcStake += usdcToPotentiallyReinvestRaw;
                        accumulatedUsdcProfitForReinvest = 0; // Сбрасываем аккумулятор
                    }
                }
                
                const currentSolBalanceForChart = currentSolStake + accumulatedSolProfitForReinvest; // Оставшаяся нереинвестированная прибыль
                const currentUsdcBalanceForChart = currentUsdcStake + accumulatedUsdcProfitForReinvest;

                if (!solDoubledWithReinvest && initialUserStakedSol > 0 && totalSolProfitEarned >= initialUserStakedSol) {
                    doubleSolReinvestDays = day;
                    solDoubledWithReinvest = true;
                }
                if (!usdcDoubledWithReinvest && initialUserStakedUsdc > 0 && totalUsdcProfitEarned >= initialUserStakedUsdc) {
                    doubleUsdcReinvestDays = day;
                    usdcDoubledWithReinvest = true;
                }

                const currentTotalBalanceUsd = (solToUsdValue > 0 ? currentSolBalanceForChart * solToUsdValue : 0) + currentUsdcBalanceForChart;
                chartLabels.push(day);
                chartDataUsd.push(currentTotalBalanceUsd);
            }

            if (!solDoubledWithReinvest && initialUserStakedSol > 0) {
                const effectiveDailySolProfitWithReinvest = totalDailySolProfit_NoReinvest * (reinvestSolEnabled ? reinvestSolPercentValue : 0);
                if (effectiveDailySolProfitWithReinvest > 0 && userProfitRateSol > 0) { // Добавил userProfitRateSol > 0 чтобы избежать деления на ноль если нет профита
                     // Упрощенный расчет без порогов, для примерной оценки если не удвоилось
                     let tempStake = initialUserStakedSol;
                     let daysToDouble = 0;
                     if (reinvestSolEnabled && reinvestSolPercentValue > 0 && userProfitRateSol > 0) {
                        for(let d=1; d <= days * 2 && d <= 365*10; d++) { // Ограничение на макс. кол-во дней для расчета
                            let dailyProfit = tempStake * userProfitRateSol * (1-platformFeeRate) * reinvestSolPercentValue;
                            tempStake += dailyProfit;
                            daysToDouble = d;
                            if(tempStake >= initialUserStakedSol * 2) break;
                        }
                        if(tempStake >= initialUserStakedSol * 2) doubleSolReinvestDays = daysToDouble;
                        else doubleSolReinvestDays = trans.roiOverDays.replace('{days}', days);
                     } else {
                         doubleSolReinvestDays = trans.roiNever;
                     }
                } else {
                    doubleSolReinvestDays = trans.roiNever;
                }
            }
            if (!usdcDoubledWithReinvest && initialUserStakedUsdc > 0) {
                const effectiveDailyUsdcProfitWithReinvest = totalDailyUsdcProfit_NoReinvest * (reinvestUsdcEnabled ? reinvestUsdcPercentValue : 0);
                 if (effectiveDailyUsdcProfitWithReinvest > 0 && userProfitRateUsdc > 0) {
                     let tempStake = initialUserStakedUsdc;
                     let daysToDouble = 0;
                     if (reinvestUsdcEnabled && reinvestUsdcPercentValue > 0 && userProfitRateUsdc > 0) {
                         for(let d=1; d <= days * 2 && d <= 365*10; d++) {
                            let dailyProfit = tempStake * userProfitRateUsdc * (1-platformFeeRate) * reinvestUsdcPercentValue;
                            tempStake += dailyProfit;
                            daysToDouble = d;
                            if(tempStake >= initialUserStakedUsdc * 2) break;
                        }
                        if(tempStake >= initialUserStakedUsdc * 2) doubleUsdcReinvestDays = daysToDouble;
                        else doubleUsdcReinvestDays = trans.roiOverDays.replace('{days}', days);
                     } else {
                        doubleUsdcReinvestDays = trans.roiNever;
                     }
                } else {
                    doubleUsdcReinvestDays = trans.roiNever;
                }
            }

            const finalSolBalance = currentSolStake + accumulatedSolProfitForReinvest;
            const finalUsdcBalance = currentUsdcStake + accumulatedUsdcProfitForReinvest;
            const finalUsdBalanceTotal = chartDataUsd.length > 0 ? chartDataUsd[chartDataUsd.length - 1] : (initialUserStakedSol * solToUsdValue + initialUserStakedUsdc);

            const profitPercentSolDisplay = initialUserStakedSol > 0 ? (totalSolProfitEarned / initialUserStakedSol) * 100 : 0;
            const profitPercentUsdcDisplay = initialUserStakedUsdc > 0 ? (totalUsdcProfitEarned / initialUserStakedUsdc) * 100 : 0;

            const totalReferralProfitOverPeriodSol = dailyNetProfit_RefSol * days; // Приблизительно, т.к. реф. база не меняется
            const totalReferralProfitOverPeriodUsdc = dailyNetProfit_RefUsdc * days; // Приблизительно
            
            const userProfitSolDisplay = totalSolProfitEarned - totalReferralProfitOverPeriodSol;
            const userProfitUsdcDisplay = totalUsdcProfitEarned - totalReferralProfitOverPeriodUsdc;
            const totalProfitUsdDisplay = (solToUsdValue > 0 ? totalSolProfitEarned * solToUsdValue : 0) + totalUsdcProfitEarned;
            
            console.log("Updating results:", { userProfitSolDisplay, finalSolBalance, userProfitUsdcDisplay, finalUsdcBalance, finalUsdBalanceTotal });

            const updateResultSpan = (element, value, formatDigits, iconHtml = '', className = '') => {
                if (element) {
                    let displayValue;
                    if (typeof value === 'number') {
                        displayValue = formatDisplayNumberCustom(value, formatDigits) + (iconHtml || '');
                    } else { 
                        displayValue = value + (iconHtml || '');
                    }
                    element.innerHTML = displayValue;
                    element.className = 'value ' + (className || '');
                }
            };

            const daysSuffix = ` ${trans.daysSuffix}`;
            updateResultSpan(domElements.resultProfitUserSol, userProfitSolDisplay, 5, solanaIconImg, 'value-sol');
            updateResultSpan(domElements.resultProfitRefSol, totalReferralProfitOverPeriodSol, 5, solanaIconImg, 'value-sol');
            updateResultSpan(domElements.resultPeriodicTotalSol, totalPeriodicSolAdded, 5, solanaIconImg, 'value-sol');
            updateResultSpan(domElements.resultProfitTotalSol, totalSolProfitEarned, 5, solanaIconImg, 'value-sol');
            updateResultSpan(domElements.resultFinalBalanceSol, finalSolBalance, 5, solanaIconImg, 'value-sol');

            updateResultSpan(domElements.resultProfitUserUsdc, userProfitUsdcDisplay, 2, usdcIconImg, 'value-usdc');
            updateResultSpan(domElements.resultProfitRefUsdc, totalReferralProfitOverPeriodUsdc, 2, usdcIconImg, 'value-usdc');
            updateResultSpan(domElements.resultPeriodicTotalUsdc, totalPeriodicUsdcAdded, 2, usdcIconImg, 'value-usdc');
            updateResultSpan(domElements.resultProfitTotalUsdc, totalUsdcProfitEarned, 2, usdcIconImg, 'value-usdc');
            updateResultSpan(domElements.resultFinalBalanceUsdc, finalUsdcBalance, 2, usdcIconImg, 'value-usdc');

            updateResultSpan(domElements.resultProfitPercentSol, profitPercentSolDisplay, 2, ' %', 'profit-percent');
            updateResultSpan(domElements.resultProfitPercentUsdc, profitPercentUsdcDisplay, 2, ' %', 'profit-percent');
            updateResultSpan(domElements.resultDoubleSolNoreinvest, doubleSolNoReinvestDays, 0, (typeof doubleSolNoReinvestDays === 'number' ? daysSuffix : ''), 'doubling');
            updateResultSpan(domElements.resultDoubleUsdcNoreinvest, doubleUsdcNoReinvestDays, 0, (typeof doubleUsdcNoReinvestDays === 'number' ? daysSuffix : ''), 'doubling');
            updateResultSpan(domElements.resultDoubleSolReinvest, doubleSolReinvestDays, 0, (typeof doubleSolReinvestDays === 'number' ? daysSuffix : (doubleSolReinvestDays === trans.roiNever ? '' : '')), 'doubling');
            updateResultSpan(domElements.resultDoubleUsdcReinvest, doubleUsdcReinvestDays, 0, (typeof doubleUsdcReinvestDays === 'number' ? daysSuffix : (doubleUsdcReinvestDays === trans.roiNever ? '' : '')), 'doubling');
            updateResultSpan(domElements.resultFinalBalanceUsdTotal, finalUsdBalanceTotal, 2, ' $', 'balance-usd');
            updateResultSpan(domElements.resultProfitTotalUsd, totalProfitUsdDisplay, 2, ' $', 'balance-usd');

            renderBalanceChart(chartLabels, chartDataUsd);
            saveData();
        }

        /**
         * Очищает все поля результатов, график и сбрасывает классы.
         * @param {string} [message=""] - An optional message to log to the console.
         */
         function clearResults(message = "") {
            // Helper function to reset content and class
            const resetResultSpan = (element, defaultValue, defaultIconHtml = '', defaultClassName = 'value') => {
                if (element) {
                    element.innerHTML = defaultValue + (defaultIconHtml || '');
                    // Убедимся, что базовый класс 'value' всегда есть, а затем добавляем специфичный для цвета
                    element.className = 'value ' + defaultClassName; 
                }
            };
            const trans = translations[currentLanguage];

            // SOL Results - теперь сразу с классом value-sol
            resetResultSpan(domElements.resultProfitUserSol, formatDisplayNumberCustom(0, 5), solanaIconImg, 'value-sol');
            resetResultSpan(domElements.resultProfitRefSol, formatDisplayNumberCustom(0, 5), solanaIconImg, 'value-sol');
            resetResultSpan(domElements.resultPeriodicTotalSol, formatDisplayNumberCustom(0, 5), solanaIconImg, 'value-sol'); // Этот может быть и не цветным, а просто 'value'
            resetResultSpan(domElements.resultProfitTotalSol, formatDisplayNumberCustom(0, 5), solanaIconImg, 'value-sol');
            resetResultSpan(domElements.resultFinalBalanceSol, formatDisplayNumberCustom(0, 5), solanaIconImg, 'value-sol');

            // USDC Results - теперь сразу с классом value-usdc
            resetResultSpan(domElements.resultProfitUserUsdc, formatDisplayNumberCustom(0, 2), usdcIconImg, 'value-usdc');
            resetResultSpan(domElements.resultProfitRefUsdc, formatDisplayNumberCustom(0, 2), usdcIconImg, 'value-usdc');
            resetResultSpan(domElements.resultPeriodicTotalUsdc, formatDisplayNumberCustom(0, 2), usdcIconImg, 'value-usdc'); // Этот может быть и не цветным, а просто 'value'
            resetResultSpan(domElements.resultProfitTotalUsdc, formatDisplayNumberCustom(0, 2), usdcIconImg, 'value-usdc');
            resetResultSpan(domElements.resultFinalBalanceUsdc, formatDisplayNumberCustom(0, 2), usdcIconImg, 'value-usdc');

            // General Results
            resetResultSpan(domElements.resultProfitPercentSol, formatDisplayNumberCustom(0, 2), ' %', 'profit-percent');
            resetResultSpan(domElements.resultProfitPercentUsdc, formatDisplayNumberCustom(0, 2), ' %', 'profit-percent');
            resetResultSpan(domElements.resultDoubleSolNoreinvest, trans.roiNever || 'N/A', '', 'doubling');
            resetResultSpan(domElements.resultDoubleUsdcNoreinvest, trans.roiNever || 'N/A', '', 'doubling');
            resetResultSpan(domElements.resultDoubleSolReinvest, trans.roiNever || 'N/A', '', 'doubling');
            resetResultSpan(domElements.resultDoubleUsdcReinvest, trans.roiNever || 'N/A', '', 'doubling');
            resetResultSpan(domElements.resultFinalBalanceUsdTotal, formatDisplayNumberCustom(0, 2), ' $', 'balance-usd');
            resetResultSpan(domElements.resultProfitTotalUsd, formatDisplayNumberCustom(0, 2), ' $', 'balance-usd');

            if (balanceChartInstance) {
                balanceChartInstance.destroy();
                balanceChartInstance = null;
            }
            if (message) { console.warn(message); } // Log warning/error message if provided
        }
        /**
         * Сбрасывает все поля ввода, рефералов и результаты к значениям по умолчанию.
         */
        function resetCalculator() {
            // Use cached elements
            domElements.userStakedSolAmount.value = '0';
            domElements.userProfitPercentSol.value = '0';
            domElements.userStakedUsdcAmount.value = '0';
            domElements.userProfitPercentUsdc.value = '0';
            domElements.platformFee.value = '10';
            domElements.solToUsd.value = '0';
            domElements.days.value = '0';
            domElements.periodicSolAmount.value = '0';
            domElements.periodicSolPeriod.value = '0';
            domElements.periodicUsdcAmount.value = '0';
            domElements.periodicUsdcPeriod.value = '0';
            domElements.reinvestSolCheckbox.checked = true;
            domElements.reinvestSolPercent.value = '100';
            domElements.reinvestUsdcCheckbox.checked = true;
            omElements.reinvestUsdcPercent.value = '100';
            toggleReinvestControls(domElements.reinvestSolCheckbox);
            toggleReinvestControls(domElements.reinvestUsdcCheckbox);
            domElements.includeReferralsCheckbox.checked = true;
            toggleReinvestPercentInput(); // Update visibility
            currentPage = 1; // Сброс страницы
            renderReferralsTable();
            referralsData = [];
            nextReferralId = 1;
            renderReferralsTable();
            clearResults();
            clearAllValidationErrors();
            resetConverter(); // Reset converter fields
            saveData();
        }

        /**
         * Очищает все сообщения об ошибках валидации и рамки.
         */
        function clearAllValidationErrors() {
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            // Clear specific error messages if they were used (currently hidden)
            // document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        }

        /**
         * Удаляет ошибку валидации для конкретного поля ввода при изменении его значения.
         */
        function clearValidationError(event) {
            const inputElement = event.target;
            inputElement.classList.remove('input-error');
        }

        // --- Collapsible Section Functions ---
        /**
         * Toggles the visibility of a collapsible section.
         * @param {HTMLElement} sectionElement - The main section element.
         * @param {string} storageKey - The localStorage key to save the state.
         */
        function toggleCollapsibleSection(sectionElement, storageKey) {
            if (!sectionElement) return;
            const isCollapsing = !sectionElement.classList.contains('collapsed');
            sectionElement.classList.toggle('collapsed');
            localStorage.setItem(storageKey, sectionElement.classList.contains('collapsed').toString());

            // Resize chart after animation if expanding chart section
            if (storageKey === 'fomoFarmCalc_chartCollapsed' && !isCollapsing && balanceChartInstance) {
                 // No timeout needed if animation is removed
                 balanceChartInstance.resize();
            }
        }


        // --- Chart Rendering Function ---
        /**
         * Рендерит график баланса с использованием Chart.js.
         */
        function renderBalanceChart(originalLabels, originalUsdData) {
            const ctx = domElements.balanceChart.getContext('2d'); // Use cache
            if (balanceChartInstance) { balanceChartInstance.destroy(); }

            const numDays = originalLabels.length;
            if (numDays === 0) return;

            let stepSize = 1;
            if (numDays > 365) { stepSize = 30; }
            else if (numDays > 180) { stepSize = 14; }
            else if (numDays > 90) { stepSize = 7; }
            else if (numDays > 60) { stepSize = 3; }
            else if (numDays > 30) { stepSize = 2; }

            const filteredLabels = [];
            const filteredUsdData = [];

            if (numDays > 0) {
                filteredLabels.push(originalLabels[0]);
                filteredUsdData.push(originalUsdData[0]);
                for (let i = stepSize; i < numDays; i += stepSize) {
                    // Correct index: i - 1, as arrays are 0-indexed and labels start from 1
                    filteredLabels.push(originalLabels[i - 1]);
                    filteredUsdData.push(originalUsdData[i - 1]);
                }
                const lastOriginalIndex = numDays - 1;
                // Ensure the last label is added if it wasn't included by the step
                if (filteredLabels.length === 0 || filteredLabels[filteredLabels.length - 1] !== originalLabels[lastOriginalIndex]) {
                     // Add the last point if stepSize > 1 or if it's the only point
                     if (stepSize > 1 || filteredLabels.length === 0) {
                         filteredLabels.push(originalLabels[lastOriginalIndex]);
                         filteredUsdData.push(originalUsdData[lastOriginalIndex]);
                     }
                }
            }

            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(74, 222, 128, 0.3)'); // Начальный цвет (полупрозрачный #4ade80)
            gradient.addColorStop(1, 'rgba(74, 222, 128, 0)');   // Конечный цвет (полностью прозрачный #4ade80)


            balanceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredLabels,
                    datasets: [{
                        label: 'Total Balance (USD)', // Consider translation if needed
                        data: filteredUsdData,
                        borderColor: '#4ade80',
                        backgroundColor: gradient , // Apply gradient
                        fill: true, // Enable fill
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: numDays > 90 ? 0 : 2,
                        pointHoverRadius: 5, // Increase hover radius
                        pointHoverBackgroundColor: '#ffffff', // White background on hover
                        pointHoverBorderColor: '#4ade80' // Border color on hover
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: 'rgba(156, 163, 175, 0.2)' } },
                        x: { ticks: { color: '#9ca3af', autoSkip: false, maxRotation: 0, minRotation: 0 }, grid: { display: false } }
                    },
                    plugins: { legend: { labels: { color: '#e5e7eb' } }, tooltip: { mode: 'index', intersect: false } },
                    hover: { mode: 'nearest', intersect: true }
                }
            });
        }

        // --- Currency Converter Functions ---
        /**
         * Заполняет выпадающие списки валют конвертера.
         */
        function populateCurrencyDropdowns() {
            const fromSelect = domElements.convertFrom; // Use cache
            const toSelect = domElements.convertTo; // Use cache
            if (!fromSelect || !toSelect) return;

            fromSelect.innerHTML = '';
            toSelect.innerHTML = '';

            converterCurrencies.forEach(currency => {
                const optionFrom = document.createElement('option');
                optionFrom.value = currency.id;
                // Add symbol in parentheses
                optionFrom.textContent = `${currency.symbol || currency.id.toUpperCase()}`; // Only symbol/ID
                optionFrom.title = currency.name; // Full name in title
                fromSelect.appendChild(optionFrom);

                const optionTo = document.createElement('option');
                optionTo.value = currency.id;
                 optionTo.textContent = `${currency.symbol || currency.id.toUpperCase()}`; // Only symbol/ID
                 optionTo.title = currency.name; // Full name in title
                toSelect.appendChild(optionTo);
            });

            fromSelect.value = 'solana';
            toSelect.value = 'usd';
        }

        /**
         * Выполняет конвертацию валют с использованием CoinGecko API (с debounce).
         * Handles crypto-crypto and fiat-crypto/crypto-fiat conversions.
         */
        function triggerConversion() {
            clearTimeout(conversionTimeout); // Clear previous timeout
            conversionTimeout = setTimeout(async () => { // Set new timeout
                // Use cached elements
                const amountInput = domElements.convertAmountFrom;
                const fromSelect = domElements.convertFrom;
                const toSelect = domElements.convertTo;
                const resultInput = domElements.convertResultAmount;
                // const resultDisplaySpan = domElements.convertResultDisplay; // Removed display span
                const statusSpan = domElements.converterStatus;
                const trans = translations[currentLanguage];

                if (!amountInput || !fromSelect || !toSelect || !resultInput || !statusSpan) return;

                const amount = parseFloat(amountInput.value);
                const fromId = fromSelect.value;
                const toId = toSelect.value;
                const fromType = getCurrencyType(fromId);
                const toType = getCurrencyType(toId);

                // Reset state before conversion
                amountInput.classList.remove('input-error');
                resultInput.value = ''; // Clear input value
                // resultDisplaySpan.textContent = ''; // Clear display span text
                statusSpan.textContent = '';
                statusSpan.className = '';

                // --- Basic Validations ---
                if (isNaN(amount) || amount < 0) {
                    amountInput.classList.add('input-error');
                    statusSpan.textContent = trans.convertErrorInvalidAmount;
                    statusSpan.className = 'error';
                    return;
                }
                if (fromId === toId) {
                    statusSpan.textContent = trans.convertErrorSameCurrency;
                    statusSpan.className = 'error';
                    // Display the input amount directly, formatted
                    resultInput.value = formatDisplayNumberCustom(amount, fromType === 'crypto' ? 5 : 2);
                    return;
                }
                 if (fromType === 'fiat' && toType === 'fiat') {
                     // Fiat-to-Fiat conversion via USD
                     console.log(`Converting ${fromId} to ${toId} via USD (Fiat-Fiat)`);
                     statusSpan.textContent = trans.convertStatusLoading;
                     statusSpan.className = 'loading';
                     try {
                         // Fetch USD price in terms of 'from' currency (e.g., how many EUR per USD)
                         const rateUsdFrom = await fetchCoinPrice('usd', fromId);
                         // Fetch USD price in terms of 'to' currency (e.g., how many RUB per USD)
                         const rateUsdTo = await fetchCoinPrice('usd', toId);

                         console.log(`USD/${fromId} rate:`, rateUsdFrom);
                         console.log(`USD/${toId} rate:`, rateUsdTo);

                         if (rateUsdFrom === 0) throw new Error(`Cannot divide by zero rate for USD/${fromId}`);

                         // Rate = (toId / USD) / (fromId / USD) = rateUsdTo / rateUsdFrom
                         const rate = rateUsdTo / rateUsdFrom;
                         const convertedAmount = amount * rate;

                         resultInput.value = formatDisplayNumberCustom(convertedAmount, 2); // Fiat always 2 decimals

                         statusSpan.textContent = trans.convertStatusSuccess;
                         statusSpan.className = 'success';

                     } catch (error) {
                         console.error('Ошибка конвертации фиат-фиат:', error);
                         let userErrorMessage = trans.convertErrorApi;
                         if (error.message && error.message.includes('missing data')) {
                             userErrorMessage = trans.convertErrorPairNotFound || 'Currency pair not found.';
                         } else if (error.message && !error.message.startsWith('HTTP error')) {
                             userErrorMessage = error.message;
                         }
                         statusSpan.textContent = userErrorMessage;
                         statusSpan.className = 'error';
                         resultInput.value = '';
                         // resultDisplaySpan.textContent = '';
                     } finally {
                         setTimeout(() => {
                             if (statusSpan.className !== 'loading') {
                                 statusSpan.textContent = '';
                                 statusSpan.className = '';
                             }
                         }, 3000);
                     }
                     return; // Exit after handling fiat-fiat
                 }
                if (amount === 0) {
                    resultInput.value = formatDisplayNumberCustom(0, toType === 'crypto' ? 5 : 2);
                    return;
                }
                // --- End Basic Validations ---

                statusSpan.textContent = trans.convertStatusLoading;
                statusSpan.className = 'loading';

                try {
                    let rate;
                    // Case 1: Crypto to Crypto (via USD) - Remains the same
                    if (fromType === 'crypto' && toType === 'crypto') {
                        console.log(`Converting ${fromId} to ${toId} via USD`);
                        const [rateFromUsd, rateToUsd] = await Promise.all([
                            fetchCoinPrice(fromId, 'usd'),
                            fetchCoinPrice(toId, 'usd')
                        ]);
                         console.log(`${fromId}/USD rate:`, rateFromUsd);
                         console.log(`${toId}/USD rate:`, rateToUsd);
                        if (rateToUsd === 0) throw new Error(`Cannot divide by zero rate for ${toId}/USD`);
                        rate = rateFromUsd / rateToUsd;
                    }
                    // Case 2: Fiat to Crypto (inverted call) - Remains the same
                    else if (fromType === 'fiat' && toType === 'crypto') {
                        console.log(`Converting ${fromId} to ${toId} (inverted)`);
                        const directRate = await fetchCoinPrice(toId, fromId); // Get crypto price in fiat
                        console.log(`${toId}/${fromId} direct rate:`, directRate);
                        if (directRate === 0) throw new Error(`API returned zero rate for ${toId}/${fromId}`);
                        rate = 1 / directRate;
                    }
                    // Case 3: Crypto to Fiat (standard call) - Default
                    else { // fromType === 'crypto' && toType === 'fiat'
                        console.log(`Converting ${fromId} to ${toId} (standard)`);
                        rate = await fetchCoinPrice(fromId, toId);
                        console.log(`${fromId}/${toId} rate:`, rate);
                    }

                    const convertedAmount = amount * rate;

                    // Set result input value (formatted)
                    resultInput.value = formatDisplayNumberCustom(convertedAmount, toType === 'crypto' ? 5 : 2);


                    statusSpan.textContent = trans.convertStatusSuccess;
                    statusSpan.className = 'success';

                } catch (error) {
                    console.error('Ошибка конвертации валюты:', error);
                    console.error('Error message:', error.message);

                    let userErrorMessage = trans.convertErrorApi; // Default API error
                    if (error.message && error.message.includes('missing data')) {
                        userErrorMessage = trans.convertErrorPairNotFound || 'Currency pair not found.';
                    } else if (error.message && !error.message.startsWith('HTTP error')) {
                         userErrorMessage = error.message; // Use specific error if not just HTTP
                    }

                    statusSpan.textContent = userErrorMessage;
                    statusSpan.className = 'error';
                    resultInput.value = ''; // Clear result on error
                    // resultDisplaySpan.textContent = ''; // Clear display span on error
                } finally {
                    setTimeout(() => {
                        if (statusSpan.className !== 'loading') {
                            statusSpan.textContent = '';
                            statusSpan.className = '';
                        }
                    }, 3000);
                }
            }, CONVERSION_DEBOUNCE_DELAY); // Apply debounce delay
        }

        /**
         * Helper function to fetch price for a single pair from CoinGecko.
         * Throws an error if the pair is not found or the API call fails.
         */
        async function fetchCoinPrice(primaryId, secondaryId) {
            const apiUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${primaryId}&vs_currencies=${secondaryId}`;
            let responseDataText = ""; // For logging raw response on error
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    let errorDetails = `HTTP error! status: ${response.status}`;
                    try {
                        responseDataText = await response.text();
                        console.error("Raw API Error Response:", responseDataText);
                        const errorData = JSON.parse(responseDataText);
                        if (errorData && errorData.error) {
                            errorDetails += ` - ${errorData.error}`;
                        }
                    } catch (e) {
                        errorDetails += ` - Unable to parse error response: ${responseDataText.substring(0, 100)}`;
                    }
                    throw new Error(errorDetails);
                }
                const data = await response.json();

                // More robust check for missing data
                if (!data || !data[primaryId] || data[primaryId][secondaryId] === undefined || data[primaryId][secondaryId] === null) {
                    console.error("API Error: Pair not found in response. Primary:", primaryId, "Secondary:", secondaryId, "Response:", data);
                    throw new Error(`missing data for ${secondaryId} against ${primaryId}`); // Specific error message
                }
                return data[primaryId][secondaryId];
            } catch (error) {
                 // Re-throw the error to be caught by the main conversion logic
                 console.error(`Failed to fetch price for ${primaryId}/${secondaryId}:`, error.message); // Log specific message
                 throw error; // Propagate the error
            }
        }


        /**
         * Меняет местами выбранные валюты и запускает конвертацию.
         */
        function swapCurrencies() {
            // Use cached elements
            const fromSelect = domElements.convertFrom;
            const toSelect = domElements.convertTo;
            const amountInput = domElements.convertAmountFrom;
            const resultInput = domElements.convertResultAmount;
            // const resultDisplaySpan = domElements.convertResultDisplay; // Removed

            if (!fromSelect || !toSelect || !amountInput || !resultInput) return;

            const tempCurrency = fromSelect.value;
            fromSelect.value = toSelect.value;
            toSelect.value = tempCurrency;

            // Try to parse the formatted number from the result input
            // Replace space separators, then replace comma with dot for parseFloat
            const resultValueStr = resultInput.value.replace(/\s/g, '').replace(',', '.');
            const resultValue = parseFloat(resultValueStr);

            if (!isNaN(resultValue)) {
                amountInput.value = resultValue; // Set the parsed number
                 resultInput.value = ''; // Clear result input
                 // resultDisplaySpan.textContent = ''; // Clear display span
            } else {
                 amountInput.value = '1'; // Default to 1 if result wasn't a number
                 resultInput.value = '';
                 // resultDisplaySpan.textContent = '';
            }

            triggerConversion();
        }


        // --- Export/Import Functions ---
        /**
         * Экспортирует текущие данные калькулятора в JSON файл.
         */
        function exportData() {
            try {
                const exportObj = {
                    userStakedSolAmount: domElements.userStakedSolAmount.value, userProfitPercentSol: domElements.userProfitPercentSol.value,
                    userStakedUsdcAmount: domElements.userStakedUsdcAmount.value, userProfitPercentUsdc: domElements.userProfitPercentUsdc.value,
                    platformFee: domElements.platformFee.value, solToUsd: domElements.solToUsd.value, days: domElements.days.value,
                    periodicSolAmount: domElements.periodicSolAmount.value, periodicSolPeriod: domElements.periodicSolPeriod.value,
                    periodicUsdcAmount: domElements.periodicUsdcAmount.value, periodicUsdcPeriod: domElements.periodicUsdcPeriod.value,
                    reinvestSol: domElements.reinvestSolCheckbox.checked.toString(),
                    reinvestSolPercent: domElements.reinvestSolPercent.value,
                    reinvestUsdc: domElements.reinvestUsdcCheckbox.checked.toString(),
                    reinvestUsdcPercent: domElements.reinvestUsdcPercent.value,
                    includeReferrals: domElements.includeReferralsCheckbox.checked,
                    referralsData: referralsData, nextReferralId: nextReferralId,
                    referralsCollapsed: domElements.referralsSection?.classList.contains('collapsed') || false,
                    chartCollapsed: domElements.chartSection?.classList.contains('collapsed') || false,
                    converterCollapsed: domElements.converterSection?.classList.contains('collapsed') || false,
                    currentLanguage: currentLanguage
                };
                const dataStr = JSON.stringify(exportObj, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'fomofarm_calculator_data.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Ошибка экспорта данных:", error);
                alert("Ошибка экспорта данных. См. консоль для деталей.");
            }
        }

        /**
         * Обрабатывает импорт данных из выбранного JSON файла.
         */
        function importData(event) {
            const file = event.target.files[0];
            if (!file) { return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData || typeof importedData !== 'object' || !importedData.hasOwnProperty('referralsData')) {
                        throw new Error("Неверный формат файла.");
                    }

                    // Apply imported data using cached elements
                    domElements.userStakedSolAmount.value = importedData.userStakedSolAmount || '0';
                    domElements.userProfitPercentSol.value = importedData.userProfitPercentSol || '0';
                    domElements.userStakedUsdcAmount.value = importedData.userStakedUsdcAmount || '0';
                    domElements.userProfitPercentUsdc.value = importedData.userProfitPercentUsdc || '0';
                    domElements.platformFee.value = importedData.platformFee || '10';
                    domElements.solToUsd.value = importedData.solToUsd || '0';
                    domElements.days.value = importedData.days || '0';
                    domElements.periodicSolAmount.value = importedData.periodicSolAmount || '0';
                    domElements.periodicSolPeriod.value = importedData.periodicSolPeriod || '0';
                    domElements.periodicUsdcAmount.value = importedData.periodicUsdcAmount || '0';
                    domElements.periodicUsdcPeriod.value = importedData.periodicUsdcPeriod || '0';
                    domElements.reinvestSolCheckbox.checked = (localStorage.getItem('fomoFarmCalc_reinvestSol') || 'true') === 'true';
                    domElements.reinvestSolPercent.value = localStorage.getItem('fomoFarmCalc_reinvestSolPercent') || '100';
                    domElements.reinvestUsdcCheckbox.checked = (localStorage.getItem('fomoFarmCalc_reinvestUsdc') || 'true') === 'true';
                    domElements.reinvestUsdcPercent.value = localStorage.getItem('fomoFarmCalc_reinvestUsdcPercent') || '100';
                    domElements.includeReferralsCheckbox.checked = importedData.includeReferrals === true || importedData.includeReferrals === 'true';
                    currentPage = 1; // Сброс страницы при импорте
                    updateUI(currentLanguage);
                    renderReferralsTable(); // Убедимся, что таблица и пагинация обновлены
                    // Обновляем видимость полей процентов после загрузки состояния чекбоксов
                    toggleReinvestControls(domElements.reinvestSolCheckbox);
                    toggleReinvestControls(domElements.reinvestUsdcCheckbox);

                    if (Array.isArray(importedData.referralsData)) {
                        referralsData = importedData.referralsData.filter(ref => typeof ref === 'object' && ref !== null && ref.hasOwnProperty('id'));
                        referralsData.forEach(ref => {
                            ref.level = ref.level || 1;
                            ref.stakedSol = ref.stakedSol || 0; ref.profitPercentSol = ref.profitPercentSol || 0;
                            ref.stakedUsdc = ref.stakedUsdc || 0; ref.profitPercentUsdc = ref.profitPercentUsdc || 0;
                        });
                    } else { referralsData = []; }

                    const maxId = referralsData.reduce((max, ref) => Math.max(max, ref.id || 0), 0);
                    nextReferralId = Math.max(maxId + 1, parseInt(importedData.nextReferralId) || 1);

                    // Restore collapsible states from imported data
                    if (domElements.referralsSection) domElements.referralsSection.classList.toggle('collapsed', importedData.referralsCollapsed === true || importedData.referralsCollapsed === 'true');
                    if (domElements.chartSection) domElements.chartSection.classList.toggle('collapsed', importedData.chartCollapsed === true || importedData.chartCollapsed === 'true');
                    if (domElements.converterSection) domElements.converterSection.classList.toggle('collapsed', importedData.converterCollapsed === true || importedData.converterCollapsed === 'true');


                    currentLanguage = importedData.currentLanguage || 'en';

                    updateUI(currentLanguage);
                    renderReferralsTable();
                    clearResults();
                    resetConverter();
                    saveData();

                    alert("Данные успешно импортированы!");

                } catch (error) {
                    console.error("Ошибка импорта данных:", error);
                    alert("Ошибка импорта файла. Убедитесь, что это действительный JSON экспорт из этого калькулятора.");
                } finally {
                    event.target.value = null;
                }
            };
            reader.readAsText(file);
        }

        // --- Reinvest Percentage Toggle ---
        function toggleReinvestControls(checkboxElement) {
         // Находим связанные элементы относительно переданного чекбокса
         // Предполагаем, что input[type=number] и span.reinvest-percent-symbol являются следующими элементами после label
         // или находятся внутри того же родительского .checkbox-item
         const parentItem = checkboxElement.closest('.checkbox-item');
         if (!parentItem) return;

         const percentInput = parentItem.querySelector('.reinvest-percent-input');
         const percentSymbol = parentItem.querySelector('.reinvest-percent-symbol');

         if (checkboxElement && percentInput && percentSymbol) {
             const shouldShow = checkboxElement.checked;
             percentInput.style.display = shouldShow ? 'inline-block' : 'none';
             percentSymbol.style.display = shouldShow ? 'inline-block' : 'none';
             percentInput.disabled = !shouldShow;
         }
     }


        // --- Event Listener Setup ---
        /**
         * Устанавливает все необходимые обработчики событий.
         */
        function setupEventListeners() {
             // Cache DOM elements on setup
             const idsToCache = [
                'userStakedSolAmount', 'userProfitPercentSol', 'userStakedUsdcAmount', 'userProfitPercentUsdc',
                'platformFee', 'solToUsd', 'days', 'periodicSolAmount', 'periodicSolPeriod',
                'periodicUsdcAmount', 'periodicUsdcPeriod',
                'reinvestSolCheckbox', 'label-reinvest-sol', 'reinvestSolPercent',
                'reinvestUsdcCheckbox', 'label-reinvest-usdc', 'reinvestUsdcPercent',
                'includeReferralsCheckbox', 'referralsList', 'editReferralModal', 'modalTitle',
                'editingReferralId', 'modal-level', 'modal-stake-sol', 'modal-profit-sol',
                'modal-stake-usdc', 'modal-profit-usdc', 'balanceChart', 'convertAmountFrom',
                'convertFrom', 'convertTo', 'convertResultAmount',
                'converterStatus', 'solPriceStatus',
                'walletAddress', 
                'copyWalletButton', 
                'copyStatus', 
                'supportSection',
                // Result fields
                'result-profit-user-sol', 'result-profit-user-usdc', 'result-profit-ref-sol',
                'result-profit-ref-usdc', 'result-profit-total-sol', 'result-profit-total-usdc',
                'result-profit-percent-sol', 'result-profit-percent-usdc', 'result-double-sol-noreinvest',
                'result-double-usdc-noreinvest', 'result-double-sol-reinvest', 'result-double-usdc-reinvest',
                'result-periodic-total-sol', 'result-periodic-total-usdc', 'result-final-balance-sol',
                'result-final-balance-usdc', 'result-final-balance-usd-total', 'result-profit-total-usd',
                 // Labels for icon updates
                'label-user-staked-sol', 'label-user-staked-usdc', 'label-user-profit-percent-sol',
                'label-user-profit-percent-usdc', 'label-periodic-sol', 'label-periodic-usdc',
                'label-modal-stake-sol', 'label-modal-profit-sol', 'label-modal-stake-usdc',
                'label-modal-profit-usdc', 'label-modal-level',
                 // Collapsible sections
                 'referralsSection', 'chartSection', 'converterSection'
             ];
             idsToCache.forEach(id => domElements[id.replace(/-([a-z])/g, g => g[1].toUpperCase())] = document.getElementById(id)); // Convert kebab-case to camelCase for keys


             // Калькулятор
             document.querySelectorAll('.input-group input, .input-group select, .secondary-inputs input, .secondary-inputs select, .checkbox-container input').forEach(element => {
                 element.addEventListener('change', saveData);
                 if (element.tagName === 'INPUT' || element.tagName === 'SELECT') {
                     element.addEventListener('input', clearValidationError);
                 }
             });

            // Новые слушатели для реинвеста SOL
             domElements.reinvestSolCheckbox?.addEventListener('change', function() {
             toggleReinvestControls(this);
             saveData(); // Сохраняем состояние чекбокса
                });
             domElements.reinvestSolPercent?.addEventListener('change', saveData);
             domElements.reinvestSolPercent?.addEventListener('input', clearValidationError);

            // Новые слушатели для реинвеста USDC
             domElements.reinvestUsdcCheckbox?.addEventListener('change', function() {
             toggleReinvestControls(this);
             saveData(); // Сохраняем состояние чекбокса
                });
            domElements.reinvestUsdcPercent?.addEventListener('change', saveData);
            domElements.reinvestUsdcPercent?.addEventListener('input', clearValidationError);

             // Конвертер (автоматический запуск)
             domElements.convertAmountFrom?.addEventListener('input', triggerConversion);
             domElements.convertFrom?.addEventListener('change', triggerConversion);
             domElements.convertTo?.addEventListener('change', triggerConversion);
             document.getElementById('swapCurrenciesButton')?.addEventListener('click', swapCurrencies);

             // Общие кнопки
             document.getElementById('languageToggleButton').addEventListener('click', toggleLanguage);
             document.getElementById('addReferralButton').addEventListener('click', addReferral);
             document.getElementById('saveReferralButton').addEventListener('click', saveReferralData);
             document.getElementById('cancelReferralButton').addEventListener('click', closeEditModal);
             domElements.editReferralModal?.addEventListener('click', (event) => {
                 if (event.target === event.currentTarget) { closeEditModal(); }
             });
             document.getElementById('calculateButton').addEventListener('click', calculate);
             document.getElementById('fetchSolPriceButton').addEventListener('click', fetchSolPrice);
             document.getElementById('resetButton').addEventListener('click', resetCalculator);
             document.getElementById('exportButton').addEventListener('click', exportData);
             document.getElementById('importButton').addEventListener('click', () => document.getElementById('importFile').click());
             document.getElementById('importFile').addEventListener('change', importData);
             domElements.copyWalletButton?.addEventListener('click', copyWalletAddress);

             // Collapsible section listeners
             document.getElementById('referralsHeader')?.addEventListener('click', () => toggleCollapsibleSection(domElements.referralsSection, 'fomoFarmCalc_referralsCollapsed'));
             document.getElementById('chartHeader')?.addEventListener('click', () => toggleCollapsibleSection(domElements.chartSection, 'fomoFarmCalc_chartCollapsed'));
             document.getElementById('converterHeader')?.addEventListener('click', () => toggleCollapsibleSection(domElements.converterSection, 'fomoFarmCalc_converterCollapsed'));

              // Referral table sorting listeners
              document.querySelectorAll('#referralsTable th.sortable').forEach(header => {
                header.addEventListener('click', () => sortReferrals(header.dataset.sortKey));
            });
        }

        /**
         * Сбрасывает поля конвертера к значениям по умолчанию.
         */
        function resetConverter() {
            // Use cached elements
            const amountInput = domElements.convertAmountFrom;
            const resultInput = domElements.convertResultAmount;
            // const resultDisplaySpan = domElements.convertResultDisplay; // Removed
            const statusSpan = domElements.converterStatus;
            const fromSelect = domElements.convertFrom;
            const toSelect = domElements.convertTo;

            if (amountInput) amountInput.value = '1';
            if (resultInput) resultInput.value = '';
            // if (resultDisplaySpan) resultDisplaySpan.textContent = ''; // Clear display span
            if (statusSpan) {
                statusSpan.textContent = '';
                statusSpan.className = '';
            }
            if (amountInput) amountInput.classList.remove('input-error');
            if (fromSelect) fromSelect.value = 'solana';
            if (toSelect) toSelect.value = 'usd';
            triggerConversion(); // Выполнить конвертацию с дефолтными значениями
        }

        /**
         * Копирует адрес кошелька в буфер обмена и показывает подтверждение.
         */
        async function copyWalletAddress() {
            const walletAddressElement = domElements.walletAddress;
            const copyButton = domElements.copyWalletButton;
            const copyStatus = domElements.copyStatus;
            const trans = translations[currentLanguage];

            if (!walletAddressElement || !copyButton || !copyStatus) return;

            const address = walletAddressElement.textContent;

            try {
                await navigator.clipboard.writeText(address);

                // Показать сообщение "Скопировано!"
                copyStatus.textContent = trans.copiedMessage;
                copyStatus.style.display = 'inline';

                // Изменить иконку на галочку (опционально)
                const icon = copyButton.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-copy');
                    icon.classList.add('fa-check');
                    icon.style.color = '#4ade80'; // Зеленый цвет для галочки
                }

                // Скрыть сообщение и вернуть иконку через 1.5 секунды
                setTimeout(() => {
                    copyStatus.textContent = '';
                    copyStatus.style.display = 'none';
                    if (icon) {
                        icon.classList.remove('fa-check');
                        icon.classList.add('fa-copy');
                        icon.style.color = ''; // Вернуть исходный цвет иконки
                    }
                }, 1500);

            } catch (err) {
                console.error('Ошибка копирования в буфер обмена:', err);
                // Можно добавить сообщение об ошибке для пользователя, если нужно
                copyStatus.textContent = 'Error!'; // Простое сообщение об ошибке
                copyStatus.style.display = 'inline';
                 copyStatus.style.color = '#ef4444'; // Красный цвет
                 setTimeout(() => {
                     copyStatus.textContent = '';
                     copyStatus.style.display = 'none';
                     copyStatus.style.color = '#4ade80'; // Вернуть цвет по умолчанию
                 }, 2000);
            }
        }

        // --- Initialization ---
        /**
         * Инициализация калькулятора при загрузке DOM.
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Cache elements first
            setupEventListeners(); // This now includes caching in domElements object
                const appVersionDisplay = document.getElementById('appVersionDisplay');
                if (appVersionDisplay) {
                appVersionDisplay.textContent = `v${APP_VERSION}`;
                }
            currentLanguage = localStorage.getItem('fomoFarmCalc_language') || 'en';
            loadData(); // Load data into cached elements
            populateCurrencyDropdowns(); // Populate selects
            updateUI(currentLanguage); // Update text based on language
            clearResults(); // Clear results section
            renderReferralsTable(); // Render referrals table
            triggerConversion(); // Perform initial conversion
        });

    </script>
</body>
</html>
